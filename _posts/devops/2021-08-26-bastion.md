---
title: "Bastion 서버 구성"
excerpt: "Bastion 서버의 개념 및 구성 방법에 대해 알아보자."
categories:
  - DevOps
tags:
  - DevOps
date: 2021-08-26
last_modified_at: 2021-08-26
---

## 1. SSH(Secure Shell Protocol)

SSH란 네트워크 프로토콜 중 하나로 컴퓨터와 컴퓨터가 인터넷과 같은 Public Network를 통해 서로 통신을 할 때 보안적으로 안전하게 통신을 하기 위해 사용하는 프로토콜이다.

* Git을 통해 Github 원격 저장소로 코드 푸시할 때 사용한다.
* AWS의 인스턴스 서버에 접속하여 해당 머신에 명령을 내리기 위해서도 SSH를 통해 접속한다.

민감한 정보를 다른 프로토콜로 주고 받으면 노출될 공산이 크다. SSH는 훨씬 안전한 채널을 구성한 뒤 정보를 교환하기 때문에 보다 보안적인 면에서 훨씬 뛰어나다. 공개키 & 비밀키 방식을 사용한다. EC2 인스턴스를 제어하기 위해 22번 포트로 접근하는데, 보안이 뚫린다면 서비스에 심각한 문제를 야기한다.

22번 포트로 접근하는 모든 서버(Prod, Dev, Jenkins 등)에 동일 수준의 보안을 설정하려면 Trade-off가 발생한다.

* Auto-Scaling 등 확장성을 고려한 구성과 배치가 필요하다.
* 관리 포인트가 늘어나기에 일반적으로는 보안 설정을 일정 부분을 포기해야 한다.

<br>

## 2. Bastion Server

보안을 한곳에 집중시키기 위한 서버다. 22번 포트 접속을 Bastion 서버에 오픈하고 보안을 Bastion 서버에 집중시킨다.

* Bastion Server가 있다면, 악성 루트킷, 랜섬웨어 등으로 피해를 보더라도 Bastion Server만 재구성하면 된다.
  * 서비스에 끼치는 악영향을 최소화할 수 있다.
* 서비스 정상 트래픽과 관리자용 트래픽 구분이 가능해진다.
* 서비스가 DDos 공격을 받아 대역폭을 모두 차지하고 있다면 일반적인 방법으로 서비스용 서버에 접속하기는 어렵다.
  * 별도의 경로를 확보해둘 필요가 있다.

#### 장점

1. 새로 생성하는 EC2 서버마다 해당 Bastion 서버로 연결시키면, 모든 서버가 동일한 수준의 보안을 손쉽게 가질 수 있다.
2. 단일 로그인 포인트를 설정하고 관리하기 때문에 방화벽 설계를 단순화한다.
3. 네트워크 사용 관련 로그를 한 곳에서 관리한다.
4. 중소규모의 팀에서 매우 유용하게 사용할 수 있다.

### 2.1. 구성 방법

> Shell

```bash
## Bastion Server에서 공개키를 생성합니다.
bastion $ ssh-keygen -t rsa
bastion $ cat ~/.ssh/id_rsa.pub

## 접속하려는 서비스용 서버로 접속하여 Bastion Server의 공개키를 추가합니다.
$ vi ~/.ssh/authorized_keys

## Bastion Server에서 서비스용 서버로 접속을 해봅니다.
bastion $ ssh ubuntu@[서비스용 서버 IP]
```

* Bastion Server는 자신의 공인 IP에서만 22번 포트로 접근이 가능하도록 보안그룹을 설정한다.
* 서비스용 서버에 22번 포트로의 접근은 Bastion 서버에서만 가능하도록 보안그룹을 설정한다.

### 2.2. Shell Prompt 꾸미기

> Shell

```bash
$ sudo vi ~/.bashrc
  USER=BASTION
  PS1='[\e[1;31m$USER\e[0m][\e[1;32m\t\e[0m][\e[1;33m\u\e[0m@\e[1;36m\h\e[0m \w] \n\$ \[\033[00m\]'

$ source ~/.bashrc
```

* 서버마다 터미널이 IP 주소로만 구분되어 있어서 실제로 어떤 EC2의 터미널인지 구분하기 어렵다.
* 각 서버별로 USER 변수를 다르게 설정해두면 보기 편하다.

<br>

## 3. EC2 SSH 접속 포트 변경

> Shell

```bash
$ vi /etc/ssh/sshd_config

#해당 부분을
#Port 22

#다른 번호로 변경 및 활성화
Port 10000
```

> Shell

```bash
$ sudo service ssh restart //필수!
$ ssh -i {keyfile} -p 10000 ubuntu@{ec2-ip}
```

* 다른 포트 번호를 통해 특정 인스턴스 SSH로 접속할 수 있다.

<br>

## 4. PEM 키를 활용한 Bastion 서버 구성

우아한테크코스 AWS 계정의 경우 EC2 인스턴스의 보안 그룹을 마음대로 수정할 수 없다. 따라서 Bastion 서버를 띄우고, 다른 서비스 서버의 PEM 키를 Bastion 서버 내에 두고 Bastion에서 접속하도록 비슷하게 구성해본다. 물론 보안상 좋은 방법은 아니다.

* 서비스 EC2의 PEM Key 파일을 Bastion EC2 내부의 **`~/.ssh/`** 로 복사한다.

> Shell

```bash
$ ssh -i ~/.ssh/{pem key} ubuntu@{service-ec2-ip} //Bastion에서 서비스 EC2로 접속
```

* Bastion EC2 내부에서 위 명령어를 작성하면 서비스 EC2로 접속한다.

> Shell

```bash
bastion $ vi /etc/hosts
[서비스용IP]    [별칭]

bastion $ ssh -i ~/.ssh/{pem key} {별칭}
```

* 매번 IP를 외우기 귀찮으니 별칭을 설정할 수 있다.
* `/etc/hosts` 별칭을 사용하는 방법은 -i, -p 같은 옵션이 있는 경우 여전히 불편하다.

조금 더 커스터마이징을 해보자.

> Shell

```bash
$ vi ~/.ssh/config

Host {whatever you want}
HostName {service-ec2-ip}
User ubuntu
#Port {port} 필요하다면
IdentityFile ~/.ssh/{pem key}
```

* 이후 `ssh {host-value}` 만 입력하면 서비스 EC2로 접속된다.
* 위 방법의 장점은 Host-Value 이름의 자동 완성을 지원한다.

> Shell

```bash
vi ~/.ssh/config

Host abc.dev
HostName {ip}
User ubuntu
IdentityFile ~/.ssh/{pem key}

Host abc.prod
HostName {ip}
User ubuntu
IdentityFile ~/.ssh/{pem key}

Host abc.jenkins
HostName {ip}
User ubuntu
IdentityFile ~/.ssh/{pem key}
```

* `ssh`를 치고 탭을 누르면 현재 설정에 존재하는 모든 Host들의 목록이 보여진다.
* `ssh abc.`을 치고 탭을 누르면 `abc.` 로 시작하는 Host의 목록이 보여진다.

![image](https://user-images.githubusercontent.com/56240505/130921468-d1f7daf1-d2ce-423a-88f5-9da1e4e83588.png)

<br>

---

## References

* [SSH란?](https://baked-corn.tistory.com/52)
* [EC2 SSH 접속 포트 변경](https://jongwony.github.io/blog/posts/2016-08-13-aws-ssh/)
