---
title: "Flyway 설정 및 사용 예제"
excerpt: "Flyway를 통해 DB Schema 변경 이력을 추적한다."
categories:
  - DevOps
tags:
  - DevOps
date: 2021-08-31
last_modified_at: 2021-08-31
---

## 1. Flyway

DB 형상 관리 및 Migration을 위한 오픈소스 툴이다.

로컬에서 DB 스키마 및 데이터 등을 변경했을 때, 과거에는 개발 혹은 운영 DB 또한 수작업으로 수정해야 했다. 따라서 반영 누락 등 인적 사고가 빈번하게 발생한다. Git을 통해 자동으로 형상 관리가 되는 소스 코드처럼, Flyway는 코드를 통해 DB 변경 사항을 형상 관리한다. 일일이 DB에 직접 접속해서 수작업으로 DDL을 통해 스키마를 변경할 필요가 없어졌다.

대안으로 Liquibase 등이 있으며, 기능은 풍부하지만 Flyway에 비해 레퍼런스가 부족하다.

### 1.1. 동작 방식

Flyway가 연결된 DB는 ``SCHEMA_VERSION`` 테이블이 존재하는지 판단하고, 없으면 자동으로 생성한다. 해당 메타 데이터 테이블을 통해 Flyway가 변경 이력을 관리한다.

* Flyway는 Migration을 위해 개발자가 정의한 지정된 파일(SQL)을 지정된 classpath에서 탐색하여 버전 순서대로 실행한다.
* Migration이 실행되면 ``SCHEMA_VERSION`` 테이블에 실행 이력을 저장하게 된다.

### 1.2. 파일명 형식

Flyway는 Migration 대상 파일의 버전을 파일명을 통해서 구분한다.

* 파일명 형식은 ``{prefix}{version}{separator}{description}{suffix}``다.
  * prefix는 V 또는 R로 시작하며, 해당 접두사가 반드시 존재해야 Flyway가 인식한다.
  * version은 숫자와 점 및 언더바의 조합으로 나타낸다.
  * separtor는 항상 ``__``다.
  * desription은 ``SCHEMA_VERSION`` 테이블에 설명으로 저장된다.
  * suffix는 기본 ``.sql``이다.

예시는 다음과 같다.

* ``V1__init.sql``
* ``V1.1__add_age.sql``
* ``V2__create_like.sql``

### 1.3. 명령어

* init
  * ``SCHEMA_VERSION``을 baseline 과 함께 생성한다.
  * 테이블이 이미 생성되어 있으면 수행되지 않는다.
* migrate
* clean
* info
* validate
* repair
* baseline
  * Flyway로 형상 버전관리를 시작 할 baseline 을 설정한다.

<br>

## 2. 설정 및 사용 예제

> build.gradle

```groovy
implementation 'org.flywaydb:flyway-core:6.4.2'
```

> application.yml

```yml
spring:
  flyway:
    baseline-on-migrate: true
    enabled: true
  jpa:
    generate-ddl: true
    hibernate:
      ddl-auto: validate
    properties:
      jdbc:
        lob:
          non_contextual_creation: true #드라이버가 createClub을 지원하지 않아서 warning 뜨는 것을 방지
```

> V1__init.sql

```sql
create table user
(
    id            bigint       not null auto_increment,
    is_deleted    bit          not null,
    name          varchar(255) not null,
    profile_image varchar(255),
    primary key (id)
);

//중략
```

* Flyway를 등록하려는 시점의 DB 스키마를 입력한다.
  * Flyway는 해당 파일을 기준으로 DB 버전을 관리한다.
* JPA DDL 설정이 validate로 되어 있고, DB에는 아직 user 등 테이블이 존재하지 않는 상태다.

<img width="1013" alt="스크린샷 2021-09-01 오전 1 16 55" src="https://user-images.githubusercontent.com/56240505/131543093-465a35c0-d2b4-46cd-a8c8-999007a2aa4a.png">

* 웹 어플리케이션을 실행한 결과, DDL이 create가 아니더라도 Flyway가 자동으로 테이블을 생성한다.

> User.java

```java
@Entity
public class User {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(unique = true, nullable = false)
    private String name;

    private String profileImage;

    @Column(nullable = false)
    private Boolean isDeleted;

    private Long age;

    //...
}
```

* User 엔티티에 age라는 필드를 새로 추가하고 어플리케이션을 실행해본다.
* ddl이 validate 설정값으로 인해 어플리케이션이 종료된다.
  * 어플리케이션에 등록된 엔티티 스키마가 DB의 기존 스키마와 차이가 발생했기 때문이다.

> V2__add_age.sql

```sql
alter table user add column age bigint default 0;
```

* 스키마 변경이 발생했는데, 사람이 직접 운영 DB 등에 접속하여 DDL 쿼리를 실행시키는 대신 Flyway를 통해 코드로 변경 사항을 관리해본다.

<img width="1013" alt="스크린샷 2021-09-01 오전 1 21 18" src="https://user-images.githubusercontent.com/56240505/131544769-fbc7a117-bb5c-4c24-b5e0-565b2e05da05.png">

* 어플리케이션 실행 결과, 변경 이력이 잘 반영되었다.

<br>

## 3. 주의사항

![image](https://user-images.githubusercontent.com/56240505/131544929-cc359b42-47b7-4476-9f52-dee6ba7dda4a.png)

* 해당 파일들은 반드시 classpath 하위 ``db/migration`` 디렉토리에 위치해야 한다.

<br>

---

## References

* [나만 모르고 있던 - Flyway (DB 마이그레이션 Tool)](https://www.popit.kr/%EB%82%98%EB%A7%8C-%EB%AA%A8%EB%A5%B4%EA%B3%A0-%EC%9E%88%EB%8D%98-flyway-db-%EB%A7%88%EC%9D%B4%EA%B7%B8%EB%A0%88%EC%9D%B4%EC%85%98-tool/)
* [Flyway 개념 & 사용법](https://bkim.tistory.com/2)
* [Flyway 로 Java 에서 DB schema, seed 관리하기](https://blog.gangnamunni.com/post/introducing-flyway/)
