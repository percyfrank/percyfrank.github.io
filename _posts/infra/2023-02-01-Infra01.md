---
title:  "Github Actions CI/CD(1) - git submodule í¬í•¨ì‹œí‚¤í‚¤" 
excerpt: "Github Actionsë¡œ ì¸í”„ë¼ë¥¼ êµ¬ì¶•í•´ë³´ì."

categories:
  - Infra
tags:
  - [Infra, Springboot, Project]

date: 2023-02-02
last_modified_at: 2023-02-02

---

ì¼ë‹¨ ì‹œì‘ ì „ì—, ê²Œì‹œë¬¼ì„ ë˜‘ê°™ì´ ë”°ë¼í•´ë„ ì•ˆë˜ëŠ” ê²½ìš°ê°€ ìƒê¸¸ ìˆ˜ ìˆì„ ê²ƒì´ë‹¤. 

ì—¬ê¸°ì— ì ì€ ëª¨ë“  ë‚´ìš©ì´ 100% ë§ëŠ”ë‹¤ê³  í•  ìˆ˜ëŠ” ì—†ê¸°ì— í˜¹ì‹œë¼ë„ ì˜ëª»ëœ ë‚´ìš©ì´ ìˆë‹¤ë©´ ìˆ˜ì • ìš”ì²­ì„ í•˜ì‹œê¸¸ ë°”ë€ë‹¤.

ê°œë°œ í™˜ê²½ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

- Window 11
- Spring Boot 2.7.7
- java 11
- Ubuntu Server.22.04 LTS
- Intellij IDEA Ultimate

---

ê¸°ì¡´ í”„ë¡œì íŠ¸ì˜ ë°°í¬ë¥¼ Githubì—ì„œ Organizationì„ ìƒì„±í•´ì„œ ì½”ë“œê°€ Githubì— pushë  ë•Œ, ìë™ìœ¼ë¡œ GitLabì— ë¯¸ëŸ¬ë§ë˜ì„œ CI ë˜ê²Œë” í•˜ê³  CDëŠ” crontabì„ í†µí•´ ì§„í–‰í•˜ì˜€ë‹¤.

ê·¸ëŸ°ë° ì´ë ‡ê²Œ í•˜ë©´ ëª‡ ê°€ì§€ ë¬¸ì œì ì´ ìˆë‹¤.

ğŸš« ì²«ì§¸, application.ymlì— ë“¤ì–´ìˆëŠ” ì„¤ì • ì •ë³´ë“¤ì„ Xshellì„ ì¼œì„œ ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ì— `-e` ì˜µì…˜ì„ í†µí•´ ë‹¤ í¬í•¨ì‹œì¼œì„œ ì§„í–‰í•´ì•¼ í•˜ê³ , ìˆ˜ì •ì‚¬í•­ ë˜í•œ ë§ˆì°¬ê°€ì§€ ìˆœì„œë¥¼ ë”°ë¥¸ë‹¤. 

ë˜í•œ, Githubì´ë“  GitLabì´ë“  application.yml íŒŒì¼ì€ ì˜¬ë¦¬ì§€ ì•Šê±°ë‚˜ ê°€ì§œ ì •ë³´ë¥¼ ë„£ì–´ë†”ì•¼ í•œë‹¤.

ì „ì²´ì ìœ¼ë¡œ ë²ˆê±°ë¡­ë‹¤...

ğŸš« ë‘˜ì§¸, ê¸°ì¡´ì˜ crontabì€ ì½”ë“œì˜ ë³€í™”ê°€ ìˆì„ ë•Œë§Œ ì²´í¬í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼ ë³€í™”ê°€ ìˆë“  ì—†ë“  í•­ìƒ ë‚´ê°€ ì •í•´ë‘” ì‹œê°„ ê°„ê²©ë§Œí¼ ëŒì•„ê°€ê³  ìˆëŠ” ìƒí™©ì´ì—ˆê³  í•´ë‹¹ ì‘ì—…ì´ ìì›ì„ ë‚­ë¹„í•œë‹¤ëŠ” ëŠë‚Œì„ ì£¼ì—ˆë‹¤.

ğŸš« ì…‹ì§¸, Githubì— ì½”ë“œë¥¼ pushí•˜ê³ , êµ³ì´ GitLabì— ë¯¸ëŸ¬ë§í•´ì„œ CI/CDë¥¼ í•  ì´ìœ ê°€ ì—†ë‹¤ëŠ” ìƒê°ì„ í–ˆë‹¤. Githubë“  GitLabì´ë“  í•œ ìª½ì—ì„œ ëª¨ë“ ê±¸ ë‹¤ ì§„í–‰í•˜ë©´ ë” íš¨ìœ¨ì ì´ë¼ê³  ìƒê°í–ˆë‹¤.

GitLab ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ëŠ” ë¹„êµì  ì‰¬ì›Œì„œ ê°„ë‹¨íˆ ì‘ì„±í•  ì¤„ì€ ì•Œì•˜ì§€ë§Œ, Github Actions ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„±ì—ëŠ” ë‘ë ¤ì›€ì´ ìˆì—ˆë‹¤.

ë˜í•œ, Githubì—ì„œ Organizationì„ ìƒì„±í•´ì„œ ì§„í–‰í•˜ë˜ ì¤‘ì´ë¼ ì–´ì©” ìˆ˜ ì—†ì´ GitLabìœ¼ë¡œ ë¯¸ëŸ¬ë§ í•˜ëŠ” ì‘ì—…ì´ ì¶”ê°€ë˜ì—ˆëŠ”ë°, ì´ì°¸ì— ì—¬ëŸ¬ ë¬¸ì œì ë“¤ì„ í•´ê²°í•˜ê³ ì Github Actionsë¥¼ í†µí•´ ë°°í¬ë¥¼ ì§„í–‰í•´ ë³´ë„ë¡ í•˜ê² ë‹¤.

Github Actionsì—ì„œ CI/CDë¥¼ ì§„í–‰í•˜ë©´ ìœ„ì—ì„œ ë§í•œ ë…¸ì¶œë˜ë©´ ì•ˆ ë˜ëŠ” ì„¤ì • ì •ë³´ë“¤ì„ Git submoduleì„ ì ìš©í•´ì„œ ê´€ë¦¬í•˜ë„ë¡ í•´ë³´ê² ë‹¤.

ì´ ë„ì›€ì„ ì¤€ ë‚˜ì˜ ì˜ì›í•œ ì¹œêµ¬ Gilbertì—ê²Œ ë¬´í•œí•œ ì°¬ì‚¬ë¥¼ ë³´ë‚¸ë‹¤...

<br>


### 1. EC2 ìƒì„± ë° Docker, MySQL ì„¤ì¹˜
---

EC2ë¥¼ ìƒì„±í•˜ê³  ì„œë²„ì— Docker ë° MySQLì„ ì„¤ì¹˜í•˜ëŠ” ë°©ë²•ì€ ì•„ë˜ ë§í¬ë¥¼ í†µí•´ í™•ì¸í•˜ì.

[EC2 ìƒì„± ë° í”„ë¡œì íŠ¸ ì—°ê²°](https://percyfrank.github.io/infra/docker01/)

<br>

### 2. í”„ë¡œì íŠ¸ Repository ìƒì„± ë° Git submodule ì ìš©
---

ë‹¤ìŒê³¼ ê°™ì´, Organization ì•ˆì—ì„œ í”„ë¡œì íŠ¸ repoë¥¼ publicìœ¼ë¡œ ìƒì„±í•´ì„œ, í”„ë¡œì íŠ¸ì™€ ì—°ê²°ì‹œì¼œ ë³´ê² ë‹¤.

![image](https://user-images.githubusercontent.com/85394884/217037804-c6e8b944-1734-4a77-8db9-f5632fd3f5b8.png)

ë‚˜ì˜ ê²½ìš°, ë¡œì»¬ ë°”íƒ•í™”ë©´ì—ì„œ ë§ˆìš°ìŠ¤ ìš°í´ë¦­ìœ¼ë¡œ **`Git Bash Here`** í•´ì„œ ì›ê²© repoë¥¼ cloneí•´ ìƒì„±ëœ í´ë” ì•ˆì— í”„ë¡œì íŠ¸ë¥¼ ë„£ì–´ì£¼ì—ˆë‹¤.

í”„ë¡œì íŠ¸ë¥¼ Github repoì™€ ì—°ê²°í–ˆìœ¼ë©´ ì´ì œ Git submoduleì„ ì ìš©í•´ë³´ì.

ìš°ì„ , ë§ˆì°¬ê°€ì§€ë¡œ Organization ì•ˆì—ì„œ **private respository**ë¥¼ ìƒì„±í•´ì¤€ë‹¤.

ì´ private repoì—ëŠ” ë…¸ì¶œë˜ë©´ ì•ˆë˜ëŠ” application.ymlì— ë“¤ì–´ìˆëŠ” ì„¤ì • ì •ë³´ íŒŒì¼ë“¤ì´ ì‘ì„±ë  ì˜ˆì •ì´ë‹¤.

![image](https://user-images.githubusercontent.com/85394884/217038190-b7a1412c-3423-4370-bc54-a06d29257b66.png)

ë‹¤ìŒê³¼ ê°™ì´, `application-dev.yml`ì˜ íŒŒì¼ì— yml íŒŒì¼ì— ìˆëŠ” ë‚´ìš©ë“¤ì„ ì „ë¶€ ì‘ì„±í•œë‹¤. ì—¬ê¸°ì—” ì‹¤ì œ í™˜ê²½ë³€ìˆ˜ë“¤ì´ ë“¤ì–´ê°€ì•¼ í•œë‹¤. 

ì‘ì„±ì„ ë§ˆì¹˜ë©´, commit í•œë‹¤.

![image](https://user-images.githubusercontent.com/85394884/216428761-933e3c6d-f16b-4126-b70e-4708d6e10ad5.png)


ë‹¤ìŒìœ¼ë¡œ, í”„ë¡œì íŠ¸ ë©”ì¸ repoì—ì„œ ìœ„ì˜ submoduleë¡œ ì‚¬ìš©í•  repoë¥¼ ë“±ë¡í•´ì¤€ë‹¤.

`git submodule add ${submodule_repository_url}`

![image](https://user-images.githubusercontent.com/85394884/216429926-d5cf649f-46f4-4e0e-8834-047049b9549e.png)

submoduleì„ ë“±ë¡í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´, í”„ë¡œì íŠ¸ root ê²½ë¡œì— ì´ˆë¡ìƒ‰ ë°•ìŠ¤ì˜ íŒŒì¼ë“¤ì´ ìƒê¸´ë‹¤.

![image](https://user-images.githubusercontent.com/85394884/217039351-69de0841-3e63-43cf-82c9-bf24e4521741.png)

`.gitmodules` íŒŒì¼ì„ ê°„ë‹¨íˆ ì‚´í´ë³´ë©´, submodule repoì˜ ê²½ë¡œì™€ urlì„ ì•Œë ¤ì¤€ë‹¤.

```
[submodule "myacademy-config"]
	path = myacademy-config
	url = https://github.com/mutsa-team6/myacademy-config.git

```

ì´ì œ submoduleì„ ë“±ë¡í–ˆìœ¼ë‹ˆ ì‚¬ì§„ì˜ ë¹¨ê°„ìƒ‰ ë°•ìŠ¤ì¸ yml íŒŒì¼ë“¤ì„ ì§€ì›Œë„ ëœë‹¤.

ê·¸ë¦¬ê³  ë¡œì»¬ì—ì„œ ì„œë²„ë¥¼ runí•˜ë©´...? âŒ ë‹¤ìŒê³¼ ê°™ì€ errorê°€ ë°œìƒí•œë‹¤.âŒ

![image](https://user-images.githubusercontent.com/85394884/216431805-0c67fe7c-3dd3-45d2-91b0-55e485a464d3.png)

**í•´ë‹¹ ë¬¸ì œëŠ” í”„ë¡œì íŠ¸ì—ì„œ submoduleë¡œ ì§€ì •í•œ repoì˜ yml íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í•œë‹¤ëŠ” ëœ»ì´ë‹¤.**

ë¶„ëª… ë‚˜ëŠ”, submoduleì„ ë“±ë¡í•´ì„œ í”„ë¡œì íŠ¸ root ê²½ë¡œì— ì¡´ì¬í•˜ëŠ” ê²ƒì„ í™•ì¸í–ˆëŠ”ë° ì™œ ì•ˆë˜ëŠ” ê²ƒì¼ê¹Œ?

âœ… ê·¸ ì´ìœ ëŠ”, submoduleì´ ì¡´ì¬í•˜ëŠ” ê²ƒì²˜ëŸ¼ ë³´ì´ë‚˜ ì‹¤ì œë¡œëŠ” ì•„ë‹ˆê³ , ì¶”ê°€ì ìœ¼ë¡œ ë³µì‚¬ë¥¼ í•´ì¤˜ì•¼ í•œë‹¤. âœ…

`build.gradle`ì— ë‹¤ìŒê³¼ ê°™ì´ ë³µì‚¬í•˜ëŠ” ì½”ë“œë¥¼ ì‘ì„±í•œë‹¤.

ì½”ë“œë¥¼ ê°„ë‹¨íˆ ì‚´í´ë³´ë©´, gradleì´ copyPrivate taskë¥¼ ìˆ˜í–‰í•  ë•Œ from ê²½ë¡œì˜ repoì— ìˆëŠ” `application-dev.yml` íŒŒì¼ì„ ë©”ì¸ í”„ë¡œì íŠ¸ì˜ `src/main/resources` ê²½ë¡œë¡œ ë³µì‚¬í•˜ë¼ëŠ” ì˜ë¯¸ì´ë‹¤.

```groovy
task copyPrivate(type: Copy) {
	copy {
		from './myacademy-config'
		include "application-dev.yml"
		into 'src/main/resources'
	}
}
```

ë§ˆì§€ë§‰ìœ¼ë¡œ, ì‘ì„±í•œ `copyPrivate` taskë¥¼ ì‹¤í–‰ì‹œì¼œì£¼ë©´, ì‹¤ì œë¡œ ì¡´ì¬í•˜ê²Œ ë˜ê³ , pushí•´ì£¼ê³ , project runí•˜ë©´ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ëœë‹¤.

![image](https://user-images.githubusercontent.com/85394884/216500808-fe16604d-3512-4e18-8be9-3a9ada3645c9.png)

![image](https://user-images.githubusercontent.com/85394884/216435064-fecc121c-9285-40a8-92de-589451baa99b.png)

ë§Œì•½, submodule repoë¥¼ ë³€ê²½í•˜ê²Œ ëœë‹¤ë©´ [submodule ë³€ê²½ ì‚¬í•­ ë©”ì¸ í”„ë¡œì íŠ¸ ë°˜ì˜](https://percyfrank.github.io/infra/Infra02/) ì„ ì°¸ê³ í•˜ë„ë¡ í•˜ì. 

<br>

### 3. Docker Hub & docker compose
---

4ë²ˆ ê³¼ì •ì—ì„œ docker imageë¥¼ ìƒì„±í•˜ê¸° ì•ì„œ, imageë¥¼ ì €ì¥í•  ì €ì¥ì†Œ ê°œë…ì˜ Docker Hubì— ê°€ì…í•´ì¤€ë‹¤.

ë‹¤ìŒìœ¼ë¡œ, docker compose ì„¤ì¹˜ë¥¼ í•´ì•¼í•œë‹¤.

ì„¤ì¹˜ ëª…ë ¹ì–´ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

í˜„ì¬ ê¸°ì¤€ ë„ì»¤ ì»´í¬íŠ¸ v2ë¥¼ ì„¤ì¹˜í•˜ë ¤ê³  í•œë‹¤.

```shell
sudo curl -sSL "https://github.com/docker/compose/releases/download/v2.15.1/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
```
[[ë¦¬ëˆ…ìŠ¤] ë„ì»¤ ì»´í¬ì¦ˆ ì„¤ì¹˜(docker-compose install)](https://sangchul.kr/636)

[curl: (92) HTTP/2 stream 0 was not closed cleanly: PROTOCOL_ERROR (err 1)](https://www.google.com/search?q=curl%3A+(92)+HTTP%2F2+stream+0+was+not+closed+cleanly%3A+PROTOCOL_ERROR+(err+1)&oq=curl%3A+(92)+HTTP%2F2+stream+0+was+not+closed+cleanly%3A+PROTOCOL_ERROR+(err+1)&aqs=chrome..69i57j69i58.513j0j7&sourceid=chrome&ie=UTF-8)

[ë„ì»¤ ì»´í¬ì¦ˆ ìµœì‹  ë²„ì „ í™•ì¸](https://github.com/docker/compose/releases)

ì„¤ì¹˜ í›„ì—, `chmod +x` ëª…ë ¹ì–´ë¥¼ í†µí•´ docker compose ì‹¤í–‰ ê¶Œí•œì„ ì£¼ë„ë¡ í•œë‹¤. ì—¬ê¸°ì„œ `+x`ëŠ” executable, ì¦‰ ì‹¤í–‰ ì´ë¼ëŠ” ëœ»ì´ë‹¤.

```shell
chmod +x /usr/local/bin/docker-compose
```

docker-compose ëª…ë ¹ì´ ì œëŒ€ë¡œ ë¨¹íˆëŠ”ì§€ í™•ì¸í•´ì¤€ë‹¤.

```shell
docker-compose -v
```

![image](https://user-images.githubusercontent.com/85394884/216515031-60708fec-da23-4926-b346-906f95d3cc80.png)

ğŸš¨ ì—¬ê¸°ì„œ ëì´ ì•„ë‹ˆë‹¤. ğŸš¨

docker composeëŠ” ì—¬ëŸ¬ ì»¨í…Œì´ë„ˆë¥¼ ê°€ì§€ëŠ” ì• í”Œë¦¬ì¼€ì´ì…˜ì„ í†µí•©ì ìœ¼ë¡œ Docker ì´ë¯¸ì§€ë¥¼ ë§Œë“¤ê³ , ë§Œë“¤ì–´ì§„ ê°ê°ì˜ ì»¨í…Œì´ë„ˆë¥¼ ì‹œì‘ ë° ì¤‘ì§€í•˜ëŠ” ë“±ì˜ ì‘ì—…ì„ ë” ì‰½ê²Œ ìˆ˜í–‰í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” ë„êµ¬ì´ë‹¤. 

ì¦‰, docker composeëŠ” ì»¨í…Œì´ë„ˆë¡œ ì˜¬ë¦´ imageë“¤ì„ docker hubë¡œë¶€í„° pull ë°›ì•„ì„œ í•œêº¼ë²ˆì— ì˜¬ë ¤ì£¼ëŠ” ì‘ì—…ì„ í•œë‹¤.

EC2 ì¸ìŠ¤í„´ìŠ¤ ë‚´ì—ì„œ í•´ë‹¹ ì‘ì—…ì´ ì´ë£¨ì–´ì§€ê¸° ë•Œë¬¸ì— docker compose íŒŒì¼ë„ EC2 ì¸ìŠ¤í„´ìŠ¤ ë‚´ì— ë§Œë“¤ì–´ì£¼ë©´ ëœë‹¤.

Xshellì„ ì—´ê³ , EC2 ì„œë²„ì— ì ‘ì†í•œ ë’¤, `sudo su -` ì˜ ê´€ë¦¬ì ê¶Œí•œìœ¼ë¡œ ë“¤ì–´ê°„ë‹¤.

ë‹¤ìŒìœ¼ë¡œ, `/home/ubuntu` ê²½ë¡œì— `compose`ê²½ë¡œë¥¼ ë§Œë“¤ê³ , ê·¸ ì•ˆì— `docker-compose.yml` íŒŒì¼ì„ ë§Œë“¤ì–´ì¤€ë‹¤.

```shell
mkdir compose
vim docker-compose.yml
```

íŒŒì¼ ë‚´ìš©ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

```shell
version: '3'
services:
  web:
    container_name: myacademy
    image: percyfrank/myacademy
    ports:
      - '8080:8080'
```

`container_name`ì€ ë‚´ê°€ ì´ë¦„ì„ ì§€ì •í•˜ë©´ ë˜ê³ , `image`ì˜ ê²½ìš° **{docker hub ID}/{imageë¥¼ ë‹´ì„ docker hub repo ì´ë¦„}** ì„ ì‘ì„±í•˜ë©´ ëœë‹¤. 

ë‚˜ì˜ ê²½ìš° idëŠ” percyfrank, image ì €ì¥ì†Œ repo ì´ë¦„ì€ `container_name`ê³¼ ê°™ì€ myacademyë¡œ í–ˆë‹¤.


![image](https://user-images.githubusercontent.com/85394884/217040243-39206e47-b7b2-4f66-a3c8-da2e7fc0ddc6.png)

ì œì¼ ì¤‘ìš”í•œ `port`ì†ì„±ì€ í˜¸ìŠ¤íŠ¸ê°€ ì ‘ê·¼í•  ìˆ˜ ìˆëŠ” í¬íŠ¸ì¸ `8080:8080` ìœ¼ë¡œ ì‘ì„±í•´ì¤€ë‹¤.

**ì¶”í›„ì— Nginxë¥¼ ì‚¬ìš©í•˜ê²Œ ë˜ë©´ Nginxë¥¼ ê±°ì³ ì˜¤ê¸° ë•Œë¬¸ì— `port` ì†ì„±ì´ ì¡°ê¸ˆ ë°”ë€” ìˆ˜ë„ ìˆë‹¤.**

í˜„ì¬ëŠ” Nginxë¥¼ ì ìš©í•˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ ì´ëŒ€ë¡œ ì‘ì„±ì„ ë§ˆë¬´ë¦¬í•œë‹¤.

`esc` í›„, `Shift+zz` ë¥¼ ëˆŒëŸ¬ ì €ì¥í•œë‹¤.

<br>

### 4. DockerFile ì‘ì„± ë° Docker image ìƒì„±
---

ë‹¤ìŒìœ¼ë¡œ, Github Actionsì—ì„œ CI/CD í•˜ê¸° ìœ„í•´ Docker image ìƒì„±ì„ ìœ„í•œ DockerFile ì‘ì„±ì„ í•´ë³´ê² ë‹¤.

ìŠ¤í¬ë¦½íŠ¸ëŠ” ë‹¤ìŒê³¼ ê°™ë‹¤.

ì„¤ì • íŒŒì¼ì„ ë¶„ë¦¬í•´ì„œ ì‚¬ìš©í•  ë• `-Dspring.profiles.active` ì†ì„±ì— ì›í•˜ëŠ” ì„¤ì • íŒŒì¼ì„ ì§€ì •í•´ì£¼ë©´ ëœë‹¤. ë‚˜ì˜ ê²½ìš°ëŠ” `dev`.

```docker
FROM openjdk:11
ARG JAR_FILE=build/libs/*.jar
COPY ${JAR_FILE} app.jar
ENTRYPOINT ["java", "-Dspring.profiles.active=dev", "-jar", "/app.jar"]
```

ìŠ¤í¬ë¦½íŠ¸ì— ëŒ€í•œ ì´í•´ê°€ í•„ìš”í•˜ë©´ [baeldung - spring boot docker start with profile](https://www.baeldung.com/spring-boot-docker-start-with-profile)ì„ ì°¸ê³ í•˜ì.

<br>

### 5. Github Actions CI/CD ìŠ¤í¬ë¦½íŠ¸
---

í”„ë¡œì íŠ¸ root ê²½ë¡œì— `./github/workflows` ë””ë ‰í† ë¦¬ë¥¼ ë§Œë“¤ê³  `cicd.yml` íŒŒì¼ì„ ìƒì„±í•œë‹¤.

![image](https://user-images.githubusercontent.com/85394884/217040631-207eb928-4938-414b-85c2-4f1991100cc8.png)

ì—¬ê¸°ì„œë¶€í„´, ìŠ¤í¬ë¦½íŠ¸ì˜ ë‚´ìš©ì„ ìˆœì„œëŒ€ë¡œ ê°„ëµíˆ ì„¤ëª…í•˜ê² ë‹¤.

#### 5-1. `on`

main ë¸Œëœì¹˜ì— `push` ê°€ ì¼ì–´ë‚˜ë©´ í•´ë‹¹ eventê°€ ì‹¤í–‰ëœë‹¤.

```yml
# github repository Actions í˜ì´ì§€ì— ë‚˜íƒ€ë‚¼ ì´ë¦„
name: CI/CD

# event trigger
on:
  push:
    branches: [main]
```

`pull request` ê°€ ì¼ì–´ë‚˜ë„ eventê°€ ì‹¤í–‰ë˜ê²Œë” í•˜ê³  ì‹¶ë‹¤ë©´, ë‹¤ìŒê³¼ ê°™ì´ ì¶”ê°€í•˜ë©´ ëœë‹¤.

```yml  
  pull_request:
    branches : [main]
```

#### 5-2. `jobs`

Github Actionsì˜ workflowëŠ” ë‹¤ì–‘í•œ jobìœ¼ë¡œ êµ¬ì„±ë˜ë©° jobì€ stepsë¡œ êµ¬ì„±ì´ ëœë‹¤.

jobì—ì„  ìˆ˜í–‰í•  ì‘ì—…ì„ ì‘ì„±í•˜ë©´ ëœë‹¤.

`token`ì€ repoë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‚¬ìš©ë  ì•¡ì„¸ìŠ¤ í† í°ì´ê³ , `submodules: true` ì˜µì…˜ì€ í•˜ìœ„ ëª¨ë“ˆì„ ì²´í¬í•˜ê² ë‹¤ëŠ” ì˜ë¯¸ì´ë‹¤.

[checkout ê³µì‹ë¬¸ì„œ](https://github.com/marketplace/actions/checkout)

```yml
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.CHECKOUT_TOKEN }}
          submodules: true
```
<br>

ë‹¤ìŒìœ¼ë¡œ, Github Actionsì—ì„œ ì‚¬ìš©ë  JDKë¥¼ ì„¸íŒ…í•˜ëŠ” ë¶€ë¶„ì´ë‹¤.

JDK 11ì„ ì‚¬ìš©í•˜ê³ , distributionìœ¼ë¡œ `temurin`ì„ ì‚¬ìš©í•œë‹¤.

[Gradle Wrapper Validation ê³µì‹ ë¬¸ì„œ](https://github.com/marketplace/actions/gradle-wrapper-validation)
[Setup Java ê³µì‹ë¬¸ì„œ](https://github.com/marketplace/actions/setup-java)

```yml
- name: Validate Gradle Wrapper
  uses: gradle/wrapper-validation-action@v1
- name: Set up JDK11
  uses: actions/setup-java@v3
  with:
    distribution: 'temurin'
    java-version: '11'
    cache: 'gradle'
```

<br>

gradlewì— ì‹¤í–‰ê¶Œí•œì„ ë¶€ì—¬í•˜ê³ , gradle buildë¥¼ ì§„í–‰í•˜ëŠ” ì‘ì—…ì´ë‹¤.

```yml
- name: Grant execute permission for gradlew
  run: chmod +x gradlew
- name: Execute Gradle build
  run: ./gradlew clean build -x test -Pprofile=dev
```

<br>

Dockerë¥¼ ì„¸íŒ…í•˜ê³ , ë¡œê·¸ì¸í•˜ëŠ” ë¶€ë¶„ì´ë‹¤.

[Docker Setup Buildx ê³µì‹ë¬¸ì„œ](https://github.com/marketplace/actions/docker-setup-buildx)
[Docker Login ê³µì‹ë¬¸ì„œ](https://github.com/marketplace/actions/docker-login)

```yml
- name: Set up Docker Buildx
  uses: docker/setup-buildx-action@v2
- name: Docker Login
  uses: docker/login-action@v2
  with:
    username: ${{secrets.DOCKER_USER}}
    password: ${{secrets.DOCKER_PASSWORD}}
```

<br>

docker imageë¥¼ ìƒì„±í•˜ê³  docker hubì— pushí•˜ëŠ” ì‘ì—…ì´ë‹¤.

`APP` ìœ„ì¹˜ì—ëŠ” docker-compose íŒŒì¼ì— ì‘ì„±í•œ ì´ë¦„ì„ ë„£ìœ¼ë©´ ëœë‹¤. 

ë‚˜ì˜ ê²½ìš° `image: percyfrank/myacademy` ì˜€ê¸° ë•Œë¬¸ì— `myacademy` ë¥¼ ë„£ì–´ì£¼ì—ˆë‹¤.

```yml
- name: build and release to DockerHub
  env:
    NAME: ${{secrets.DOCKER_USER}}
    APP: myacademy
  run: |
    docker build -t $NAME/$APP -f ./DockerFile .
    docker push $NAME/$APP:latest
```

<br>

ë§ˆì§€ë§‰ìœ¼ë¡œ docker-composeë¥¼ í†µí•´ EC2 ì¸ìŠ¤í„´ìŠ¤ì— APP ì»¨í…Œì´ë„ˆë¥¼ ì˜¬ë¦¬ëŠ” ì‘ì—…ì´ë‹¤.

[SSH Remote Commands ê³µì‹ë¬¸ì„œ](https://github.com/marketplace/actions/ssh-remote-commands)

```yml
- name: EC2 Docker Run
  uses: appleboy/ssh-action@master
  env:
    APP: "myacademy"
    COMPOSE: "/home/ubuntu/compose/docker-compose.yml"
  with:
    username: ubuntu
    host: ${{secrets.EC2_HOST}}
    key: ${{secrets.EC2_KEY}}
    envs: APP, COMPOSE
    script_stop: true
    script: |
      sudo docker-compose -f $COMPOSE down --rmi all
      sudo docker pull ${{secrets.DOCKER_USER}}/$APP:latest
      sudo docker-compose -f $COMPOSE up -d
```

<br>

âœ… ì¶”ê°€ì ìœ¼ë¡œ, gradle build ì‹œ springboot 2.5 ë²„ì „ ì´í›„ë¡œëŠ” jar íŒŒì¼ì´ 2ê°œê°€ ìƒê²¨ Github Actions ì‘ì—…ì´ ì œëŒ€ë¡œ ì‘ë™í•˜ì§€ ì•ŠëŠ”ë‹¤.

í•´ê²°ë°©ë²•ì€ `build.gradle` ì— ë‹¤ìŒê³¼ ê°™ì´ ì¶”ê°€í•˜ë©´ ëœë‹¤.
```groovy
jar {
  enabled = false
}
```
<br>

âœ… jobs ì¤‘ê°„ì¤‘ê°„ì— ë³´ë©´ ìŠ¤í¬ë¦½íŠ¸ì— ì‘ì„±í•  í™˜ê²½ ë³€ìˆ˜ë“¤ì„ `$` ì²˜ë¦¬í•´ì„œ ì‘ì„±í–ˆë‹¤.

í•´ë‹¹ ë³€ìˆ˜ë“¤ì„ ì‹¤ì œ ë³´ê´€í•´ë‘˜ ê³³ì€ Main í”„ë¡œì íŠ¸ `Settings` - `Secrets and variables` - `Actions` - `New repository secret`ì—ì„œ ì§„í–‰í•˜ë©´ ëœë‹¤.

ì£¼ì˜í• ì ì€ í•œ ë²ˆ ì‘ì„±í•´ì„œ ë„£ê³  ìˆ˜ì •í•˜ê¸° ìœ„í•´ ëˆ„ë¥´ë©´ ì´ì „ì— ì‘ì„±í–ˆë˜ ê°’ë“¤ì´ ì „í˜€ ë³´ì´ì§€ ì•Šê²Œ ëœë‹¤. ì¦‰, íŠ¹ì • ë¶€ë¶„ë§Œ ë“œë˜ê·¸í•´ì„œ ë°”ê¿€ ìˆ˜ ì—†ìœ¼ë‹ˆ, í†µì¨°ë¡œ ì…ë ¥í•˜ê±°ë‚˜ ì•„ë‹ˆë©´ ì‚­ì œí•˜ê³  ë‹¤ì‹œ ë§Œë“¤ë©´ ë  ê²ƒ ê°™ë‹¤.

![image](https://user-images.githubusercontent.com/85394884/216548415-f1095b02-77ce-4cad-87a1-a88f2cbce213.png)

- CHECKOUT_TOKEN : ì•¡ì„¸ìŠ¤ í† í°
- DOCKER_USER : Docker Hub ID
- DOCKER_PASSWORD : Docker Hub Password
- EC2_HOST : í¼ë¸”ë¦­ IPv4 DNS ì£¼ì†Œ
- EC2_KEY : EC2 pem íŒŒì¼ì— ìˆëŠ” ë‚´ìš© ì „ë¶€

ì½”ë“œë¥¼ push í›„, Github Actions ì‘ì—…ì´ ì„±ê³µí•˜ë©´ `docker ps -a`ë¡œ ì»¨í…Œì´ë„ˆê°€ ì˜¬ë¼ê°”ëŠ”ì§€ í™•ì¸í•œë‹¤.

![image](https://user-images.githubusercontent.com/85394884/217043443-3e681257-7004-40fa-a6f3-82d2ce7f8cee.png)

<br>

## References

* [Trade Market - ì¸í”„ë¼ êµ¬ì¶•](https://gilbert9172.github.io/project/2022/12/29/Project-CICD/)
* [Ubuntu 20.04 ì— Docker, Docker-Compose ì„¤ì¹˜í•˜ëŠ” ë²•](https://velog.io/@dailylifecoding/ubuntu-20.04-docker-and-dockercompose-install)
* [Spring Boot Dockerë¡œ ë°°í¬í•˜ê¸°](https://velog.io/@azqazq195/Spring-Boot-Docker%EB%A1%9C-%EB%B0%B0%ED%8F%AC%ED%95%98%EA%B8%B0)
* [ë¹Œë“œ ì‹œ 2ê°€ì§€ jarê°€ ìƒì„±ë˜ëŠ” í˜„ìƒ](https://earth-95.tistory.com/132)