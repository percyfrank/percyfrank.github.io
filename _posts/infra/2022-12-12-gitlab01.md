---
title:  "GITLAB - CI/CD ê³¼ì •" 
excerpt: "CI/CDë¥¼ ìœ„í•œ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì§œë³´ì"

categories:
  - Infra
tags:
  - [Infra, Springboot, Project]

date: 2022-12-12
last_modified_at: 2022-12-12
---


### CI/CDì˜ ëª©ì 

ì•„ë˜ì˜ ì‘ì—…ì„ GITLABì— pushí•˜ë©´ ë³€ê²½ëœ ë‚´ìš©ì´ ë¹Œë“œê¹Œì§€ ë°˜ì˜ë˜ê²Œ í•˜ëŠ” ê²ƒ, ì¦‰, ë¹Œë“œì™€ í…ŒìŠ¤íŠ¸ ê·¸ë¦¬ê³  ë°°í¬ê¹Œì§€ ìë™í™”í•´ì£¼ëŠ” ê²ƒì´ CI/CDì˜ ëª©ì ì´ë‹¤.

```bash
sudo su -
cd ë°°í¬í•˜ê³  ì‹¶ì€ í”„ë¡œì íŠ¸ ë“¤ì–´ê°€ê¸°
git pull
docker build -t ì´ë¦„ . 
docker images
docker stop ê¸°ì¡´ container_id
docker run <project ì´ë¦„> <new version>
```

![Untitled](https://user-images.githubusercontent.com/85394884/207674942-dd2726ce-a525-4be0-831c-a09030bfd2d5.png)

![Untitled (1)](https://user-images.githubusercontent.com/85394884/207674951-e676338d-7dcd-4430-9b04-f59ebe9f2093.png)

- ë¬¸ì œëŠ” Build Server(ex. gitlab-runner)ì™€ ì‹¤ì œ ë°°í¬ë˜ëŠ” ì„œë²„(ex. aws ec2)ëŠ” ë‹¤ë¥¼ ìˆ˜ ìˆë‹¤.
- ì´ë¥¼ ìœ„í•´, Container Registryë¥¼ í†µí•´ Docker Imageë¥¼ ì €ì¥í•  ìˆ˜ ìˆë‹¤.

<br>

ğŸ—¨ï¸ ì„ í–‰í•´ì•¼ë  ì‘ì—… : Dockerfileì´ í”„ë¡œì íŠ¸ì— ìˆì–´ì•¼í•œë‹¤.

**`Dockerfile`** 

```bash
FROM gradle:7.4-jdk11-alpine as builder
WORKDIR /build

# ê·¸ë˜ë“¤ íŒŒì¼ì´ ë³€ê²½ë˜ì—ˆì„ ë•Œë§Œ ìƒˆë¡­ê²Œ ì˜ì¡´íŒ¨í‚¤ì§€ ë‹¤ìš´ë¡œë“œ ë°›ê²Œí•¨.
COPY build.gradle settings.gradle /build/
RUN gradle build -x test --parallel --continue > /dev/null 2>&1 || true

# ë¹Œë” ì´ë¯¸ì§€ì—ì„œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
COPY . /build
RUN gradle build -x test --parallel

# APP
FROM openjdk:11.0-slim
WORKDIR /app

# ë¹Œë” ì´ë¯¸ì§€ì—ì„œ jar íŒŒì¼ë§Œ ë³µì‚¬
COPY --from=builder /build/build/libs/*-SNAPSHOT.jar ./app.jar

EXPOSE 8080

# root ëŒ€ì‹  nobody ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰
USER nobody
ENTRYPOINT [                                                \
    "java",                                                 \
    "-jar",                                                 \
    "-Djava.security.egd=file:/dev/./urandom",              \
    "-Dsun.net.inetaddr.ttl=0",                             \
    "app.jar"              \
]
```

![Untitled](https://user-images.githubusercontent.com/85394884/207230618-45a4ce0a-cfdb-4b43-893f-2b7d9a9265a7.png)

<br>

ğŸ—¨ï¸ ë³€ìˆ˜ì¶”ê°€  settings - cicd - variables(expand) -  add variable

![Untitled 1](https://user-images.githubusercontent.com/85394884/207230600-75e1c3cb-9759-475c-bf8b-413d6d34a90a.png)

<br>

- Docker buildì—ì„œ `gradle ë¹Œë“œ`ë¥¼ í–ˆì„ ê²½ìš°

  **`.gitlab-ci.yml` -** docker buildë¥¼ gitlab-runner(ë¦¬ëˆ…ìŠ¤ ì„œë²„) ê°€ ëŒ€ì‹ í•´ì¤€ë‹¤.

  ```yaml
  # stage â†’ ë‹¨ê³„

  stages:
    - dockerbuild-push

  package:
    image: docker:latest
    stage: dockerbuild-push
    services:
      - docker:dind
    before_script:
      - docker login registry.gitlab.com -u $GITLAB_USER -p $GITLAB_PASSWORD
    script:
      - docker build -t registry.gitlab.com/$GITLAB_USER/$PROJECT_NAME . 
      - docker push registry.gitlab.com/$GITLAB_USER/$PROJECT_NAME
    after_script:
      - docker logout
  ```

  <br>

- Docker build ì—ì„œ `gradle buildë¥¼ í•˜ì§€ ì•ŠëŠ”` ê²½ìš°

  **`.gitlab-ci.yml`**

  ```yml
  stages:
    - build
    - dockerbuild-push

  build:
    image: openjdk:11.0-slim
    stage: build
    script:
      - ./gradlew clean
      - ./gradlew build -x test
    before_script:
      - chmod +x gradlew
    artifacts:
      paths:
        - build/libs/*.jar
      expire_in: 8 min

  package:
    image: docker:latest
    stage: dockerbuild-push
    services:
      - docker:dind
    before_script:
      - docker login registry.gitlab.com -u $GITLAB_USER -p $GITLAB_PW
    script:
      - docker build -t registry.gitlab.com/$GITLAB_USER/<project-name> .
      - docker push registry.gitlab.com/$GITLAB_USER/<project-name>
    after_script:
      - docker logout
  ```

<br>

- ì‹¤í–‰ê³¼ì •
  
    ![Untitled 2](https://user-images.githubusercontent.com/85394884/207230604-53ea5db1-395b-4c92-9119-67c99bbc6fc1.png)
    
    ë¦¬ëˆ…ìŠ¤ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
    
    ![Untitled 3](https://user-images.githubusercontent.com/85394884/207230607-af9f8b56-5873-4333-b077-f6d3f43bebab.png)
    
    ![Untitled 4](https://user-images.githubusercontent.com/85394884/207230609-fee59a36-bcc6-4f44-9d47-0bfaed553c82.png)

<br>

- ê²°ê³¼
  
`CI/CD > Jobs`

![Untitled 5](https://user-images.githubusercontent.com/85394884/207230611-4c5c7a41-eaca-45bd-9910-375428568ed4.png)

`ë°°í¬ í™•ì¸ ë©”ì¼`

![Untitled 6](https://user-images.githubusercontent.com/85394884/207230613-48992d43-d0a9-4c0f-a77f-f546e843af98.png)

