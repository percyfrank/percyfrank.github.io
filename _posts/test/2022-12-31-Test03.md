---
title:  "Controller Testì‹œ Security í¬í•¨ ë°©ë²•" 
excerpt: "ì»¨íŠ¸ë¡¤ëŸ¬ í…ŒìŠ¤íŠ¸ì˜ ë²”ìœ„ë¥¼ ì–´ë””ê¹Œì§€ í•  ê²ƒì¸ê°€"

categories:
  - Test
tags:
  - Test

date: 2022-12-31
last_modified_at: 2022-12-31

---

ë‚´ê°€ í˜„ì¬ê¹Œì§€ ì •ì˜ ë‚´ë¦° Controller í…ŒìŠ¤íŠ¸ëŠ” **ìš”ì²­ì— ëŒ€í•œ ì‘ë‹µì´ ì œëŒ€ë¡œ ë°˜í™˜**ë˜ëŠ”ê°€ë¥¼ í…ŒìŠ¤íŠ¸í•˜ëŠ” ê²ƒì´ë‹¤.

ì¡°ê¸ˆ ë” êµ¬ì²´ì ìœ¼ë¡œ ë§í•˜ë©´, `@WebMvcTest` ì–´ë…¸í…Œì´ì…˜ì„ í†µí•´ ì‘ë‹µê³¼ ìš”ì²­ì— í•„ìš”í•œ Beanë“¤ë§Œ ë¡œë”©í•˜ì—¬ ê°€ë³ê²Œ í…ŒìŠ¤íŠ¸í•˜ëŠ” ê²ƒì„ ë§í•œë‹¤.

ê·¸ëŸ°ë°, Controller í…ŒìŠ¤íŠ¸ë¥¼ ì‘ì„±í•˜ë©´ì„œ `Security` ê°€ í¬í•¨ë˜ë©´ ì–´ë–»ê²Œ ì²˜ë¦¬í•´ì•¼ í•˜ëŠ”ê°€?'ì— ëŒ€í•œ ê³ ë¯¼ì´ ìƒê²¼ë‹¤.

ë°©ë²•ì„ í¬ê²Œ 3ê°€ì§€ ì •ë„ë¡œ ì••ì¶•í•´ë´¤ë‹¤.

í¬ê²Œ, Securityë¥¼ ì•„ì˜ˆ **ì œì™¸**í•˜ëŠ” ë°©ë²•ê³¼ **í¬í•¨**ì‹œì¼œì„œ ì§„í–‰í•˜ëŠ” ë°©ë²•ì´ ìˆê³ , Securityë¥¼ í¬í•¨ì‹œí‚¤ëŠ” ë°©ë²•ì—ì„œ ë˜ **2ê°€ì§€**ë¡œ ë‚˜ëˆŒ ìˆ˜ ìˆì—ˆë‹¤.

ì²˜ìŒì—”, `@WithMockUser`, `@WithAnonymousUser` ì–´ë…¸í…Œì´ì…˜ì„ ì´ìš©í•´ì„œ ê¸°ë³¸ Security ì„¤ì •ê°’ì„ í¬í•¨ì‹œí‚¤ë©´ ë˜ëŠ” ê²ƒì´ ì•„ë‹Œê°€ë¼ëŠ” ìƒê°ì„ í–ˆë‹¤.

ê·¸ëŸ°ë°, ì•„ë˜ì—ì„œ ì„¤ëª…í•˜ê² ì§€ë§Œ ì¸ì¦ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•  ë•Œ, ì–´ë…¸í…Œì´ì…˜ì„ ì“°ê²Œ ë˜ë©´ ì–´ë…¸í…Œì´ì…˜ ê¸°ëŠ¥ìœ¼ë¡œ ì¸í•´ ì¸ì¦ì— ëŒ€í•œ ì¡°ê±´ì„ ì´ìƒí•˜ê²Œ ë„£ê±°ë‚˜ ë„£ì§€ ì•Šì•„ë„ í…ŒìŠ¤íŠ¸ê°€ í†µê³¼ë˜ëŠ” ê²ƒì„ ë°œê²¬í–ˆë‹¤.

ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´, **ì»¤ìŠ¤í…€ ì–´ë…¸í…Œì´ì…˜**ì„ ì‚¬ìš©í•´ì„œ ì§ì ‘ ì¸ì¦ì— ëŒ€í•œ ì¡°ê±´ì„ ì„¤ì •í•´ì£¼ëŠ” ë“±ì˜ ë°©ë²•ì„ ì‹œë„í–ˆìœ¼ë‚˜ ê·¼ë³¸ì ìœ¼ë¡œ ì¸ì¦ì— ëŒ€í•œ ì¡°ê±´ì´ ì–´ë–»ë“  ê°„ì— ì¸ì¦ì„ í†µê³¼ì‹œí‚¤ëŠ” ê¸°ëŠ¥ì„ í•˜ê¸°ì— í•´ê²°í•  ìˆ˜ ì—†ì—ˆë‹¤.

ì´ì™€ ê´€ë ¨í•˜ì—¬ ë˜, Securityë¥¼ í¬í•¨ì‹œí‚¤ëŠ” ìˆœê°„, ë‚´ê°€ ì‘ì„±í•œ Security ì„¤ì •ë“¤ì´ í…ŒìŠ¤íŠ¸ì— ì „í˜€ ë°˜ì˜ë˜ì§€ ì•Šì•˜ë‹¤. 

ì´ê²Œ ë¬´ìŠ¨ ëœ»ì´ë‚˜ë©´, ë‚˜ì˜ ê²½ìš° jwt í† í°ì´ ë¶€ì ì ˆí•˜ê²Œ ë“¤ì–´ì˜¬ ë•Œì˜ ì—ëŸ¬ì²˜ë¦¬ í•„í„°ì™€ jwt í† í°ì´ ì•„ì˜ˆ ë“¤ì–´ì˜¤ì§€ ì•Šì•˜ì„ ê²½ìš°ì˜ ì—ëŸ¬ì²˜ë¦¬ë„ í•´ì£¼ì—ˆëŠ”ë°, ê·¸ëŸ° ë¶€ë¶„ë“¤ì´ ì œëŒ€ë¡œ ë°˜ì˜ë˜ì§€ ì•Šì•˜ë‹¤ëŠ” ëœ»ì´ë‹¤.

ì´ëŸ° ë¬¸ì œë“¤ì˜ í•´ê²°ì€ `@WebMvcTest` ì–´ë…¸í…Œì´ì…˜ì´ ë„ëŒ€ì²´ ì–´ë–¤ Beanë“¤ì„ ë¡œë”©í•˜ëŠ”ì§€ë¥¼ í™•ì¸í•˜ëŠ” ë¶€ë¶„ë¶€í„° ì‹œì‘í–ˆë‹¤.

```java
@Controller,
@ControllerAdvice,
@JsonComponent,
Converter / GenericConverter,
Filter,
WebSecurityConfigurerAdapter,
WebMvcConfigurer,
HandlerMethodArgumentResolver
```

`@WebMvcTest`ëŠ” ìœ„ì™€ ê°™ì€ ì–´ë…¸í…Œì´ì…˜ì´ ë¶™ì€ Beanì„ ë¡œë”©í•œë‹¤.

ì—¬ê¸°ì„œ `WebSecurityConfigurerAdapter`ì´ ì¤‘ìš”í•˜ë‹¤.

Spring Securityì— ëŒ€í•œ ì„¤ì • ë˜í•œ ìŠ¤ìº” ëŒ€ìƒì— ë“¤ì–´ê°„ë‹¤ëŠ” ì˜ë¯¸ë‹¤.

ê·¸ë ‡ë‹¤ë©´, ìŠ¤ìº” ëŒ€ìƒì¸ë° ì™œ ë‚´ê°€ ë§Œë“  í•„í„°ë“¤ì´ ì œëŒ€ë¡œ ë°˜ì˜ë˜ì§€ ì•Šì•˜ëŠ”ê°€ì— ëŒ€í•œ ì˜ë¬¸ì´ ìƒê¸¸ ìˆ˜ ìˆë‹¤.<br>ì´ìœ ì¸ ì¦‰ìŠ¨, Spring Security ê´€ë ¨ëœ ì»´í¬ë„ŒíŠ¸ë¥¼ **ê¸°ë³¸ ì„¤ì •ìœ¼ë¡œ ìë™ êµ¬ì„±**í•˜ê¸° ë•Œë¬¸ì´ë‹¤.

`WebSecurityConfigurerAdapter` í´ë˜ìŠ¤ ì½”ë“œë¥¼ ì‚´í´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì€ ë¶€ë¶„ì´ ìˆë‹¤.

![image](https://user-images.githubusercontent.com/85394884/210132741-6afd164b-222f-4278-9f4f-c32718198f07.png)

ì´ëŸ° ê¸°ë³¸ ì„¤ì •ëœ ì»´í¬ë„ŒíŠ¸ë¥¼ ìŠ¤ìº”í•˜ê¸° ë•Œë¬¸ì— ì•„ë˜ì˜ ë‚´ Security ì„¤ì •ì •ë³´ì˜ 

`csrf().diable()`, <br>`.exceptionHandling().authenticationEntryPoint(new CustomAuthenticationEntryPoint())`,<br> `.addFilterBefore(new JwtTokenFilter(secretKey), UsernamePasswordAuthenticationFilter.class)`,<br> `.addFilterBefore(new JwtTokenExceptionFilter(),JwtTokenFilter.class)` 

ë“±ì˜ ë‚´ê°€ êµ¬ì„±í•œ ì„¤ì •ë“¤ì´ ë°˜ì˜ë˜ì§€ ëª»í–ˆë˜ ê²ƒì´ì—ˆë‹¤.

ë˜í•œ ì´ëŸ° ìƒí™©ì—ì„œ, `@WithMockUser`, `@WithAnonymousUser` ì–´ë…¸í…Œì´ì…˜ì„ ë¶™ì—¬ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ë‹ˆ ë‚´ê°€ ì›í•˜ëŠ” ë°©í–¥ìœ¼ë¡œ ì œëŒ€ë¡œ í…ŒìŠ¤íŠ¸ê°€ ë˜ì§€ ì•Šì•˜ë˜ ê²ƒì´ì—ˆë‹¤.
                
```java
@Bean
public SecurityFilterChain securityFilterChain(HttpSecurity httpSecurity) throws Exception {
    return httpSecurity
            .httpBasic().disable() //rest api ì´ë¯€ë¡œ ê¸°ë³¸ì„¤ì • ì‚¬ìš©ì•ˆí•¨. ê¸°ë³¸ì„¤ì •ì€ ë¹„ì¸ì¦ì‹œ ë¡œê·¸ì¸í¼ í™”ë©´ìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
            .csrf().disable()      //rest api ì´ë¯€ë¡œ csrf ë³´ì•ˆì´ í•„ìš”ì—†ìŒ
            .cors()
            .and()
                .sessionManagement()
                .sessionCreationPolicy(SessionCreationPolicy.STATELESS) //jwt tokenìœ¼ë¡œ ì¸ì¦ì‹œ ì„¸ì…˜ í•„ìš”ì—†ìœ¼ë¯€ë¡œ ìƒì„±ì•ˆí•¨
            .and()
                .authorizeRequests()
                .antMatchers("/api/v1/users/login","/api/v1/users/join", "/swagger-ui").permitAll() // join, login ì€ ì–¸ì œë‚˜ ê°€ëŠ¥
                .antMatchers(HttpMethod.GET,"/api/v1/**").permitAll()   // ëª¨ë“  get ìš”ì²­ í—ˆìš©
                .antMatchers(HttpMethod.POST,"/api/v1/**").authenticated()  // ìˆœì„œëŒ€ë¡œ ì ìš©ì´ ë˜ê¸° ë•Œë¬¸ì— join, login ë‹¤ìŒì— ì¨ì£¼ê¸°
                .antMatchers(HttpMethod.PUT, "/api/v1/**").authenticated()
                .antMatchers(HttpMethod.DELETE, "/api/v1/**").authenticated()
            .and()
                .exceptionHandling().authenticationEntryPoint(new CustomAuthenticationEntryPoint())// í† í° ì—†ì„ ì‹œ ì—ëŸ¬ ì²˜ë¦¬
            .and()
                .addFilterBefore(new JwtTokenFilter(secretKey), UsernamePasswordAuthenticationFilter.class) // UserNamePasswordAuthenticationFilter ì ìš©í•˜ê¸° ì „ì— JwtTokenFilter ì ìš©í•œë‹¤ëŠ” ì˜ë¯¸
                .addFilterBefore(new JwtTokenExceptionFilter(),JwtTokenFilter.class)    // ì¸ì¦
            .build();
}

```

<br>

í•´ê²°ë°©ë²•ì€ ë¬´ì—‡ì¼ê¹Œ????

ìœ„ì—ì„œ ë§í•œ Securityë¥¼ í¬í•¨ì‹œí‚¤ëŠ” ë°©ë²•ì—ì„œ ë‚¨ì€ 1ê°€ì§€ ë°©ë²•ì´ ë°”ë¡œ ì´ê²ƒê³¼ ê´€ë ¨ì´ ìˆë‹¤.

ë°”ë¡œ, ì§ì ‘ ì‘ì„±í•œ WebSecurityConfigê¹Œì§€ í¬í•¨ì‹œí‚¤ê¸° ìœ„í•´ `ì»¤ìŠ¤í…€ WebMvcTest` ì–´ë…¸í…Œì´ì…˜ì„ ë§Œë“¤ì–´ Security ì„¤ì •ë“¤ì„ í¬í•¨ì‹œì¼œì£¼ëŠ” ë°©ë²•ì´ë‹¤.

ì´ ê³¼ì •ì„ ë°”ë¡œ ë³´ì—¬ì£¼ë©´ ì•„ì£¼ ì¢‹ê² ì§€ë§Œ, ë‚˜ëŠ” ë‹¨ê³„ë³„ë¡œ ì²˜ìŒ ë‚´ê°€ ì‘ì„±í–ˆë˜ ì´ìƒí•œ í…ŒìŠ¤íŠ¸ ì½”ë“œë¶€í„° ì‹œì‘í•´ë³´ê² ë‹¤.

> 3ê°€ì§€ ê²½ìš°ë¥¼ ë°œì „ì‹œí‚¤ë©´ì„œ ë³´ì—¬ì¤„ ê²ƒì´ê³ , <br>ê°ê°ì˜ ìƒí™©ì—ì„œ í…ŒìŠ¤íŠ¸í•  ê²ƒì€ ì¸ì¦ëœ íšŒì›ì—¬ë¶€ì™€ ìƒê´€ì—†ì´ _1.ê²Œì‹œê¸€ì„ ì¡°íšŒí•˜ëŠ” ê¸°ëŠ¥ì˜ ì„±ê³µ í…ŒìŠ¤íŠ¸_ ì™€, ì¸ì¦ëœ íšŒì›ë§Œì´ ê°€ëŠ¥í•œ _2.ê²Œì‹œê¸€ ë“±ë¡ ê¸°ëŠ¥ì˜ ì„±ê³µ í…ŒìŠ¤íŠ¸_ ì™€ _3.ì¸ì¦ë˜ì§€ ì•Šì•„ì„œ ì‹¤íŒ¨í•˜ëŠ” í…ŒìŠ¤íŠ¸_ ë¥¼ ë³´ì—¬ì¤„ ê²ƒì´ë‹¤. 
>

### 1. `@WithMockUser`, `@WithAnonymousUser` ì‚¬ìš©
---

#### 1-1. ê²Œì‹œê¸€ ì¡°íšŒ ì„±ê³µ í…ŒìŠ¤íŠ¸
```java
@WebAppConfiguration
@WebMvcTest(PostApiController.class)
class PostApiControllerTest {

    @Autowired
    MockMvc mockMvc;
    @Autowired
    ObjectMapper objectMapper;
    @MockBean
    PostService postService;

    private final PostDetailResponse postDetailResponse = PostDetailResponse.builder().id(1).title("title").body("body").userName("userName").build();


    @Test
    @DisplayName("í¬ìŠ¤íŠ¸ ìƒì„¸ ì¡°íšŒ ì„±ê³µ")
    @WithMockUser
    public void postdetail_success() throws Exception {
        Integer postsId = 1;
        given(postService.findPost(postsId)).willReturn(postDetailResponse);

        mockMvc.perform(get("/api/v1/posts/" + postsId)
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsBytes(postDetailResponse)))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.result.id").value(1))
                .andExpect(jsonPath("$.result.title").value("title"))
                .andExpect(jsonPath("$.result.body").value("body"))
                .andDo(print());

        verify(postService,times(1)).findPost(postsId);
    }
}
```
í¬ìŠ¤íŠ¸ ì¡°íšŒ ê¸°ëŠ¥ì€ ì¸ì¦ëœ íšŒì›ì˜ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ í†µê³¼í•´ì•¼ í•œë‹¤. 

ğŸš« ê·¸ëŸ°ë°, `@WithMockUser` ì–´ë…¸í…Œì´ì…˜ì´ ì—†ìœ¼ë©´ í†µê³¼í•˜ì§€ ì•ŠëŠ”ë‹¤.

ì–´ë…¸í…Œì´ì…˜ì´ ì—†ê±°ë‚˜ `@WithAnonymousUser` ì‚¬ìš© ì‹œ ë‹¤ìŒê³¼ ê°™ì€ ì—ëŸ¬ê°€ ë‚œë‹¤. 

ë¶„ëª…íˆ ì •í™•íˆ ì‘ë™í•˜ëŠ” í…ŒìŠ¤íŠ¸ê°€ ì•„ë‹ˆë‹¤...

![image](https://user-images.githubusercontent.com/85394884/210134963-73c7cbd9-f4b7-4a5b-8cdb-bc30ed037713.png)


#### 1-2. ê²Œì‹œê¸€ ë“±ë¡ ì„±ê³µ í…ŒìŠ¤íŠ¸
```java
@WebAppConfiguration
@WebMvcTest(PostApiController.class)
class PostApiControllerTest {

    @Autowired
    MockMvc mockMvc;
    @Autowired
    ObjectMapper objectMapper;
    @MockBean
    PostService postService;

    private final PostCreateRequest postCreateRequest = new PostCreateRequest("ì œëª©", "ë‚´ìš©");
    private final PostCreateResponse postCreateResponse = new PostCreateResponse(1, "í¬ìŠ¤íŠ¸ ë“±ë¡ ì™„ë£Œ");

    @Test
    @DisplayName("í¬ìŠ¤íŠ¸ ë“±ë¡ ì„±ê³µ")
    @WithMockUser
    public void post_create_success() throws Exception {

        given(postService.createPost(any(),any())).willReturn(postCreateResponse);

        mockMvc.perform(post("/api/v1/posts")
                        .with(csrf())
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsBytes(postCreateRequest)))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.resultCode").value("SUCCESS"))
                .andExpect(jsonPath("$.result.postId").value(1))
                .andExpect(jsonPath("$.result.message").value("í¬ìŠ¤íŠ¸ ë“±ë¡ ì™„ë£Œ"))
                .andDo(print());

        verify(postService,times(1)).createPost(any(),any());
    }
}
```
ğŸš« ë‚˜ëŠ” SecurityConfigì—ì„œ ë¶„ëª…íˆ `.csrf().disable()`ì„¤ì •ì„ í–ˆëŠ”ë°ë„ ë¶ˆêµ¬í•˜ê³ , `with(csrf())`ê°€ ì—†ìœ¼ë©´ ë‹¤ìŒê³¼ ê°™ì´ í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í•˜ì§€ ì•ŠëŠ”ë‹¤.

![image](https://user-images.githubusercontent.com/85394884/210135226-14bae3cd-c158-4d44-ac08-0773ab9ca90f.png)


ğŸš«`.with(csrf())`ê°€ ìˆì–´ë„, í† í°ì´ ì—†ê±°ë‚˜ í† í°ì„ ì´ìƒí•˜ê²Œ ë„£ì—ˆëŠ”ë°ë„ í†µê³¼í•œë‹¤. 

ì¦‰, `.header(HttpHeaders.AUTHORIZATION,"Bearer " + token)`ì´ ì—†ê±°ë‚˜ ì´ìƒí•˜ê²Œ ë„£ì–´ë„ í†µê³¼í•œë‹¤.

![image](https://user-images.githubusercontent.com/85394884/210135542-55e8c141-4828-4f3d-b02d-9118dd780fb4.png)

![image](https://user-images.githubusercontent.com/85394884/210135445-5ac0b5c7-7aea-4449-9353-0b34c433903b.png)

ì´ê²ƒ ë˜í•œ, ì •í™•í•˜ì§€ ì•Šì€ í…ŒìŠ¤íŠ¸ì´ë‹¤...

#### 1-3. ê²Œì‹œê¸€ ë“±ë¡ ì¸ì¦ ì‹¤íŒ¨ í…ŒìŠ¤íŠ¸
```java
@WebAppConfiguration
@WebMvcTest(PostApiController.class)
class PostApiControllerTest {

    @Autowired
    MockMvc mockMvc;
    @Autowired
    ObjectMapper objectMapper;
    @MockBean
    PostService postService;

    private final PostCreateRequest postCreateRequest = new PostCreateRequest("ì œëª©", "ë‚´ìš©");
    private final PostCreateResponse postCreateResponse = new PostCreateResponse(1, "í¬ìŠ¤íŠ¸ ë“±ë¡ ì™„ë£Œ");

    @Test
    @DisplayName("í¬ìŠ¤íŠ¸ ì‘ì„± ì‹¤íŒ¨(1) - ì¸ì¦ ì‹¤íŒ¨ (Bearer í† í°ìœ¼ë¡œ ë³´ë‚´ì§€ ì•Šì€ ê²½ìš°)")
    public void post_create_fail1() throws Exception {

        String token = JwtTokenUtil.createToken("user", secretKey, 1000 * 60 * 60L);



        mockMvc.perform(post("/api/v1/posts")
                        .with(csrf())
                        .header(HttpHeaders.AUTHORIZATION,"Basic " + token) 
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsBytes(postCreateRequest)))
                .andExpect(status().is(INVALID_TOKEN.getStatus().value()))
                .andDo(print());
    }
}
```
Bearer í† í°ìœ¼ë¡œ ë³´ë‚´ì§€ ì•Šì•˜ì„ ë•Œ `INVALID_TOKEN` ì—ëŸ¬ê°€ ë°˜í™˜ë˜ëŠ”ì§€ë¥¼ í™•ì¸í•˜ëŠ” í…ŒìŠ¤íŠ¸ì´ë‹¤.

ğŸš« ì´ ë˜í•œ, `with(csrf())`ê°€ ì—†ìœ¼ë©´ ë‹¤ìŒê³¼ ê°™ì´ í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í•˜ì§€ ì•ŠëŠ”ë‹¤.

![image](https://user-images.githubusercontent.com/85394884/210135734-12fd5576-e9c5-4a38-9ccf-459ad5da402a.png)


ğŸš«`.with(csrf())`ê°€ ìˆì–´ë„, Bearerìœ¼ë¡œ ì‹œì‘í•˜ë©´ í…ŒìŠ¤íŠ¸ê°€ í†µê³¼ë˜ì§€ ì•Šì•„ì•¼ í•˜ëŠ”ë° í†µê³¼ëœë‹¤. 
```java
.header(HttpHeaders.AUTHORIZATION,"Bearer " + token) 
```
![image](https://user-images.githubusercontent.com/85394884/210135825-57aabeab-1e9f-4036-af28-6ff1f7770528.png)


ì´ê²ƒ ë˜í•œ, ì •í™•í•˜ì§€ ì•Šì€ í…ŒìŠ¤íŠ¸ì´ë‹¤...


### 2. `@Import(SecurityConfig.class)` ì‚¬ìš©
---

í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ ë§¨ìœ„ì— `@Import(SecurityConfig.class)`ì„ ë¶™ì¸ë‹¤.

#### 2-1. ê²Œì‹œê¸€ ì¡°íšŒ ì„±ê³µ í…ŒìŠ¤íŠ¸
```java
@WebAppConfiguration
@WebMvcTest(PostApiController.class)
@Import(SecurityConfig.class)
class PostApiControllerTest {

    @Autowired
    MockMvc mockMvc;
    @Autowired
    ObjectMapper objectMapper;
    @MockBean
    PostService postService;

    private final PostDetailResponse postDetailResponse = PostDetailResponse.builder().id(1).title("title").body("body").userName("userName").build();

    @Test
    @DisplayName("í¬ìŠ¤íŠ¸ ìƒì„¸ ì¡°íšŒ ì„±ê³µ")
    @WithMockUser
    public void postdetail_success() throws Exception {
        Integer postsId = 1;
        given(postService.findPost(postsId)).willReturn(postDetailResponse);

        mockMvc.perform(get("/api/v1/posts/" + postsId)
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsBytes(postDetailResponse)))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.result.id").value(1))
                .andExpect(jsonPath("$.result.title").value("title"))
                .andExpect(jsonPath("$.result.body").value("body"))
                .andDo(print());

        verify(postService,times(1)).findPost(postsId);
    }
}
```
âœ… ì´ì œ, `@WithMockUser` ì–´ë…¸í…Œì´ì…˜ì´ ì—†ì–´ë„ í†µê³¼í•œë‹¤. ì¦‰, ì¸ì¦ëœ íšŒì›ì˜ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ í†µê³¼í•œë‹¤.

âœ… ë˜í•œ, `.with(csrf())`ê°€ ì—†ì–´ë„ í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í•œë‹¤. `@Import(SecurityConfig.class)`ë¥¼ í†µí•´, ë‚´ê°€ ì‘ì„±í•œ Security ì„¤ì • ì •ë³´ê°€ í…ŒìŠ¤íŠ¸ì— ì¶”ê°€ë˜ì—ˆê¸° ë•Œë¬¸ì— ê°€ëŠ¥í•œ ì¼ì´ë‹¤.

#### 2-2. ê²Œì‹œê¸€ ë“±ë¡ ì„±ê³µ í…ŒìŠ¤íŠ¸
```java
@WebAppConfiguration
@WebMvcTest(PostApiController.class)
@Import(SecurityConfig.class)
class PostApiControllerTest {

    @Autowired
    MockMvc mockMvc;
    @Autowired
    ObjectMapper objectMapper;
    @MockBean
    PostService postService;
    @Autowired
    WebApplicationContext context;
    @Value("${jwt.token.secret}") String secretKey;

    private final PostCreateRequest postCreateRequest = new PostCreateRequest("ì œëª©", "ë‚´ìš©");
    private final PostCreateResponse postCreateResponse = new PostCreateResponse(1, "í¬ìŠ¤íŠ¸ ë“±ë¡ ì™„ë£Œ");

    @Test
    @DisplayName("í¬ìŠ¤íŠ¸ ë“±ë¡ ì„±ê³µ")
    public void post_create_success() throws Exception {

        String token = JwtTokenUtil.createToken("userName", secretKey, 1000 * 60 * 60L);

        given(postService.createPost(any(),any())).willReturn(postCreateResponse);

        mockMvc.perform(post("/api/v1/posts")
                        .header(HttpHeaders.AUTHORIZATION,"Bearer " + token)
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsBytes(postCreateRequest)))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.resultCode").value("SUCCESS"))
                .andExpect(jsonPath("$.result.postId").value(1))
                .andExpect(jsonPath("$.result.message").value("í¬ìŠ¤íŠ¸ ë“±ë¡ ì™„ë£Œ"))
                .andDo(print());

        verify(postService,times(1)).createPost(any(),any());
    }
}
```
âœ… ì´ì œ `@WithMockUser` ì–´ë…¸í…Œì´ì…˜ì´ ì—†ì–´ë„ í†µê³¼í•œë‹¤. ê·¸ ì´ìœ ëŠ” ì§ì ‘ í† í°ì„ ìƒì„±í•´ì„œ ì¸ì¦ ì ˆì°¨ë¥¼ ì§„í–‰í–ˆê¸° ë•Œë¬¸ì´ë‹¤. ë³´ë‹¤ ì •í™•í•œ í…ŒìŠ¤íŠ¸ë¼ê³  í•  ìˆ˜ ìˆë‹¤.

ğŸš« ì´ì œ í† í°ì„ ìœ„ì™€ ê°™ì´ ì œëŒ€ë¡œ ë„£ì§€ ì•Šì„ ê²½ìš°, ê²Œì‹œê¸€ ë“±ë¡ ì„±ê³µ í…ŒìŠ¤íŠ¸ëŠ” ë‹¤ìŒê³¼ ê°™ì´ í†µê³¼í•˜ì§€ ì•ŠëŠ”ë‹¤.

![image](https://user-images.githubusercontent.com/85394884/210137773-fb6d25ae-8367-402f-a689-05b62c1b636f.png)

âœ… ë˜í•œ, `.with(csrf())`ê°€ ì—†ì–´ë„ í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í•œë‹¤. ì´ê²ƒ ë˜í•œ, `@Import(SecurityConfig.class)`ë¥¼ í†µí•´, ë‚´ê°€ ì‘ì„±í•œ Security ì„¤ì • ì •ë³´ê°€ í…ŒìŠ¤íŠ¸ì— ì¶”ê°€ë˜ì—ˆê¸° ë•Œë¬¸ì— ê°€ëŠ¥í•œ ì¼ì´ë‹¤.

#### 2-3. ê²Œì‹œê¸€ ë“±ë¡ ì¸ì¦ ì‹¤íŒ¨ í…ŒìŠ¤íŠ¸
```java
@WebAppConfiguration
@WebMvcTest(PostApiController.class)
@Import(SecurityConfig.class)
class PostApiControllerTest {

    @Autowired
    MockMvc mockMvc;
    @Autowired
    ObjectMapper objectMapper;
    @MockBean
    PostService postService;
    @Autowired
    WebApplicationContext context;
    @Value("${jwt.token.secret}") String secretKey;

    private final PostCreateRequest postCreateRequest = new PostCreateRequest("ì œëª©", "ë‚´ìš©");
    private final PostCreateResponse postCreateResponse = new PostCreateResponse(1, "í¬ìŠ¤íŠ¸ ë“±ë¡ ì™„ë£Œ");

    @Test
    @DisplayName("í¬ìŠ¤íŠ¸ ì‘ì„± ì‹¤íŒ¨(1) - ì¸ì¦ ì‹¤íŒ¨ (Bearer í† í°ìœ¼ë¡œ ë³´ë‚´ì§€ ì•Šì€ ê²½ìš°)")
    public void post_create_fail1() throws Exception {

        String token = JwtTokenUtil.createToken("user", secretKey, 1000 * 60 * 60L);

        mockMvc.perform(post("/api/v1/posts")
                        .header(HttpHeaders.AUTHORIZATION,"Basic " + token) 
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsBytes(postCreateRequest)))
                .andExpect(status().is(INVALID_TOKEN.getStatus().value()))
                .andDo(print());
    }
}
```
Bearer í† í°ìœ¼ë¡œ ë³´ë‚´ì§€ ì•Šì•˜ì„ ë•Œ `INVALID_TOKEN` ì—ëŸ¬ê°€ ë°˜í™˜ë˜ëŠ”ì§€ë¥¼ í™•ì¸í•˜ëŠ” í…ŒìŠ¤íŠ¸ì´ë‹¤.

âœ… Bearer í† í°ìœ¼ë¡œ ë³´ë‚´ì§€ ì•Šì„ ì‹œ ë‚´ê°€ ì‘ì„±í•œ `CustomAuthenticationEntryPoint.class`ê°€ ì‘ë™í•˜ì—¬ ì¸ì¦ ì‹¤íŒ¨ í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí•œë‹¤.
![image](https://user-images.githubusercontent.com/85394884/210137233-2c3727e1-541c-47d2-9487-0f505682c7cc.png)

âœ… ë§ˆì°¬ê°€ì§€ë¡œ, `.with(csrf())`ê°€ ì—†ì–´ë„ í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í•œë‹¤. ì´ê²ƒ ë˜í•œ, `@Import(SecurityConfig.class)`ë¥¼ í†µí•´, ë‚´ê°€ ì‘ì„±í•œ Security ì„¤ì • ì •ë³´ê°€ í…ŒìŠ¤íŠ¸ì— ì¶”ê°€ë˜ì—ˆê¸° ë•Œë¬¸ì— ê°€ëŠ¥í•œ ì¼ì´ë‹¤.
 

### 3. ì»¤ìŠ¤í…€ `WebMvcTest` ì–´ë…¸í…Œì´ì…˜ ì‚¬ìš© 
---

ë§ˆì§€ë§‰ ê³¼ì •ì€ ê¸°ì¡´ì˜ `@WebMvcTest`ì–´ë…¸í…Œì´ì…˜ê³¼ `@Import(SecurityConfig.class)`ì„ í•©ì¹œ ì»¤ìŠ¤í…€ ì–´ë…¸í…Œì´ì…˜ì„ ë§Œë“¤ì–´ì„œ ì‚¬ìš©í•œë‹¤.

`@WebMvcTestSecurity`ë¥¼ ë§Œë“¤ì–´ ë˜‘ê°™ì´ ì‘ë™í•˜ë„ë¡ í•´ë³´ê² ë‹¤.

```java
@Target(ElementType.TYPE)
@Retention(RetentionPolicy.RUNTIME)
@WebMvcTest
@ImportAutoConfiguration(SecurityConfig.class)
public @interface WebMvcTestSecurity {
    @AliasFor(annotation = WebMvcTest.class, attribute = "value")
    Class<?>[] value() default {};
}
```
ë‹¤ìŒê³¼ ê°™ì´ @WebMvcTest ê¸°ë³¸ ì„¤ì •ì— ë‚´ê°€ ì‘ì„±í•œ Security ì„¤ì •ì„ ì¶”ê°€í•˜ë„ë¡<br> `@ImportAutoConfiguration(SecurityConfig.class)`ë¥¼ ë¶™ì¸ë‹¤.

ì•ì—ì„œ `@Import(SecurityConfig.class)`ì˜ ê¸°ëŠ¥ê³¼ ë˜‘ê°™ì€ ì—­í• ì„ í•œë‹¤.

ì´ì œ, í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ ë§¨ìœ„ì— ì»¤ìŠ¤í…€ ì–´ë…¸í…Œì´ì…˜ì„ ë¶™ì¸ë‹¤.

#### 3-1. ê²Œì‹œê¸€ ì¡°íšŒ ì„±ê³µ í…ŒìŠ¤íŠ¸
```java
@WebAppConfiguration
@WebMvcTestSecurity(value = PostApiController.class)
class PostApiControllerTest {

    @Autowired
    MockMvc mockMvc;
    @Autowired
    ObjectMapper objectMapper;
    @MockBean
    PostService postService;

    private final PostDetailResponse postDetailResponse = PostDetailResponse.builder().id(1).title("title").body("body").userName("userName").build();

    @Test
    @DisplayName("í¬ìŠ¤íŠ¸ ìƒì„¸ ì¡°íšŒ ì„±ê³µ")
    public void postdetail_success() throws Exception {
        Integer postsId = 1;
        given(postService.findPost(postsId)).willReturn(postDetailResponse);

        mockMvc.perform(get("/api/v1/posts/" + postsId)
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsBytes(postDetailResponse)))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.result.id").value(1))
                .andExpect(jsonPath("$.result.title").value("title"))
                .andExpect(jsonPath("$.result.body").value("body"))
                .andDo(print());

        verify(postService,times(1)).findPost(postsId);
    }
}
```
âœ… ë§ˆì°¬ê°€ì§€ë¡œ, `@WithMockUser` ì–´ë…¸í…Œì´ì…˜ì´ ì—†ì–´ë„ í†µê³¼í•œë‹¤. ì¦‰, ì¸ì¦ëœ íšŒì›ì˜ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ í†µê³¼í•œë‹¤.

âœ… `.with(csrf())`ê°€ ì—†ì–´ë„ í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í•œë‹¤.

âœ… ë‚´ê°€ ì‘ì„±í•œ Security ì„¤ì • ì •ë³´ê°€ ì»¤ìŠ¤í…€ ì–´ë…¸í…Œì´ì…˜ `@WebMvcTestSecurity`ë¥¼ í†µí•´ í…ŒìŠ¤íŠ¸ì— ì¶”ê°€ë˜ì—ˆê¸° ë•Œë¬¸ì— ê°€ëŠ¥í•œ ì¼ì´ë‹¤.


#### 3-2. ê²Œì‹œê¸€ ë“±ë¡ ì„±ê³µ í…ŒìŠ¤íŠ¸
```java
@WebAppConfiguration
@WebMvcTestSecurity(value = PostApiController.class)
class PostApiControllerTest {

    @Autowired
    MockMvc mockMvc;
    @Autowired
    ObjectMapper objectMapper;
    @MockBean
    PostService postService;
    @Autowired
    WebApplicationContext context;
    @Value("${jwt.token.secret}") String secretKey;

    private final PostCreateRequest postCreateRequest = new PostCreateRequest("ì œëª©", "ë‚´ìš©");
    private final PostCreateResponse postCreateResponse = new PostCreateResponse(1, "í¬ìŠ¤íŠ¸ ë“±ë¡ ì™„ë£Œ");

    @Test
    @DisplayName("í¬ìŠ¤íŠ¸ ë“±ë¡ ì„±ê³µ")
    public void post_create_success() throws Exception {

        String token = JwtTokenUtil.createToken("userName", secretKey, 1000 * 60 * 60L);

        given(postService.createPost(any(),any())).willReturn(postCreateResponse);

        mockMvc.perform(post("/api/v1/posts")
                        .header(HttpHeaders.AUTHORIZATION,"Bearer " + token)
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsBytes(postCreateRequest)))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.resultCode").value("SUCCESS"))
                .andExpect(jsonPath("$.result.postId").value(1))
                .andExpect(jsonPath("$.result.message").value("í¬ìŠ¤íŠ¸ ë“±ë¡ ì™„ë£Œ"))
                .andDo(print());

        verify(postService,times(1)).createPost(any(),any());
    }
}
```
2ë²ˆ ê³¼ì •ê³¼ ë˜‘ê°™ì€ ì„±ê³µ ê²°ê³¼ê°€ ë‚˜ì˜¨ë‹¤.

![image](https://user-images.githubusercontent.com/85394884/210137663-7e8b0607-b4f2-4e93-92db-9447711e1403.png)

âœ… `@WithMockUser` ì–´ë…¸í…Œì´ì…˜ì´ ì—†ì–´ë„ í†µê³¼í•œë‹¤. ì§ì ‘ í† í°ì„ ìƒì„±í•´ì„œ ì¸ì¦ ì ˆì°¨ë¥¼ ì§„í–‰í–ˆê¸° ë•Œë¬¸ì´ë‹¤.

ğŸš« ì´ì œ í† í°ì„ ì œëŒ€ë¡œ ë„£ì§€ ì•Šì„ ê²½ìš°, ê²Œì‹œê¸€ ë“±ë¡ ì„±ê³µ í…ŒìŠ¤íŠ¸ëŠ” ë‹¤ìŒê³¼ ê°™ì´ í†µê³¼í•˜ì§€ ì•ŠëŠ”ë‹¤.

![image](https://user-images.githubusercontent.com/85394884/210137832-3f53ecb6-d1a4-41d1-88ca-6e34bdbac784.png)

âœ… ë˜í•œ, `.with(csrf())`ê°€ ì—†ì–´ë„ í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í•œë‹¤. ë‚´ê°€ ì‘ì„±í•œ Security ì„¤ì • ì •ë³´ê°€ ì»¤ìŠ¤í…€ ì–´ë…¸í…Œì´ì…˜ `@WebMvcTestSecurity`ë¥¼ í†µí•´ í…ŒìŠ¤íŠ¸ì— ì¶”ê°€ë˜ì—ˆê¸° ë•Œë¬¸ì— ê°€ëŠ¥í•œ ì¼ì´ë‹¤.

#### 3-3. ê²Œì‹œê¸€ ë“±ë¡ ì¸ì¦ ì‹¤íŒ¨ í…ŒìŠ¤íŠ¸

```java
@WebAppConfiguration
@WebMvcTestSecurity(value = PostApiController.class)
class PostApiControllerTest {

    @Autowired
    MockMvc mockMvc;
    @Autowired
    ObjectMapper objectMapper;
    @MockBean
    PostService postService;
    @Autowired
    WebApplicationContext context;
    @Value("${jwt.token.secret}") String secretKey;

    private final PostCreateRequest postCreateRequest = new PostCreateRequest("ì œëª©", "ë‚´ìš©");
    private final PostCreateResponse postCreateResponse = new PostCreateResponse(1, "í¬ìŠ¤íŠ¸ ë“±ë¡ ì™„ë£Œ");

    @Test
    @DisplayName("í¬ìŠ¤íŠ¸ ì‘ì„± ì‹¤íŒ¨(1) - ì¸ì¦ ì‹¤íŒ¨ (Bearer í† í°ìœ¼ë¡œ ë³´ë‚´ì§€ ì•Šì€ ê²½ìš°)")
    public void post_create_fail1() throws Exception {

        String token = JwtTokenUtil.createToken("user", secretKey, 1000 * 60 * 60L);

        mockMvc.perform(post("/api/v1/posts")
                        .header(HttpHeaders.AUTHORIZATION,"Basic " + token) 
                        .contentType(MediaType.APPLICATION_JSON)
                        .content(objectMapper.writeValueAsBytes(postCreateRequest)))
                .andExpect(status().is(INVALID_TOKEN.getStatus().value()))
                .andDo(print());
    }
}
```
Bearer í† í°ìœ¼ë¡œ ë³´ë‚´ì§€ ì•Šì•˜ì„ ë•Œ `INVALID_TOKEN` ì—ëŸ¬ê°€ ë°˜í™˜ë˜ëŠ”ì§€ë¥¼ í™•ì¸í•˜ëŠ” í…ŒìŠ¤íŠ¸ì´ë‹¤.

âœ… 2ë²ˆ ê³¼ì •ê³¼ ë˜‘ê°™ì€ í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ë°˜í™˜í•œë‹¤.

![image](https://user-images.githubusercontent.com/85394884/210137947-e0a2b9a7-ca99-49ae-851c-7b1e09b0afba.png)

âœ… ë˜í•œ, `.with(csrf())`ê°€ ì—†ì–´ë„ í…ŒìŠ¤íŠ¸ê°€ í†µê³¼í•œë‹¤. ë‚´ê°€ ì‘ì„±í•œ Security ì„¤ì • ì •ë³´ê°€ ì»¤ìŠ¤í…€ ì–´ë…¸í…Œì´ì…˜ `@WebMvcTestSecurity`ë¥¼ í†µí•´ í…ŒìŠ¤íŠ¸ì— ì¶”ê°€ë˜ì—ˆê¸° ë•Œë¬¸ì— ê°€ëŠ¥í•œ ì¼ì´ë‹¤.

### 4. ì •ë¦¬
---

Securityê°€ í¬í•¨ëœ ControllerTestë¥¼ ì§„í–‰í•˜ëŠ” ë°©ë²•ì„ 3ê°€ì§€ë¡œ ìƒê°í•´ë³´ì•˜ë‹¤.

1. Securityë¥¼ ì œì™¸í•˜ì—¬ ë‹¨ìœ„í…ŒìŠ¤íŠ¸ ëª©ì ì— ì™„ë²½íˆ ë¶€í•©í•˜ê²Œ í•˜ëŠ” ë°©ë²•

2. ê¸°ë³¸ Security ì„¤ì • ê°’ë§Œ í¬í•¨ í•˜ëŠ” ë°©ë²•(`@WithMockUser` or `@WithAnonymousUser`)

3. ê°œê°œì¸ë§ˆë‹¤ ì‘ì„±í•œ Security ì„¤ì •ì„ í¬í•¨ì‹œì¼œì„œ í…ŒìŠ¤íŠ¸ í•˜ëŠ” ë°©ë²•
    3.1 `@Import(SecurityConfig.class)`ë¥¼ í†µí•´ ì¶”ê°€
    3.2 Security ì„¤ì •ì •ë³´ë¥¼ í¬í•¨í•œ `ì»¤ìŠ¤í…€ ì–´ë…¸í…Œì´ì…˜` ì¶”ê°€

---

ê²°êµ­ ë‚˜ëŠ” 2 â¡ï¸ 3ë‹¨ê³„ë¥¼ ê±°ì³ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í–ˆë‹¤. 

í•˜ì§€ë§Œ, ì™„ë²½í•œ ë‹¨ìœ„í…ŒìŠ¤íŠ¸ë¥¼ í•˜ëŠ” ê²ƒ, ì¦‰, ë‹¨ìˆœíˆ ê²Œì‹œê¸€ ì¡°íšŒì™€ ë“±ë¡ ìš”ì²­/ì‘ë‹µì´ ì˜ ì§„í–‰ë˜ëŠ”ì§€ í™•ì¸í•˜ê³  ì‹¶ë‹¤ë©´, Securityë¥¼ ì œì™¸í•˜ê³  ì§„í–‰í•˜ëŠ” ê²ƒë„ ì¢‹ì€ ë°©ë²•ì´ë‹¤.

ëŒ€ì‹  ì´ëŸ° ê²½ìš°ì—” í† í°ê³¼ ê´€ë ¨í•œ ì¸ì¦ í…ŒìŠ¤íŠ¸ë¥¼ ë”°ë¡œ ì§„í–‰í•´ì•¼ í•  ê²ƒì´ë‹¤.

## References

* [WebMvcTest ê³µì‹ë¬¸ì„œ](https://docs.spring.io/spring-boot/docs/current/api/org/springframework/boot/test/autoconfigure/web/servlet/WebMvcTest.html)
* [MockMvc Setup](https://docs.spring.io/spring-security/reference/servlet/test/mockmvc/setup.html)
* [[Spring Security] @WebMvcTest ì‘ì„± ì‹œ Spring Securityë¡œ ì¸í•´ ë°œìƒí•˜ëŠ” ì˜¤ë¥˜ë“¤](https://ttl-blog.tistory.com/760)
* [[Spring] @WebMvcTest ì‘ì„± ì‹œ Spring Security ìœ ì˜ì‚¬í•­](https://joomn11.tistory.com/87)
* [@WebMvcTest](https://velog.io/@woo00oo/SpringBoot-Test-2)
* [[Spring Security] ê¸°ì¡´ í…ŒìŠ¤íŠ¸ì— ì‹œíë¦¬í‹° ì ìš©í•˜ê¸°](https://yeonyeon.tistory.com/36)




