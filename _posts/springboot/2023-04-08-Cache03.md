---
title:  "Cache ê¸°ëŠ¥ì„ Redisë¡œ êµ¬í˜„í•˜ê¸°ê¹Œì§€ì˜ ê³¼ì •(2) - LocalDateTime ì§ë ¬í™”/ì—­ì§ë ¬í™” ë°©ë²•" 
excerpt: "ì»¤ìŠ¤í…€ ObjectMapperë¥¼ í†µí•œ ë°©ë²•"

categories:
  - Springboot
tags:
  - Springboot

date: 2023-04-08
last_modified_at: 2023-04-08

---

[ì´ì „ ê²Œì‹œë¬¼](https://percyfrank.github.io/springboot/Cache02/)ì—ì„œ ì§ë ¬í™”/ì—­ì§ë ¬í™” ê³¼ì •ì—ì„œ ë¬¸ì œê°€ ìƒê²¨ redisì—ì„œì˜ ì¡°íšŒê°€ ì•ˆë˜ëŠ” ìƒí™©ì´ ë²Œì–´ì¡Œë‹¤.

ì´ìœ ê°€ ë­˜ê¹Œ?

ì•ì„œ `value`ê°’ì„ ì§ë ¬í™”í•˜ëŠ”ë° `GenericJackson2JsonRedisSerializer`í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í–ˆê³ , ì´ í´ë˜ìŠ¤ëŠ” 
ê°ì²´ì˜ í´ë˜ìŠ¤ ì§€ì • ì—†ì´ ëª¨ë“  Class Typeì„ JSON í˜•íƒœë¡œ ì €ì¥í•  ìˆ˜ ìˆë‹¤ê³  í–ˆì—ˆë‹¤.

í•˜ì§€ë§Œ ë‚ ì§œ íƒ€ì…ì— ëŒ€í•´ì„œëŠ” defaultë¡œ ì§€ì›ì´ ì•ˆë˜ëŠ” ê²ƒìœ¼ë¡œ íŒŒì•…ëë‹¤.

ObjectMapperë¥¼ ì»¤ìŠ¤í…€í•˜ì—¬ `GenericJackson2JsonRedisSerializer` í´ë˜ìŠ¤ì™€ ê°™ì€ Serializerì—ê²Œ ì „ë‹¬í•˜ë©´ ëœë‹¤ëŠ” ê²ƒì€ ì°¾ì•˜ì§€ë§Œ ê´€ë ¨ ìë£Œë“¤ë§ˆë‹¤ ë°©ë²•ì´ ë‹¤ë¥¸ë°ë‹¤ê°€ ì ìš©ì´ ì•ˆë˜ëŠ” ë¬¸ì œê°€ ìˆì–´ í•´ê²°í•˜ëŠ”ë° ì‰½ì§€ ì•Šì•˜ë‹¤.

ì´ë¥¼ ìœ„í•œ ì‹œë„ë¡œ 3ê°€ì§€ì˜ ê³¼ì •ì„ ê±°ì³¤ê³ , ê²°êµ­ ì„±ê³µí–ˆë‹¤.

í•˜ë‚˜ì”© ì‚´í´ë³´ë„ë¡ í•˜ì.

ì¶”ê°€ì ìœ¼ë¡œ, ìš°ë¦¬ê°€ ìºì‹±ì„ í†µí•´ ì¡°íšŒí•  ë¶€ë¶„ì€ ì•„ë˜ì™€ ê°™ì´ ìƒí’ˆ ë‹¨ê±´ ì¡°íšŒ ë¶€ë¶„ì´ë‹¤.

```java
@Transactional(readOnly = true)
@Cacheable(value = "products", key ="#id")
public ProductInfo getProductInfo(Long id) {
    return productRepository.findById(id)
            .orElseThrow(() -> new ShoeKreamException(ErrorCode.PRODUCT_NOT_FOUND))
            .toProductInfo();
}
```


### 0. jackson ì˜ì¡´ì„± ì¶”ê°€
---

ğŸš« ì˜¤ë¥˜ ë©”ì„¸ì§€ì— ë”°ë¼ ì˜ì¡´ì„±ì„ ì¶”ê°€í•´ì¤¬ìœ¼ë‚˜ ì‹¤íŒ¨

```implementation 'com.fasterxml.jackson.datatype:jackson-datatype-jsr310:2.14.2'```

<br>

### 1. [`MapperConfig`](https://souljit2.tistory.com/72) ì‘ì„±
---

`ObjectMapper` ì»¤ìŠ¤í…€ì„ ìœ„í•´ `MapperConfig` í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì—ˆë‹¤.

ê·¸ë¦¬ê³  ì»¤ìŠ¤í…€ ObjectMapper Beanì„ ìƒì„±í•˜ì—¬ ê·¸ ì•ˆì— ë‚ ì§œ íƒ€ì… ë³€í™˜ì„ ìœ„í•œ ê³¼ì •ì„ ì¶”ê°€í•´ë³´ì•˜ë‹¤.

ìš°ì„ , `JavaTimeModule`ì„ ë¶ˆëŸ¬ì™€ì„œ `addSerializer()`ì™€ `addDeserializer()`ë¥¼ í†µí•´ ì§ë ¬í™”ì™€ ì—­ì§ë ¬í™”ë¥¼ ìœ„í•œ ì»¤ìŠ¤í…€ í´ë˜ìŠ¤(`LocalDateTimeSerializer`,`LocalDateTimeDeserializer`)ë¥¼ ë„£ì–´ì¤€ë‹¤.

ë‹¤ìŒìœ¼ë¡œ, `objectMapper.registerModules(javaTimeModule, new Jdk8Module())` í†µí•´ ë°©ê¸ˆ ì „ì— ì‘ì„±í•œ `javaTimeModule`ì„ ë“±ë¡í•˜ì—¬ Jacksonì´ `LocalDate`, `LocalDateTime`ë“±ì„ ë§¤í•‘í•  ìˆ˜ ìˆë„ë¡ í•´ì¤€ë‹¤.

ë§ˆì§€ë§‰ìœ¼ë¡œ, `objectMapper.configure(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS, false)`ì„ í†µí•´ì„  Dataë¥¼ TimeStamp í˜•ì‹ìœ¼ë¡œ ì§ë ¬í™”í•˜ì§€ ëª»í•˜ê²Œ í•˜ê³  ë°˜í™˜í•´ì£¼ë©´ ëœë‹¤.

```java
@Configuration
public class MapperConfig {

    public static final DateTimeFormatter FORMATTER = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");

    @Bean
    public ObjectMapper serializingObjectMapper() {
        ObjectMapper objectMapper = new ObjectMapper();
        JavaTimeModule javaTimeModule = new JavaTimeModule();
        javaTimeModule.addSerializer(LocalDateTime.class, new LocalDateTimeSerializer());
        javaTimeModule.addDeserializer(LocalDateTime.class, new LocalDateTimeDeserializer());
        objectMapper.registerModules(javaTimeModule);
        objectMapper.configure(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS, false);
        return objectMapper;
    }

    public class LocalDateTimeSerializer extends JsonSerializer<LocalDateTime> {

        @Override
        public void serialize(LocalDateTime value, JsonGenerator gen, SerializerProvider serializers) throws IOException {
            gen.writeString(value.format(FORMATTER));
        }
    }

    public class LocalDateTimeDeserializer extends JsonDeserializer<LocalDateTime> {

        @Override
        public LocalDateTime deserialize(JsonParser p, DeserializationContext ctxt) throws IOException {
            return LocalDateTime.parse(p.getValueAsString(), FORMATTER);
        }
    }
}
```

ê·¸ë¦¬ê³ , `CacheConfig`ì—ì„œ `ObjectMapper`ë¥¼ ì£¼ì…í•´ì£¼ë©´ ëœë‹¤.

ì´ì „ ê²Œì‹œê¸€ê³¼ ë¹„êµí–ˆì„ ë•Œ, ì˜ì¡´ì„± ì£¼ì… ë¶€ë¶„ê³¼ `GenericJackson2JsonRedisSerializer`í´ë˜ìŠ¤ íŒŒë¼ë¯¸í„°ë¡œ objectMapperë¥¼ ì£¼ì…í•˜ëŠ” ê²ƒì´ ì¶”ê°€ë˜ì—ˆë‹¤.

```java
@Configuration
public class CacheConfig {

    @Autowired
    ObjectMapper objectMapper;

    private RedisCacheConfiguration defaultCacheConfiguration() {
    return RedisCacheConfiguration
            .defaultCacheConfig()
            .disableCachingNullValues()
            .serializeKeysWith(fromSerializer(new StringRedisSerializer()))
            .serializeValuesWith(fromSerializer(new GenericJackson2JsonRedisSerializer(objectMapper)))
            .entryTtl(Duration.ofDays(1L));
    }
}
```

ğŸš« ì´ë¬ë”ë‹ˆ ì›¬ ê±¸ ë‚ ì§œ íƒ€ì…ì€ í•´ê²°ë˜ê³ , ì´ë²ˆì—” ë‹¤ë¥¸ ì—ëŸ¬ê°€ ë°œìƒí–ˆë‹¤. ArrayListë¥¼ ì§ë ¬í™” í•  ìˆ˜ ì—†ë‹¤ê³  í•œë‹¤...

![image](https://user-images.githubusercontent.com/85394884/230682227-bd43db43-30d5-4a45-8ced-168031a833fd.png)

<br>

### 2. `CacheConfig` ë‚´ì—ì„œ `Custom ObjectMapper` Bean ìƒì„±
---

ë‹¤ìŒ ë°©ë²•ìœ¼ë¡œ, `MapperConfig`ì—†ì´ `CacheConfig`ë‚´ì—ì„œ ê°„ë‹¨í•˜ê²Œ ì‘ì„±í•˜ëŠ” ë°©ì‹ì„ ì‹œë„í•´ë³´ì•˜ë‹¤.

```java
@Bean
public ObjectMapper objectMapper() {

    return new ObjectMapper()
            .findAndRegisterModules()
            .enable(SerializationFeature.INDENT_OUTPUT)
            .disable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS)
            .configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false)
            .registerModule(new JavaTimeModule());
}
```

í•˜ë‚˜ì”© ì‚´í´ë³´ë©´,

`.findAndRegisterModules()`ì—ì„œ `ObjectMapper` í´ë˜ìŠ¤ì˜ ë©”ì„œë“œë¡œ JDK ServiceLoaderì— ì˜í•´ ê¸°ë³¸ì ìœ¼ë¡œ ì œê³µë˜ëŠ” ëª¨ë“ˆë“¤ì„ ì°¾ì•„ ë„£ì–´ì¤€ë‹¤.

`.enable(SerializationFeature.INDENT_OUTPUT)`ì—ì„  JSON í˜•íƒœë¡œ ì €ì¥í•˜ê±°ë‚˜ ì¶œë ¥í•  ë•Œ ì¸ë´íŠ¸ë¥¼ ë§ì¶°ì„œ formatting í•´ì£¼ë„ë¡ í•œë‹¤.

`.disable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS)`ì—ì„  ì•ì„œ ì‚¬ìš©í•œ ê²ƒì²˜ëŸ¼ Dateë¥¼ TimeStamp í˜•ì‹ìœ¼ë¡œ ì§ë ¬í™”í•˜ì§€ ëª»í•˜ê²Œ í•˜ê³ ,

`.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false)`ì—ì„  ì—­ì§ë ¬í™”í•˜ëŠ” ëŒ€ìƒì— ëª¨ë¥´ëŠ” ì†ì„±(í•„ë“œ) ì´ ìˆë”ë¼ë„ ì—­ì§ë ¬í™”ë¥¼ ìˆ˜í–‰í•˜ë¼ëŠ” ì˜ë¯¸ì—ì„œ ì†ì„±ê°’ì— falseë¥¼ ë„£ì–´ì¤€ë‹¤.

ë§ˆì§€ë§‰ìœ¼ë¡œ `.registerModules(new JavaTimeModule())`ì—ì„œ JavaTimeModuleì„ ë„£ì–´ì£¼ì–´ LocalDateTime ì§ë ¬í™”/ì—­ì§ë ¬í™”ê°€ ê°€ëŠ¥í•˜ë„ë¡ í•´ì£¼ê³  ë°˜í™˜í•´ì£¼ë©´ ëœë‹¤.

<br>

ì‘ì„±ì´ ëë‚˜ë©´ `GenericJackson2JsonRedisSerializer`í´ë˜ìŠ¤ íŒŒë¼ë¯¸í„°ë¡œ `objectMapper()`ë¥¼ ì£¼ì…í•˜ëŠ” ê²ƒë§Œ ì¶”ê°€í•´ì£¼ë©´ ëœë‹¤.

```java
@Configuration
public class CacheConfig {

    private RedisCacheConfiguration defaultCacheConfiguration() {
    return RedisCacheConfiguration
            .defaultCacheConfig()
            .disableCachingNullValues()
            .serializeKeysWith(fromSerializer(new StringRedisSerializer()))
            .serializeValuesWith(fromSerializer(new GenericJackson2JsonRedisSerializer(objectMapper())))
            .entryTtl(Duration.ofDays(1L));
    }
```

ğŸš« ì—¬ì „íˆ ArrayListë¥¼ ì§ë ¬í™” í•  ìˆ˜ ì—†ë‹¤ê³  í•œë‹¤...

![image](https://user-images.githubusercontent.com/85394884/230685648-42330c0f-73aa-4fef-b783-48429b8358b3.png)

<br>

### 3. Bean ìƒì„± ì—†ì´ `CacheConfig` ë‚´ì—ì„œ `Custom ObjectMapper` ë©”ì„œë“œ ì‘ì„±
---

ê·¸ë˜ì„œ ì´ë²ˆì—”, Bean ìƒì„± ì—†ì´ `Custom ObjectMapper` ë©”ì„œë“œë¥¼ ì‘ì„±í•´ë´¤ë‹¤.

ë°©ë²•ì€ í¬ê²Œ ë‹¤ë¥´ì§€ ì•Šë‹¤. 

`ObjectMapper` í´ë˜ìŠ¤ì— `JavaTimeModule`ì„ ë“±ë¡í•˜ê³ , `GenericJackson2JsonRedisSerializer` í´ë˜ìŠ¤ íŒŒë¼ë¯¸í„°ë¡œ í•´ë‹¹ `ObjectMapper`ë¥¼ ë„˜ê¸°ëŠ” ì‘ì—…ì´ë‹¤.

```java
@Configuration
public class CacheConfig {

    private RedisCacheConfiguration defaultCacheConfiguration() {
    return RedisCacheConfiguration
            .defaultCacheConfig()
            .disableCachingNullValues()
            .serializeKeysWith(fromSerializer(new StringRedisSerializer()))
            .serializeValuesWith(fromSerializer(new GenericJackson2JsonRedisSerializer(objectMapper())))
            .entryTtl(Duration.ofDays(1L));
    }

    private ObjectMapper objectMapper() {

        PolymorphicTypeValidator typeValidator = BasicPolymorphicTypeValidator.builder()
                .allowIfSubType(Object.class)
                .build();

        return new ObjectMapper()
                .enable(SerializationFeature.INDENT_OUTPUT)
                .disable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS)
                .registerModule(new JavaTimeModule())
                .activateDefaultTyping(typeValidator, ObjectMapper.DefaultTyping.NON_FINAL);
    }
```

âœ… ë“œë””ì–´ ì„±ê³µí–ˆë‹¤...

![image](https://user-images.githubusercontent.com/85394884/230713156-1bcaca5b-c7fd-4dfc-9f3b-04bee7d27799.png)


idê°€ 3ì¸ ìƒí’ˆì„ ìµœì´ˆì— ì¡°íšŒí•˜ë©´ ì¿¼ë¦¬ë¬¸ì´ ë‚˜ì˜¤ë©´ì„œ ì•„ë˜ì™€ ê°™ì´ redisì— ìš°ë¦¬ê°€ ì„¤ì •í•œ ìºì‹± value/key ê°’ìœ¼ë¡œ ì €ì¥ì´ ëœë‹¤.

![image](https://user-images.githubusercontent.com/85394884/230713206-bf1202cf-d058-4534-8293-a4847c7331ab.png)

![image](https://user-images.githubusercontent.com/85394884/230713192-0b7d66f1-6df9-4f08-8206-30646e4b4068.png)

ê·¸ë¦¬ê³  ê·¸ ë‹¤ìŒë²ˆ ì¡°íšŒ ë¶€í„°ëŠ” `@Cacheable` ì–´ë…¸í…Œì´ì…˜ì—ì„œ ë§Œì•½ value/keyì™€ ì¼ì¹˜í•˜ëŠ” ë°ì´í„°ê°€ ìˆë‹¤ë©´ redisì—ì„œ ë°”ë¡œ ì¡°íšŒí•´ì˜¨ë‹¤.

ì¡°íšŒì†ë„ë¥¼ ë¹„êµí•´ë³´ë©´ `1048ms -> 126ms -> 8ms`ë¡œ ëŒ€í­ ê°ì†Œí–ˆìŒì„ ì•Œ ìˆ˜ ìˆë‹¤.

![image](https://user-images.githubusercontent.com/85394884/230713173-7c81ee19-e183-407f-8b4e-07b36891680b.png)

![image](https://user-images.githubusercontent.com/85394884/230713411-6baabc38-6d4f-48f2-9297-9001cea85948.png)

![image](https://user-images.githubusercontent.com/85394884/230713430-79213141-e580-4a64-a020-e90dbbef5a56.png)

<br>

### 4. ë§ˆë¬´ë¦¬
---

ë©”ì„œë“œ ë‚´ìš©ì€ ê°™ê³  Beanì„ ë§Œë“¤ì–´ì„œ ë„£ì–´ì£¼ëŠ” ê²ƒì´ ì™œ ì•ˆë˜ëŠ”ì§€ëŠ” ì•„ì§ ëª…í™•í•˜ê²Œ íŒŒì•…í•˜ì§€ ëª»í–ˆë‹¤.

Bean ìƒì„±ì£¼ê¸°ë‚˜ ì´ëŸ° ê²ƒë“¤ì„ ì¡°ê¸ˆ ë” ê³µë¶€í•´ë´ì•¼ ë  ê²ƒ ê°™ê³ , ObjectMapper í´ë˜ìŠ¤ì— ëŒ€í•´ì„œë„ ì¡°ê¸ˆ ë” ì‚´í´ë´ì•¼ í•  ê²ƒ ê°™ë‹¤.

ì‘ì„±í•œ ë°©ë²•ì€ 3ê°€ì§€ì´ì§€ë§Œ ì‹¤ì œë¡œëŠ” ë¬´ìˆ˜íˆ ë§ì€ ì‹œë„ë¥¼ í–ˆì—ˆë‹¤.

í•˜ì§€ë§Œ ë‹¨ìˆœíˆ Bean ìƒì„± ì—¬ë¶€ì— ë”°ë¼ ê²°ê³¼ê°€ ë‹¬ë¼ì§€ë‹ˆ ì´ìœ ë¥¼ íŒŒì•…í•´ì•¼ í•  ì˜ë¯¸ê°€ ìƒê²¼ë‹¤.

í›„ì— ìˆì„ ê²Œì‹œê¸€ì—ì„œ ì •ë¦¬í•´ë³´ë„ë¡ í•˜ê² ë‹¤.


## References

* [Spring Redis ì—­ì§ë ¬í™” ì‚½ì§ˆê¸° (feat. RedisSerializer)](https://velog.io/@bagt/Redis-%EC%97%AD%EC%A7%81%EB%A0%AC%ED%99%94-%EA%B4%80%EB%A0%A8-%EC%97%90%EB%9F%AC-feat.-RedisSerializer)
* [Cache ì ìš©ìœ¼ë¡œ ì½ê¸° ì„±ëŠ¥ ìµœì í™”í•˜ê¸°](https://velog.io/@bagt/Spring-Cache-%EC%A0%81%EC%9A%A9%EC%9C%BC%EB%A1%9C-%EC%9D%BD%EA%B8%B0-%EC%84%B1%EB%8A%A5-%EC%B5%9C%EC%A0%81%ED%99%94%ED%95%98%EA%B8%B0-2)
* [Redis Cache ì´ìš©í•œ ì„±ëŠ¥ ê°œì„ ](https://hyerin6.github.io/2021-11-11/cache/)
* [Dtoë¡œ Redisì— ì €ì¥í•˜ê³  ì¡°íšŒí•˜ê¸°](https://tape22.tistory.com/25)