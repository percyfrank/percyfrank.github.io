---
title:  "Spring Bootì™€ AWS S3ë¥¼ ì—°ë™í•œ íŒŒì¼ ì—…ë¡œë“œ(3) - MyACADEMY í”„ë¡œì íŠ¸ ì ìš©" 
excerpt: "íŒŒì¼ ì—…ë¡œë“œ, ì‚­ì œ, ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ì„ ì‹¤ì œ í”„ë¡œì íŠ¸ì— ì ìš©í•´ë³´ì."

categories:
  - Springboot
tags:
  - [Springboot, Project]

date: 2023-01-26
last_modified_at: 2023-01-26

---

[ì´ì „ ê²Œì‹œë¬¼](https://percyfrank.github.io/springboot/S302/)ì—ì„  ê°„ë‹¨í•˜ê²Œ Spring Bootì™€ AWS S3ë¥¼ ì—°ë™í•˜ì—¬ íŒŒì¼ ì—…ë¡œë“œë¥¼ ì§„í–‰í–ˆë‹¤.

ê·¸ë˜ì„œ, ì‹¤ì œ ì§„í–‰í•˜ê³  ìˆëŠ” `í•™ì› ê´€ë¦¬ í”„ë¡œì íŠ¸`ì— ì ìš©í•˜ë©´ì„œ ì¶”ê°€ì ìœ¼ë¡œ íŒŒì¼ ì‚­ì œ, ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ê¹Œì§€ ì¶”ê°€í•´ë³´ê² ë‹¤.

ì§€ê¸ˆ ì§„í–‰í•˜ê³  ìˆëŠ” í”„ë¡œì íŠ¸ì—ì„œ íŒŒì¼ ì—…ë¡œë“œ ê¸°ëŠ¥ì„ ì²«ì§¸, í•™ìƒ, ì§ì›, ê°•ì‚¬ë¥¼ ë“±ë¡í•  ë•Œ ì´ë¯¸ì§€ ì—…ë¡œë“œí•  ë•Œì™€

ë‘˜ì§¸, í•™ì› ê³µì§€ì‚¬í•­, ê°•ì¢Œ ê´€ë ¨ íŒŒì¼ë“¤ì„ ì—…ë¡œë“œ í•  ë•Œ í™œìš©í•˜ë ¤ê³  í•œë‹¤.

ğŸš¨ ê·¸ë ‡ê¸° ë•Œë¬¸ì—, ì´ì „ ê²Œì‹œë¬¼ê³¼ëŠ” ë‹¬ë¦¬ ì—…ë¡œë“œ, ì‚­ì œ, ë‹¤ìš´ë¡œë“œë¥¼ í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì¸ì§€ë¥¼ í™•ì¸í•˜ëŠ” ë¶€ë¶„ê¹Œì§€ ì¶”ê°€ë  ê²ƒì´ë‹¤.

ì‹¤ì œë¡œëŠ” í•™ìƒ, ì§ì›, ê°•ì‚¬, í•™ì› ê³µì§€ì‚¬í•­, ê°•ì¢Œì™€ ëŒ€ì‘ë˜ëŠ” ê°ê°ì˜ íŒŒì¼ í…Œì´ë¸”ì„ ë§Œë“¤ì–´ì•¼í•˜ì§€ë§Œ, êµ¬í˜„ ê¸°ëŠ¥ì€ ê±°ì˜ ë˜‘ê°™ê¸°ì— ê°•ì‚¬ì™€ ê´€ë ¨ëœ íŒŒì¼ ì—…ë¡œë“œë¥¼ ì˜ˆì‹œë¡œ ë“¤ì–´ ì§„í–‰í•´ë³´ê² ë‹¤.


### 1. ê¸°ì¡´ ì‚¬ì „ì‘ì—… ìˆ˜ì •
---

ì•ì„œ, Spring Cloud AWSë¥¼ ì‚¬ìš©í•˜ë©´, AmazonS3Client Beanì€ ìë™ ìƒì„±ë˜ê¸° ë•Œë¬¸ì—, ë”°ë¡œ AWS ì„¤ì • ì •ë³´ í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ì£¼ì§€ ì•Šì•„ë„ ëœë‹¤ê³  í–ˆë‹¤.

ê·¸ë˜ì„œ, ê³¼ê°íˆ `AwsConfig.java`íŒŒì¼ì„ ì—†ì• ë„ë¡ í•˜ê² ë‹¤.


ë˜í•œ, í”„ë¡œì íŠ¸ì— ë§ê²Œ ê´€ë¦¬ìš© IAM ì‚¬ìš©ì, ê°œë°œìš© IAM ì‚¬ìš©ì, S3 ë²„í‚·, í´ë” ìƒì„±ì€ ì´ì „ ê²Œì‹œë¬¼ê³¼ ë˜‘ê°™ì´ ìƒì„±í•´ì£¼ë©´ ëœë‹¤. ì—¬ê¸°ì„œëŠ”, ìƒëµí•˜ë„ë¡ í•˜ê² ë‹¤.

### 2. Springboot ì„¤ì •
---

#### 2-1. ìŠ¤í”„ë§ í´ë¼ìš°ë“œ ì˜ì¡´ì„± ì¶”ê°€

ì˜ì¡´ì„± ì¶”ê°€ ë¶€ë¶„ë„ ë‹¤ë¥¸ê²Œ ì—†ë‹¤.

ì¸í…”ë¦¬ì œì´ í•˜ë‹¨ì— Dependenciesë¥¼ í†µí•´ í•´ë‹¹ Springboot í”„ë¡œì íŠ¸ì— ê°€ì¥ ì í•©í•œ ì˜ì¡´ì„± ë²„ì „ì„ ì¶”ê°€í•œë‹¤.

![image](https://user-images.githubusercontent.com/85394884/214575569-376a5599-b1e1-4baf-8915-28af02eacb0d.png)


#### 2-2. application.yml ì„¤ì •

ë‹¤ìŒìœ¼ë¡œ, application.ymlíŒŒì¼ì— ì´ì „ì— ê°œë°œìš© IAM ì‚¬ìš©ìì™€ S3 ë²„í‚·ì„ ìƒì„±í•˜ë©´ì„œ ë°œê¸‰ë°›ì€ ì—‘ì„¸ìŠ¤ í‚¤, ë¹„ë°€ ì—‘ì„¸ìŠ¤ í‚¤, ë²„í‚· ì´ë¦„, ë²„í‚· ë¦¬ì „ì„ ì…ë ¥í•´ì¤€ë‹¤.

ğŸš¨ í•´ë‹¹ ì •ë³´ë“¤ì€ ì™¸ë¶€ì— ê³µê°œë˜ë©´ ì•ˆë˜ë¯€ë¡œ yml íŒŒì¼ì—” ê°€ì§œ ì •ë³´ë¥¼ ì˜¬ë¦¬ê³ , Edit Configurationì„ í†µí•´ í™˜ê²½ë³€ìˆ˜ë¡œ ì…ë ¥í•´ì¤€ë‹¤.

ì—¬ê¸°ì— ë°°í¬ ì„œë²„ URLê³¼ ì„œë²„ íŒ¨ìŠ¤ì›Œë“œ JWT í† í° secretKeyë„ í™˜ê²½ ë³€ìˆ˜ë¡œ ë“¤ì–´ê°€ì•¼ í•˜ì§€ë§Œ í”„ë¡œì íŠ¸ì—ì„œ ë°°í¬ë¥¼ ë‹´ë‹¹í•œ ë¶„ì´ ê³„ì‹œê¸°ì— í”„ë¡œì íŠ¸ ë§ˆë¬´ë¦¬ ì „ì— ì¶”ê°€í•  ê²ƒì´ë‹¤.

```yaml

cloud:
  aws:
    credentials:
      accessKey: ${AWS_ACCESS_KEY_ID}       # AWS IAM AccessKey
      secretKey: ${AWS_SECRET_ACCESS_KEY}   # AWS IAM SecretKey
    s3:
      bucket: bucket    # ë²„í‚· ì´ë¦„
    region:
      static: ap-northeast-2
    stack:
      auto: false

```

![image](https://user-images.githubusercontent.com/85394884/214857952-8e1d6551-6f00-4cf6-b3a5-5b5660bfdc18.png)


#### 2-3. Entity

ê°•ì‚¬ì™€ ì—°ê´€ëœ íŒŒì¼ í…Œì´ë¸”ì´ê¸°ì— ëŒ€ë¶€ë¶„ ê°•ì‚¬ì˜ í”„ë¡œí•„ ì‚¬ì§„ì´ ë“¤ì–´ê°ˆ ê²ƒìœ¼ë¡œ ê³„íší–ˆë‹¤.

ê·¸ë˜ì„œ, í•´ë‹¹ ì—”í‹°í‹° ëª…ì„ `TeacherProfile`ë¡œ ì •í–ˆë‹¤.

ë§ˆì°¬ê°€ì§€ë¡œ, S3 ë²„í‚·ì— ê°™ì€ ì´ë¦„ì˜ íŒŒì¼ì´ ì—…ë¡œë“œë˜ë©´ ë‚˜ì¤‘ì— ë“±ë¡ëœ íŒŒì¼ì´ ë®ì–´ì“°ëŠ” ë¬¸ì œê°€ ìƒê¸´ë‹¤.

ê·¸ë˜ì„œ, S3 ë²„í‚·ì— ì €ì¥ë˜ëŠ” íŒŒì¼ ì´ë¦„ì´ ì¤‘ë³µë˜ì§€ ì•Šë„ë¡ ì €ì¥ëœ íŒŒì¼ì˜ URLì„ ë‚˜íƒ€ë‚´ëŠ” í•„ë“œì¸ `storedFileUrl`ë¥¼ ì¶”ê°€í–ˆë‹¤.

ê·¸ë¦¬ê³  ì‚¬ìš©ìê°€ ì—…ë¡œë“œí•œ íŒŒì¼ ì´ë¦„ì„ ë‚˜íƒ€ë‚´ëŠ” `uploadFileName`í•„ë“œë„ ì¶”ê°€í–ˆë‹¤.

ìµœì´ˆ íŒŒì¼ ì—…ë¡œë“œ ì‹œê°„, ë§ˆì§€ë§‰ ìˆ˜ì • ì‹œê°„, ì‚­ì œ ì‹œê°„ì„ ìœ„í•´ `BaseEntity` í´ë˜ìŠ¤ë¥¼ ìƒì†í–ˆë‹¤.

`Teacher` í…Œì´ë¸”ê³¼ëŠ” 1:N ê´€ê³„ì´ê¸° ë•Œë¬¸ì— Teacher ì™¸ë˜í‚¤ë„ ë§¤í•‘í•´ì£¼ì—ˆë‹¤.

`TeacherProfile.java`

```java

@Entity
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@AllArgsConstructor
@Builder
@Getter
@Table(name = "teacher_profile_tb")
@Where(clause = "deleted_at is NULL")
@SQLDelete(sql = "UPDATE teacher_profile_tb SET deleted_at = current_timestamp WHERE teacher_profile_id = ?")
public class TeacherProfile extends BaseEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "teacher_profile_id")
    private Long id;

    private String uploadFileName;
    private String storedFileUrl;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "teacher_id")
    private Teacher teacher;

    public static TeacherProfile makeTeacherProfile(String uploadFileName, String storedFileUrl, Teacher teacher) {
        return TeacherProfile.builder()
                .uploadFileName(uploadFileName)
                .storedFileUrl(storedFileUrl)
                .teacher(teacher)
                .build();
    }
}
```

#### 2-4. Controller

âœ… íŒŒì¼ ì—…ë¡œë“œë¶€í„° ì‚´í´ë³´ì.

ì¼ë‹¨, í•™ì› ê°œë…ì´ ë“¤ì–´ê°€ê¸° ë•Œë¬¸ì—, academy endpointê°€ ì¶”ê°€ë˜ì—ˆê³ , ì–´ë–¤ ê°•ì‚¬ ë°ì´í„°ì— íŒŒì¼ ì—…ë¡œë“œë¥¼ í• ì§€ì™€ ê´€ë ¨í•´ì„œ teacher endpointë„ ì¶”ê°€ë˜ì—ˆë‹¤.

ë˜í•œ, ì´ëŸ¬í•œ ì‘ì—…ì„ ìˆ˜í–‰í•  ê¶Œí•œì„ í™•ì¸í•˜ê¸° ìœ„í•´ Authenticaton ê°ì²´ë„ íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê²¨ì¤€ë‹¤.

ë§ˆì§€ë§‰ìœ¼ë¡œ, MultipartFile ê°ì²´ë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ë°›ì•„ì™€ì„œ Service Layerì— ìš”ì²­ì„ ì „ë‹¬í•œë‹¤.

âœ… íŒŒì¼ ì‚­ì œ ìš”ì²­ì—ì„  ì¶”ê°€ë¡œ teacherProfileIdë„ endpointë¡œ ì¶”ê°€ë˜ì–´ S3 ë²„í‚·ì—ì„œ íŒŒì¼ì„ ì‚­ì œí•  ë•Œ, TeacherProfile dbì—ì„œë„ soft delete ë˜ê²Œë” êµ¬ì„±í•  ê²ƒì´ë‹¤. 

ë˜í•œ, @RequestParamìœ¼ë¡œ filePathë¥¼ ë„˜ê²¨ì¤„ ê²ƒì¸ë°, ì—¬ê¸°ì„œ filePathëŠ” S3 ë²„í‚·ì˜ í´ë” ì´í•˜ ë””ë ‰í† ë¦¬ë¥¼ ë§í•œë‹¤.

ì—¬ê¸°ì„ , `teacher/ì €ì¥ëœ íŒŒì¼ëª….í™•ì¥ì`ê°€ ë  ê²ƒì´ë‹¤.

âœ… íŒŒì¼ ë‹¤ìš´ë¡œë“œ ìš”ì²­ì—ì„  @RequestParamìœ¼ë¡œ S3 ë²„í‚· í´ë” ì´í•˜ì˜ ë””ë ‰í† ë¦¬ê°€ ì•„ë‹ˆë¼ ì €ì¥ëœ íŒŒì¼ ê°ì²´ì˜ ì „ì²´ URLì„ ë„˜ê²¨ì¤€ë‹¤.

ì—¬ê¸°ì„  String íƒ€ì…ì˜ fileUrlì„ ë§í•œë‹¤. 

ë¬¼ë¡ , Service Layerì—” S3 ë²„í‚· í´ë” ì´í•˜ì˜ ë””ë ‰í† ë¦¬ë¥¼ ì „ë‹¬í•  ê²ƒì´ë‹¤.

`TeacherProfileController.java`

```java
@RestController
@RequiredArgsConstructor
@Slf4j
@RequestMapping("api/v1/academies")
public class TeacherProfileController {

    private final TeacherProfileS3UploadService teacherProfileS3UploadService;

    // S3ì— íŒŒì¼ ì—…ë¡œë“œ
    @PostMapping("/{academyId}/teachers/{teacherId}/files/upload")
    public ResponseEntity<Response<CreateTeacherProfileResponse>> upload(@PathVariable("academyId") Long academyId,
                                                                         @PathVariable("teacherId") Long teacherId,
                                                                         @RequestPart MultipartFile multipartFile,
                                                                         Authentication authentication) throws IOException {
        return ResponseEntity.ok().body(Response.success(teacherProfileS3UploadService.UploadTeacherProfile(academyId, teacherId, multipartFile, authentication.getName())));
    }


    // S3 íŒŒì¼ ì‚­ì œ
    @DeleteMapping("/{academyId}/teachers/{teacherId}/teacherProfiles/{teacherProfileId}/files")
    public ResponseEntity<Response<DeleteTeacherProfileResponse>> delete(@PathVariable("academyId") Long academyId,
                                                                         @PathVariable("teacherId") Long teacherId,
                                                                         @PathVariable("teacherProfileId") Long teacherProfileId,
                                                                         @RequestParam String filePath,
                                                                         Authentication authentication) {
        return ResponseEntity.ok().body(Response.success(teacherProfileS3UploadService.deleteTeacherProfile(academyId, teacherId, teacherProfileId, filePath, authentication.getName())));
    }

    // S3 íŒŒì¼ ë‹¤ìš´ë¡œë“œ
    @GetMapping("/{academyId}/teachers/{teacherId}/files/download")
    public ResponseEntity<byte[]> download(@PathVariable("academyId") Long academyId,
                                           @PathVariable("teacherId") Long teacherId,
                                           @RequestParam String fileUrl,
                                           Authentication authentication) throws IOException {
        // ë²„í‚· í´ë” ì´í•˜ ê²½ë¡œ
        String filePath = fileUrl.substring(52);
        log.info("filePath : {}", filePath);
        return teacherProfileS3UploadService.downloadTeacherProfile(academyId, teacherId, filePath, authentication.getName());
    }

}
```

#### 2-5. Service 

Service ì½”ë“œì—ì„  ë©”ì„œë“œ ë³„ë¡œ ë‚˜ëˆ ì„œ ì‚´í´ë³´ê² ë‹¤.


**1. ì—…ë¡œë“œ**

ì—…ë¡œë“œ í•  ë•Œ, ë¹ˆ íŒŒì¼ì„ ì²¨ë¶€í•˜ê±°ë‚˜, íŒŒì¼ì„ ì²¨ë¶€í•´ë„ íŒŒì¼ ì•ˆì— ë‚´ìš©ì´ ì—†ëŠ” ê²½ìš° `FILE_NOT_EXISTS`ì—ëŸ¬ë¥¼ ë°œìƒí•˜ë„ë¡ `validateFileExists()` ë©”ì„œë“œë¡œ ê²€ì¦í•œë‹¤.

ë‹¤ìŒìœ¼ë¡ , í•™ì› ì¡´ì¬ ìœ ë¬´ì™€ ì—…ë¡œë“œ ì§„í–‰í•˜ëŠ” ì§ì›ì´ í•´ë‹¹ í•™ì› ì†Œì†ì¸ì§€, ê·¸ë¦¬ê³  ê·¸ ì§ì›ì´ ì—…ë¡œë“œí•  ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.

íŒŒì¼ ì—…ë¡œë“œ ëŒ€ìƒì¸ ê°•ì‚¬ì˜ ì¡´ì¬ ìœ ë¬´ë„ í™•ì¸í•œë‹¤.

ğŸš¨ ì´ì œ íŒŒì¼ ì—…ë¡œë“œì™€ ê´€ë ¨ëœ ì½”ë“œë“¤ì„ ì„¤ëª…í•´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì§„í–‰ëœë‹¤.

- ObjectMetadata ê°ì²´ì— content-lengthì™€ sizeë¥¼ ì§€ì •í•œë‹¤. ì§€ì •í•˜ì§€ ì•Šìœ¼ë©´ warning ë¡œê·¸ ë°œìƒí•œë‹¤.
- íŒŒì¼ ì´ë¦„ê³¼ UUIDë¡œ ìƒì„±í•œ ëœë¤ ê°’ì„ í•©ì³ì„œ S3ì— ì €ì¥ë  íŒŒì¼ ì´ë¦„ì„ ë§Œë“ ë‹¤.
- ê·¸ë¦¬ê³ , í•´ë‹¹ íŒŒì¼ì„ S3 ë²„í‚·ì˜ teacher í´ë”ì— ì €ì¥ë˜ë„ë¡ í•œë‹¤.
- ë²„í‚·, ì €ì¥í•  ë””ë ‰í† ë¦¬ + íŒŒì¼ì´ë¦„ ë“±ì˜ ë°ì´í„°ì™€ ë©”íƒ€ë°ì´í„°ë¥¼ AmazonS3Client Beanì— ì£¼ì…í•˜ê³ , `withCannedAcl` ë©”ì„œë“œë¥¼ í†µí•´ ì—…ë¡œë“œí•œ íŒŒì¼ì„ ëª¨ë‘ê°€ ì½ì„ ìˆ˜ ìˆê²Œ ì„¤ì •í•œë‹¤.
- ë§ˆì§€ë§‰ìœ¼ë¡œ, `getUrl` ë©”ì„œë“œë¥¼ í†µí•´ S3ì— ì—…ë¡œë“œëœ íŒŒì¼ URLê³¼ íŒŒì¼ ì—…ë¡œë“œ ì‹œ íŒŒì¼ ëª…, ê·¸ë¦¬ê³  ì–´ë–¤ ê°•ì‚¬ì™€ ê´€ë ¨ëœ íŒŒì¼ ì—…ë¡œë“œì¸ì§€ë¥¼ `makeTeacherProfile()` ë©”ì„œë“œë¥¼ í†µí•´ ì €ì¥í•˜ê³  ì´ë¥¼ `TeacherProfile` dbì— ì €ì¥í•œë‹¤.

```java
@Service
@RequiredArgsConstructor
@Slf4j
@Transactional
public class TeacherProfileS3UploadService {

    private final AmazonS3Client amazonS3Client;
    private final AcademyRepository academyRepository;
    private final EmployeeRepository employeeRepository;
    private final TeacherRepository teacherRepository;
    private final TeacherProfileRepository teacherProfileRepository;

    @Value("${cloud.aws.s3.bucket}")
    private String bucket;

    public CreateTeacherProfileResponse UploadTeacherProfile(Long academyId, Long teacherId, MultipartFile multipartFile, String account) throws IOException {

        // íŒŒì¼ì´ ë“¤ì–´ìˆëŠ”ì§€ í™•ì¸
        validateFilExists(multipartFile);
        // í•™ì› ì¡´ì¬ ìœ ë¬´ í™•ì¸
        Academy academy = validateAcademy(academyId);
        // ì—…ë¡œë“œë¥¼ ì§„í–‰í•˜ëŠ” ì§ì›ì´ í•´ë‹¹ í•™ì› ì†Œì† ì§ì›ì¸ì§€ í™•ì¸
        Employee employee = validateAcademyEmployee(account, academy);

        // ì§ì›ì´ íŒŒì¼ ì—…ë¡œë“œí•  ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸(ê°•ì‚¬ë§Œ ë¶ˆê°€ëŠ¥)
        if(Employee.isTeacherAuthority(employee)) {
            throw new AppException(ErrorCode.INVALID_PERMISSION);
        }

        // í”„ë¡œí•„ ì‚¬ì§„ ëŒ€ìƒì¸ ê°•ì‚¬ ì¡´ì¬ ìœ ë¬´ í™•ì¸
        Teacher teacher = validateTeacher(teacherId);

        ObjectMetadata objectMetadata = new ObjectMetadata();
        objectMetadata.setContentType(multipartFile.getContentType());
        objectMetadata.setContentLength(multipartFile.getSize());

        String originalFilename = multipartFile.getOriginalFilename();
        int index = originalFilename.lastIndexOf(".");
        String ext = originalFilename.substring(index + 1);

        // ì €ì¥ë  íŒŒì¼ ì´ë¦„
        String storeFileName = UUID.randomUUID() + "." + ext;

        // ì €ì¥í•  ë””ë ‰í† ë¦¬ ê²½ë¡œ + íŒŒì¼ ì´ë¦„
        String key = "teacher/" + storeFileName;

        try (InputStream inputStream = multipartFile.getInputStream()) {
            amazonS3Client.putObject(new PutObjectRequest(bucket, key, inputStream, objectMetadata)
                    .withCannedAcl(CannedAccessControlList.PublicRead));
        } catch (IOException e) {
            throw new FileUploadException();
        }

        String storeFileUrl = amazonS3Client.getUrl(bucket, key).toString();
        TeacherProfile teacherProfile = TeacherProfile.makeTeacherProfile(originalFilename, storeFileUrl, teacher);
        TeacherProfile savedFile = teacherProfileRepository.save(teacherProfile);

        log.info("íŒŒì¼ ë“±ë¡ ì™„ë£Œ");
        return CreateTeacherProfileResponse.of(savedFile);
    }

    private Academy validateAcademy(Long academyId) {
        // í•™ì› ì¡´ì¬ ìœ ë¬´ í™•ì¸
        Academy validatedAcademy = academyRepository.findById(academyId)
                .orElseThrow(() -> new AppException(ErrorCode.ACADEMY_NOT_FOUND));
        return validatedAcademy;
    }

    private Employee validateAcademyEmployee(String account, Academy academy) {
        // í•´ë‹¹ í•™ì› ì†Œì† ì§ì› ë§ëŠ”ì§€ í™•ì¸
        Employee employee = employeeRepository.findByAccountAndAcademy(account, academy)
                .orElseThrow(() -> new AppException(ErrorCode.ACCOUNT_NOT_FOUND));
        return employee;
    }

    private Teacher validateTeacher(Long teacherId) {
        Teacher validatedTeacher = teacherRepository.findById(teacherId)
                .orElseThrow(() -> new AppException(ErrorCode.TEACHER_NOT_FOUND));
        return validatedTeacher;
    }

    // ë¹ˆ íŒŒì¼ì´ ì•„ë‹Œì§€ í™•ì¸, íŒŒì¼ ìì²´ë¥¼ ì²¨ë¶€ì•ˆí•˜ê±°ë‚˜ ì²¨ë¶€í•´ë„ ë‚´ìš©ì´ ë¹„ì–´ìˆìœ¼ë©´ ì—ëŸ¬ ì²˜ë¦¬
    private void validateFilExists(MultipartFile multipartFile) {
        if (multipartFile.isEmpty()) {
            throw new AppException(ErrorCode.FILE_NOT_EXISTS);
        }
    }
}
```

**2. ì‚­ì œ**

ì‚­ì œ ë¶€ë¶„ë„ ë§ˆì°¬ê°€ì§€ë¡œ, í•™ì›, ì§ì›, ê°•ì‚¬ì˜ ì¡´ì¬ ìœ ë¬´ë¥¼ í™•ì¸í•˜ê³ , ì§ì›ì˜ ê¶Œí•œë„ í™•ì¸í•œ ë’¤, ì €ì¥ëœ íŒŒì¼ì´ ìˆëŠ”ì§€ë„ í™•ì¸í•œë‹¤.

ğŸš¨ ë‹¤ìŒìœ¼ë¡œ, `try-catch` êµ¬ë¬¸ì—ì„œ `deleteObject` ë©”ì„œë“œë¥¼ ì´ìš©í•´ S3 ì—…ë¡œë“œ íŒŒì¼ì„ ì‚­ì œí•œë‹¤.

í•´ë‹¹ ì—…ë¡œë“œ íŒŒì¼ì„ `TeacherProfile` dbì—ì„œë„ ê°™ì´ soft delete ì‹œì¼œì¤€ë‹¤. 

```java
@Service
@RequiredArgsConstructor
@Slf4j
@Transactional
public class TeacherProfileS3UploadService {

    private final AmazonS3Client amazonS3Client;
    private final AcademyRepository academyRepository;
    private final EmployeeRepository employeeRepository;
    private final TeacherRepository teacherRepository;
    private final TeacherProfileRepository teacherProfileRepository;

    @Value("${cloud.aws.s3.bucket}")
    private String bucket;

    public DeleteTeacherProfileResponse deleteTeacherProfile(Long academyId, Long teacherId, Long teacherProfileId, String filePath, String account) {

        // í•™ì› ì¡´ì¬ ìœ ë¬´ í™•ì¸
        Academy academy = validateAcademy(academyId);

        // íŒŒì¼ ì‚­ì œë¥¼ ì§„í–‰í•˜ëŠ” ì§ì›ì´ í•´ë‹¹ í•™ì› ì†Œì† ì§ì›ì¸ì§€ í™•ì¸
        Employee employee = validateAcademyEmployee(account, academy);

        // ì§ì›ì´ íŒŒì¼ ì—…ë¡œë“œí•  ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸(ê°•ì‚¬ë§Œ ë¶ˆê°€ëŠ¥)
        if(Employee.isTeacherAuthority(employee)) {
            throw new AppException(ErrorCode.INVALID_PERMISSION);
        }

        // í”„ë¡œí•„ ì‚¬ì§„ ëŒ€ìƒì¸ ê°•ì‚¬ ì¡´ì¬ ìœ ë¬´ í™•ì¸
        validateTeacher(teacherId);

        // íŒŒì¼ ì¡´ì¬ ìœ ë¬´ í™•ì¸
        TeacherProfile teacherProfile = validateTeacherProfile(teacherProfileId);

        try {
            // S3 ì—…ë¡œë“œ íŒŒì¼ ì‚­ì œ
            amazonS3Client.deleteObject(new DeleteObjectRequest(bucket, filePath));
            // í•´ë‹¹ ì—…ë¡œë“œ íŒŒì¼ í…Œì´ë¸”ì—ì„œë„ ê°™ì´ ì‚­ì œ
            teacherProfileRepository.delete(teacherProfile);
            log.info("íŒŒì¼ ì‚­ì œ ì„±ê³µ");
        } catch (AmazonServiceException e) {
            e.printStackTrace();
        } catch (SdkClientException e) {
            e.printStackTrace();
        }
        return DeleteTeacherProfileResponse.of(employee);
    }

    private Academy validateAcademy(Long academyId) {
        // í•™ì› ì¡´ì¬ ìœ ë¬´ í™•ì¸
        Academy validatedAcademy = academyRepository.findById(academyId)
                .orElseThrow(() -> new AppException(ErrorCode.ACADEMY_NOT_FOUND));
        return validatedAcademy;
    }

    private Employee validateAcademyEmployee(String account, Academy academy) {
        // í•´ë‹¹ í•™ì› ì†Œì† ì§ì› ë§ëŠ”ì§€ í™•ì¸
        Employee employee = employeeRepository.findByAccountAndAcademy(account, academy)
                .orElseThrow(() -> new AppException(ErrorCode.ACCOUNT_NOT_FOUND));
        return employee;
    }

    private Teacher validateTeacher(Long teacherId) {
        Teacher validatedTeacher = teacherRepository.findById(teacherId)
                .orElseThrow(() -> new AppException(ErrorCode.TEACHER_NOT_FOUND));
        return validatedTeacher;
    }

    private TeacherProfile validateTeacherProfile(Long teacherProfileId) {
        TeacherProfile validatedteacherProfile = teacherProfileRepository.findById(teacherProfileId)
                .orElseThrow(() -> new AppException(ErrorCode.TEACHER_PROFILE_NOT_FOUND));
        return validatedteacherProfile;
    }
}
```

**3. ë‹¤ìš´ë¡œë“œ**

ë‹¤ìš´ë¡œë“œë„ ë§ˆì°¬ê°€ì§€ë¡œ, í•™ì›, ì§ì›, ê°•ì‚¬ì˜ ì¡´ì¬ ìœ ë¬´ë¥¼ í™•ì¸í•˜ì§€ë§Œ, ë‹¤ìš´ë¡œë“œëŠ” ëª¨ë“  ì§ì›ì´ ê°€ëŠ¥í•˜ê¸° ë•Œë¬¸ì— ì§ì›ì˜ ê¶Œí•œì„ í™•ì¸í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.

ğŸš¨ ë‹¤ìš´ë¡œë“œì™€ ê´€ë ¨ëœ ì½”ë“œë“¤ì„ ì„¤ëª…í•´ë³´ë©´,

- S3 ê°ì²´ë¥¼ ì¶”ì¶œí•´ì„œ byte ë°°ì—´ë¡œ ë³€í™˜ì„ ì‹œì¼œì¤€ë‹¤.
- `contentType` ë©”ì„œë“œë¥¼ í†µí•´ ì €ì¥ëœ íŒŒì¼ì„ í™•ì¥ì ë³„ë¡œ êµ¬ë¶„í•˜ì—¬ ì „ì†¡ í—¤ë”ì˜ í™•ì¥ìë¡œ ë„£ì–´ì¤€ë‹¤.
- byte ë°°ì—´ì˜ ê¸¸ì´ë¥¼ ì „ì†¡ í—¤ë”ì˜ contentLengthì— ì…ë ¥í•œë‹¤.
- ë‹¤ìŒìœ¼ë¡œ, íŒŒë¼ë¯¸í„°ë¡œ ë°›ì€ fileUrl, ì¦‰, S3 ë²„í‚· í´ë” ì´í•˜ì˜ ê²½ë¡œì—ì„œ `bucketFolder` ë³€ìˆ˜ì— `/`ë¥¼ êµ¬ë¶„ìë¡œ S3 ë²„í‚· í´ë”ì™€ ì €ì¥ëœ íŒŒì¼ ëª…ì„ ì €ì¥í•œë‹¤.
- íŒŒì¼ ëª…ì„ ì¶”ì¶œí•˜ê³ , ì¸ì½”ë”©í•œ ë’¤ì— `setContentDispositionFormData()` ë©”ì„œë“œë¥¼ í†µí•´ ì „ì†¡ í—¤ë”ì˜ íŒŒì¼ëª…ìœ¼ë¡œ ì„¸íŒ…í•œë‹¤.


```java
@Service
@RequiredArgsConstructor
@Slf4j
@Transactional
public class TeacherProfileS3UploadService {

    private final AmazonS3Client amazonS3Client;
    private final AcademyRepository academyRepository;
    private final EmployeeRepository employeeRepository;
    private final TeacherRepository teacherRepository;
    private final TeacherProfileRepository teacherProfileRepository;

    @Value("${cloud.aws.s3.bucket}")
    private String bucket;

    public ResponseEntity<byte[]> downloadTeacherProfile(Long academyId, Long teacherId, String fileUrl, String account) throws IOException {

        // í•™ì› ì¡´ì¬ ìœ ë¬´ í™•ì¸
        Academy academy = validateAcademy(academyId);

        // ì—…ë¡œë“œë¥¼ ì§„í–‰í•˜ëŠ” ì§ì›ì´ í•´ë‹¹ í•™ì› ì†Œì† ì§ì›ì¸ì§€ í™•ì¸
        validateAcademyEmployee(account, academy);

        // í”„ë¡œí•„ ì‚¬ì§„ ëŒ€ìƒì¸ ê°•ì‚¬ ì¡´ì¬ ìœ ë¬´ í™•ì¸
        validateTeacher(teacherId);

        // S3 ê°ì²´ ì¶”ì¶œí•´ì„œ byte ë°°ì—´ë¡œ ë³€í™˜
        S3Object s3Object = amazonS3Client.getObject(new GetObjectRequest(bucket, fileUrl));
        S3ObjectInputStream s3ObjectInputStream = s3Object.getObjectContent();
        byte[] bytes = IOUtils.toByteArray(s3ObjectInputStream);

        HttpHeaders httpHeaders = new HttpHeaders();
        httpHeaders.setContentType(contentType(fileUrl));
        httpHeaders.setContentLength(bytes.length);

        // ë²„í‚· í´ë” ì¶”ì¶œ
        String[] bucketFolder = fileUrl.split("/");
        log.info("bucketFolder : {}", bucketFolder);

        // ë²„í‚· í´ë”ì— ì €ì¥ëœ í•´ë‹¹ íŒŒì¼ëª… ì¶”ì¶œ
        String fileName = bucketFolder[bucketFolder.length - 1];
        log.info("fileName : {}", fileName);

        // ì¸ì½”ë”©
        String encodedFileName = URLEncoder.encode(fileName, "UTF-8").replaceAll("\\+", "%20");
        log.info("encodedFileName : {}", encodedFileName);

        httpHeaders.setContentDispositionFormData("attachment",encodedFileName);

        return new ResponseEntity<>(bytes, httpHeaders, HttpStatus.OK);
    }

    private Academy validateAcademy(Long academyId) {
        // í•™ì› ì¡´ì¬ ìœ ë¬´ í™•ì¸
        Academy validatedAcademy = academyRepository.findById(academyId)
                .orElseThrow(() -> new AppException(ErrorCode.ACADEMY_NOT_FOUND));
        return validatedAcademy;
    }

    private Employee validateAcademyEmployee(String account, Academy academy) {
        // í•´ë‹¹ í•™ì› ì†Œì† ì§ì› ë§ëŠ”ì§€ í™•ì¸
        Employee employee = employeeRepository.findByAccountAndAcademy(account, academy)
                .orElseThrow(() -> new AppException(ErrorCode.ACCOUNT_NOT_FOUND));
        return employee;
    }

    private Teacher validateTeacher(Long teacherId) {
        Teacher validatedTeacher = teacherRepository.findById(teacherId)
                .orElseThrow(() -> new AppException(ErrorCode.TEACHER_NOT_FOUND));
        return validatedTeacher;
    }

    // ë¹ˆ íŒŒì¼ì´ ì•„ë‹Œì§€ í™•ì¸, íŒŒì¼ ìì²´ë¥¼ ì²¨ë¶€ì•ˆí•˜ê±°ë‚˜ ì²¨ë¶€í•´ë„ ë‚´ìš©ì´ ë¹„ì–´ìˆìœ¼ë©´ ì—ëŸ¬ ì²˜ë¦¬
    private void validateFilExists(MultipartFile multipartFile) {
        if (multipartFile.isEmpty()) {
            throw new AppException(ErrorCode.FILE_NOT_EXISTS);
        }
    }

    // ì €ì¥ëœ íŒŒì¼ í™•ì¥ì ë³„ë¡œ êµ¬ë¶„í•˜ì—¬ ì €ì¥
    private MediaType contentType(String keyname) {
        String[] arr = keyname.split("\\.");
        log.info("arr : {}", arr);
        String fileExtension = arr[arr.length - 1];
        switch (fileExtension) {
            case "txt":
                return MediaType.TEXT_PLAIN;
            case "png":
                return MediaType.IMAGE_PNG;
            case "jpg":
                return MediaType.IMAGE_JPEG;
            default:
                return MediaType.APPLICATION_OCTET_STREAM;
        }
    }
}
```

#### 2-6. ErrorCode, ExceptionManager, íŒŒì¼ ì—…ë¡œë“œ, ì‚­ì œ ë°˜í™˜ DTO

`ErrorCode`

```java
TEACHER_PROFILE_NOT_FOUND(HttpStatus.NOT_FOUND, "í•´ë‹¹ ê°•ì‚¬ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."),
FILE_NOT_EXISTS(HttpStatus.BAD_REQUEST, "ë³´ë‚¼ íŒŒì¼ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤."),
FILE_SIZE_EXCEED(HttpStatus.BAD_REQUEST, "íŒŒì¼ ì—…ë¡œë“œ ìš©ëŸ‰ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.")
```

`ExceptionManager.java`

`application.yml`ì— ì„¤ì •í•œ 10MB ìš©ëŸ‰ì´ ë„˜ëŠ” íŒŒì¼ì„ ì—…ë¡œë“œ í•  ì‹œ, `FILE_SIZE_EXCEED` ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚¤ë„ë¡ í–ˆë‹¤.

```java
    /**
     * íŒŒì¼ ì—…ë¡œë“œ ìš©ëŸ‰ ì´ˆê³¼ì‹œ ë°œìƒ
     */
    @ExceptionHandler(MaxUploadSizeExceededException.class)
    protected ResponseEntity<?> handleMaxUploadSizeExceededException(MaxUploadSizeExceededException e) {
        log.info("handleMaxUploadSizeExceededException", e);
        ErrorResponse errorResponse = new ErrorResponse(ErrorCode.FILE_SIZE_EXCEED);
        return ResponseEntity.status(errorResponse.getErrorCode().getHttpStatus())
                .body(Response.error("ERROR", errorResponse));
    }

```

`CreateTeacherProfileResponse.java`

ì—…ë¡œë“œ ì‹œ ì„±ê³µ ë©”ì„¸ì§€ì™€ í•¨ê»˜ ì—…ë¡œë“œ í•œ íŒŒì¼ì˜ ì´ë¦„ì„ ë°˜í™˜í•œë‹¤.

```java
@NoArgsConstructor
@AllArgsConstructor
@Getter
@Builder
public class CreateTeacherProfileResponse {

    private String uploadFileName;
    private String message;

    public static CreateTeacherProfileResponse of(TeacherProfile profileImages) {
        return CreateTeacherProfileResponse.builder()
                .uploadFileName(profileImages.getUploadFileName())
                .message("íŒŒì¼ ì²¨ë¶€ ì™„ë£Œ")
                .build();
    }
}

```

`DeleteTeacherProfileResponse.java`

ì‚­ì œ ì‹œ, ì„±ê³µ ë©”ì„¸ì§€ì™€ í•¨ê»˜ ì‚­ì œ ì‘ì—…ì„ ì§„í–‰í•œ ì§ì›ì„ ë°˜í™˜í•œë‹¤.
```java
@NoArgsConstructor
@AllArgsConstructor
@Getter
@Builder
public class DeleteTeacherProfileResponse {

    private Long deletedEmployee;
    private String message;

    public static DeleteTeacherProfileResponse of(Employee employee) {
        return DeleteTeacherProfileResponse.builder()
                .deletedEmployee(employee.getId())
                .message("ì‚­ì œ ì„±ê³µ")
                .build();
    }
}

```

### 3. ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸

#### íŒŒì¼ ì—…ë¡œë“œ

png íŒŒì¼ ì—…ë¡œë“œ ìš”ì²­ì„ ë³´ëƒˆë”ë‹ˆ, ì„±ê³µì ìœ¼ë¡œ S3 ë²„í‚·ê³¼ `TeacherProfile` dbì— ì˜ ì €ì¥ë˜ì—ˆë‹¤.

![image](https://user-images.githubusercontent.com/85394884/214874165-f1ff874f-0002-4c89-a28b-11e6c9888d75.png)

![image](https://user-images.githubusercontent.com/85394884/214874508-f3484272-8731-420b-87a7-acad826eb2c7.png)

![image](https://user-images.githubusercontent.com/85394884/214874741-1bb816d8-f5eb-46e2-b4cc-60b2f95ab751.png)


#### íŒŒì¼ ë‹¤ìš´ë¡œë“œ

ë°©ê¸ˆ ì—…ë¡œë“œí•œ png íŒŒì¼ ë‹¤ìš´ë¡œë“œ ìš”ì²­ì„ ë³´ëƒˆë‹¤.

ì•„ë˜ì˜ ê°ì²´ URLì„ ê·¸ëŒ€ë¡œ `fileUrl`ì˜ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•œë‹¤.

![image](https://user-images.githubusercontent.com/85394884/214875393-1e395094-6145-455e-8908-cab8bfb93aaf.png)

ì—…ë¡œë“œí•œ ì‚¬ì§„ì´ ë‚˜ì™”ë‹¤. ë‚˜ì¤‘ì— í”„ë¡ íŠ¸ë¥¼ êµ¬í˜„í•˜ë©´ ë‹¤ìš´ë¡œë“œ ë˜ê²Œ ë§Œë“¤ê² ë‹¤.

![image](https://user-images.githubusercontent.com/85394884/214875620-12c41fbf-49b2-46bd-8f9d-d7fb11270aa4.png)


#### íŒŒì¼ ì‚­ì œ

ë¡œê³  ì‚¬ì§„ì„ ì‚­ì œí•´ë³´ê² ë‹¤.

S3 ë²„í‚· í´ë” ì´í•˜ì˜ ë””ë ‰í† ë¦¬ ê²½ë¡œë¥¼ `filePath`ì˜ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•œë‹¤.

ì•„ë˜ ì‚¬ì§„ì„ ë³´ë©´, S3 ë²„í‚·ì—ì„œë„ ë”ì´ìƒ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•Šê³ , `TeacherProfile` dbì—ì„œë„ soft delete ë˜ì—ˆë‹¤.

![image](https://user-images.githubusercontent.com/85394884/214876706-88a9cdac-cd5f-4594-9613-fc557bd77133.png)

![image](https://user-images.githubusercontent.com/85394884/214876627-d282c2c8-016a-4df5-98d6-79533cbdc5c6.png)

![image](https://user-images.githubusercontent.com/85394884/214876792-4280375c-20d5-47b2-a289-d5c77a013e0c.png)

![image](https://user-images.githubusercontent.com/85394884/214876918-7909eb3a-9fa2-45fd-b42b-f7ff48243402.png)


ì´ë ‡ê²Œ, ì‹¤ì œ ì§„í–‰í•˜ê³  ìˆëŠ” í”„ë¡œì íŠ¸ì— íŒŒì¼ ì—…ë¡œë“œ, ì‚­ì œ, ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ì„ ì ì ˆíˆ ì ìš©í•´ë³´ì•˜ë‹¤.

í•˜ë‚˜ì˜ íŒŒì¼ ì—”í‹°í‹°ì—ì„œ ê´€ë¦¬í•˜ë©´ ì¢‹ê² ì§€ë§Œ, ê·¸ë ‡ê²Œ ë˜ë©´ íŒŒì¼ì´ ì„ì´ê²Œ ë˜ì–´ ê´€ë¦¬í•˜ê¸°ê°€ ë³µì¡í•˜ê¸°ë„ í•˜ê³  ì—°ê´€ê´€ê³„ ë§¤í•‘ ì‹œ ì™¸ë˜í‚¤ì— nullê°’ì´ ë“¤ì–´ê°ˆ ìˆ˜ ìˆì–´ ê¶Œì¥í•˜ì§€ ì•ŠëŠ”ë‹¤.

ë”°ë¼ì„œ, í•™ìƒ, ì§ì›, ê³µì§€ì‚¬í•­, ê°•ì¢Œì™€ ê´€ë ¨ëœ íŒŒì¼ ì—”í‹°í‹°ë¥¼ ì¶”ê°€ì ìœ¼ë¡œ ë§Œë“¤ë©´ ë˜ê² ë‹¤.

ì¶”ê°€ì ìœ¼ë¡œ, ë‹¤ìŒ ê²Œì‹œë¬¼ì—ì„  íŒŒì¼ ì—…ë¡œë“œ ë¶€ë¶„ì„ ì—¬ëŸ¬ íŒŒì¼ì„ í•œêº¼ë²ˆì— ì˜¬ë¦´ ìˆ˜ ìˆë„ë¡ í•´ë³´ê² ë‹¤.


<br>

---

## References

* [SpringBoot & AWS S3 ì—°ë™í•˜ê¸°](https://jojoldu.tistory.com/300)
* [Spring Bootì™€ S3ë¥¼ ì—°ë™í•œ íŒŒì¼ ì—…ë¡œë“œ](https://velog.io/@louie/S3%EB%A5%BC-%EC%97%B0%EB%8F%99%ED%95%9C-%ED%8C%8C%EC%9D%BC-%EC%97%85%EB%A1%9C%EB%93%9C)
* [Springbootë¡œ S3 íŒŒì¼ ì—…ë¡œë“œí•˜ê¸°](https://www.sunny-son.space/spring/Springboot%EB%A1%9C%20S3%20%ED%8C%8C%EC%9D%BC%20%EC%97%85%EB%A1%9C%EB%93%9C/)
* [AWS S3 ë²„í‚· íŒŒì¼ ì—…ë¡œë“œ, ì‚­ì œ, ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ êµ¬í˜„](https://green-joo.tistory.com/2)
* [[Spring] - Spring Boot + AWS S3ë¥¼ ì´ìš©í•˜ì—¬ ì´ë¯¸ì§€ ì¡°íšŒ/ë“±ë¡/ì‚­ì œ ë° accessKey, secretKey, butket ê°’ì„ ì™¸ë¶€ì—ì„œ ê´€ë¦¬í•˜ê¸°](https://kim-jong-hyun.tistory.com/78)