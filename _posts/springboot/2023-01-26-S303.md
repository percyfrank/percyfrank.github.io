---
title:  "Spring Bootì™€ AWS S3ë¥¼ ì—°ë™í•œ íŒŒì¼ ì—…ë¡œë“œ(3) - MyACADEMY í”„ë¡œì íŠ¸ ì ìš©(ë‹¨ì¼ íŒŒì¼ ì—…ë¡œë“œ)" 
excerpt: "íŒŒì¼ ì—…ë¡œë“œ, ì‚­ì œ, ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ì„ ì‹¤ì œ í”„ë¡œì íŠ¸ì— ì ìš©"

categories:
  - Springboot
tags:
  - [Springboot, Project]

date: 2023-01-26
last_modified_at: 2023-01-26

---

[ì´ì „ ê²Œì‹œë¬¼](https://percyfrank.github.io/springboot/S302/)ì—ì„  ê°„ë‹¨í•˜ê²Œ Spring Bootì™€ AWS S3ë¥¼ ì—°ë™í•˜ì—¬ íŒŒì¼ ì—…ë¡œë“œë¥¼ ì§„í–‰í–ˆë‹¤.

ê·¸ë˜ì„œ, ì‹¤ì œ ì§„í–‰í•˜ê³  ìˆëŠ” `í•™ì› ê´€ë¦¬ í”„ë¡œì íŠ¸`ì— ì ìš©í•˜ë©´ì„œ ì¶”ê°€ì ìœ¼ë¡œ íŒŒì¼ ì‚­ì œ, ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ê¹Œì§€ ì¶”ê°€í•´ë³´ê² ë‹¤.

ì§€ê¸ˆ ì§„í–‰í•˜ê³  ìˆëŠ” í”„ë¡œì íŠ¸ì—ì„œ íŒŒì¼ ê´€ë ¨ ê¸°ëŠ¥ì€ ì§ì›ì˜ í”„ë¡œí•„ ì‚¬ì§„ì„ ë“±ë¡í•  ë•Œì™€ í•™ì› ê³µì§€ì‚¬í•­ ë“±ë¡ ì‹œ ì²¨ë¶€íŒŒì¼ ì—…ë¡œë“œë¥¼ í•  ë•Œ ì‚¬ìš©ëœë‹¤.

ğŸš¨ ê·¸ë ‡ê¸° ë•Œë¬¸ì—, ì´ì „ ê²Œì‹œë¬¼ê³¼ëŠ” ë‹¬ë¦¬ ì—…ë¡œë“œ, ì‚­ì œ, ë‹¤ìš´ë¡œë“œë¥¼ í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì¸ì§€ë¥¼ í™•ì¸í•˜ëŠ” ë¶€ë¶„ê¹Œì§€ ì¶”ê°€ë  ê²ƒì´ë‹¤.

ë˜í•œ, ì´ë²ˆ ê²Œì‹œë¬¼ì€ ì§ì› í”„ë¡œí•„ê³¼ ê´€ë ¨í•˜ì—¬ ì§„í–‰í•  ê²ƒì´ë‹¤. 

ì§ì› í”„ë¡œí•„ê³¼ ê´€ë ¨í•˜ì—¬ ì •í•œ ë¶€ë¶„ì€, ì§ì›ì˜ í”„ë¡œí•„ì€ 1ê°œë§Œ ë“±ë¡ì´ ê°€ëŠ¥í•˜ê³ , í”„ë¡œí•„ì„ ë˜ ì˜¬ë¦¬ê³  ì‹¶ë‹¤ë©´ ìˆ˜ì •ì´ ì•„ë‹ˆë¼ ë®ì–´ì¨ì„œ ê¸°ì¡´ì˜ í”„ë¡œí•„ì€ ì‚­ì œë˜ê³  ìƒˆë¡­ê²Œ ì—…ë¡œë“œë˜ëŠ” í”„ë¡œí•„ë¡œ ì €ì¥ë˜ê²Œë” í•˜ê¸°ë¡œ í–ˆë‹¤.

ë˜í•œ, ì§ì› í”„ë¡œí•„ì€ ì›ì¥, ì§ì›, ê°•ì‚¬ ëª¨ë‘ **ë³¸ì¸** í”„ë¡œí•„ë§Œ ë“±ë¡í•  ìˆ˜ ìˆë„ë¡ ì •í–ˆë‹¤.

ì‹œì‘í•´ë³´ì.

### 1. ê¸°ì¡´ ì‚¬ì „ì‘ì—… ìˆ˜ì •
---

ì•ì„œ, Spring Cloud AWSë¥¼ ì‚¬ìš©í•˜ë©´, AmazonS3Client Beanì€ ìë™ ìƒì„±ë˜ê¸° ë•Œë¬¸ì—, ë”°ë¡œ AWS ì„¤ì • ì •ë³´ í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ì£¼ì§€ ì•Šì•„ë„ ëœë‹¤ê³  í–ˆë‹¤.

ê·¸ë˜ì„œ, ê³¼ê°íˆ `AwsConfig.java`íŒŒì¼ì„ ì—†ì• ë„ë¡ í•˜ê² ë‹¤.


ë˜í•œ, í”„ë¡œì íŠ¸ì— ë§ê²Œ ê´€ë¦¬ìš© IAM ì‚¬ìš©ì, ê°œë°œìš© IAM ì‚¬ìš©ì, S3 ë²„í‚·, í´ë” ìƒì„±ì€ ì´ì „ ê²Œì‹œë¬¼ê³¼ ë˜‘ê°™ì´ ìƒì„±í•´ì£¼ë©´ ëœë‹¤. ì—¬ê¸°ì„œëŠ”, ìƒëµí•˜ë„ë¡ í•˜ê² ë‹¤.

### 2. Springboot ì„¤ì •
---

#### 2-1. ìŠ¤í”„ë§ í´ë¼ìš°ë“œ ì˜ì¡´ì„± ì¶”ê°€

ì˜ì¡´ì„± ì¶”ê°€ ë¶€ë¶„ë„ ë‹¤ë¥¸ê²Œ ì—†ë‹¤.

ì¸í…”ë¦¬ì œì´ í•˜ë‹¨ì— Dependenciesë¥¼ í†µí•´ í•´ë‹¹ Springboot í”„ë¡œì íŠ¸ì— ê°€ì¥ ì í•©í•œ ì˜ì¡´ì„± ë²„ì „ì„ ì¶”ê°€í•œë‹¤.

![image](https://user-images.githubusercontent.com/85394884/214575569-376a5599-b1e1-4baf-8915-28af02eacb0d.png)


#### 2-2. application.yml ì„¤ì •

ë‹¤ìŒìœ¼ë¡œ, application.ymlíŒŒì¼ì— ì´ì „ì— ê°œë°œìš© IAM ì‚¬ìš©ìì™€ S3 ë²„í‚·ì„ ìƒì„±í•˜ë©´ì„œ ë°œê¸‰ë°›ì€ **ì—‘ì„¸ìŠ¤ í‚¤, ë¹„ë°€ ì—‘ì„¸ìŠ¤ í‚¤, ë²„í‚· ì´ë¦„, ë²„í‚· ë¦¬ì „**ì„ ì…ë ¥í•´ì¤€ë‹¤.

ğŸš¨ í•´ë‹¹ ì •ë³´ë“¤ì€ ì™¸ë¶€ì— ê³µê°œë˜ë©´ ì•ˆë˜ë¯€ë¡œ yml íŒŒì¼ì—” ê°€ì§œ ì •ë³´ë¥¼ ì˜¬ë¦¬ê³ , Edit Configurationì„ í†µí•´ í™˜ê²½ë³€ìˆ˜ë¡œ ì…ë ¥í•´ì¤€ë‹¤.

ìš°ë¦¬ í”„ë¡œì íŠ¸ì˜ ê²½ìš° [submodule](https://percyfrank.github.io/infra/Infra01/) ìœ¼ë¡œ yml íŒŒì¼ì„ ê´€ë¦¬í•˜ë¯€ë¡œ ì›í•œë‹¤ë©´ ì°¸ê³ í•˜ë„ë¡ í•˜ì.

ì—¬ê¸°ì— ë°°í¬ ì„œë²„ URLê³¼ ì„œë²„ íŒ¨ìŠ¤ì›Œë“œ JWT í† í° secretKeyë„ í™˜ê²½ ë³€ìˆ˜ë¡œ ë“¤ì–´ê°€ì•¼ í•˜ì§€ë§Œ í”„ë¡œì íŠ¸ì—ì„œ ë°°í¬ë¥¼ ë‹´ë‹¹í•œ ë¶„ì´ ê³„ì‹œê¸°ì— í”„ë¡œì íŠ¸ ë§ˆë¬´ë¦¬ ì „ì— ì¶”ê°€í•  ê²ƒì´ë‹¤.

```yaml

cloud:
  aws:
    credentials:
      accessKey: ${AWS_ACCESS_KEY_ID}       # AWS IAM AccessKey
      secretKey: ${AWS_SECRET_ACCESS_KEY}   # AWS IAM SecretKey
    s3:
      bucket: bucket    # ë²„í‚· ì´ë¦„
    region:
      static: ap-northeast-2
    stack:
      auto: false

```

![image](https://user-images.githubusercontent.com/85394884/214857952-8e1d6551-6f00-4cf6-b3a5-5b5660bfdc18.png)


#### 2-3. Entity

ì—”í‹°í‹° ëª…ì„ `EmployeeProfile`ë¡œ ì •í–ˆë‹¤.

ë§ˆì°¬ê°€ì§€ë¡œ, S3 ë²„í‚·ì— ê°™ì€ ì´ë¦„ì˜ íŒŒì¼ì´ ì—…ë¡œë“œë˜ë©´ ë‚˜ì¤‘ì— ë“±ë¡ëœ íŒŒì¼ì´ ë®ì–´ì“°ëŠ” ë¬¸ì œê°€ ìƒê¸´ë‹¤.

ê·¸ë˜ì„œ, S3 ë²„í‚·ì— ì €ì¥ë˜ëŠ” íŒŒì¼ ì´ë¦„ì´ ì¤‘ë³µë˜ì§€ ì•Šë„ë¡ ì €ì¥ëœ íŒŒì¼ì˜ URLì„ ë‚˜íƒ€ë‚´ëŠ” í•„ë“œì¸ `storedFileUrl`ë¥¼ ì¶”ê°€í–ˆë‹¤.

ê·¸ë¦¬ê³  ì—…ë¡œë“œí•œ íŒŒì¼ ì´ë¦„ì„ ë‚˜íƒ€ë‚´ëŠ” `uploadFileName`í•„ë“œë„ ì¶”ê°€í–ˆë‹¤.

ìµœì´ˆ íŒŒì¼ ì—…ë¡œë“œ ì‹œê°„, ë§ˆì§€ë§‰ ìˆ˜ì • ì‹œê°„, ì‚­ì œ ì‹œê°„ì„ ìœ„í•´ `BaseEntity` í´ë˜ìŠ¤ë¥¼ ìƒì†í–ˆë‹¤.

`Employee` í…Œì´ë¸”ê³¼ëŠ” 1:N ê´€ê³„ë¡œ ë§¤í•‘í•´ì£¼ì—ˆë‹¤.

`Employeerofile.java`

```java

@Entity
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@AllArgsConstructor
@Builder
@Getter
@Table(name = "employee_profile_tb")
@Where(clause = "deleted_at is NULL")
@SQLDelete(sql = "UPDATE employee_profile_tb SET deleted_at = current_timestamp WHERE employee_profile_id = ?")
public class EmployeeProfile extends BaseEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "employee_profile_id")
    private Long id;

    private String uploadFileName;
    private String storedFileUrl;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "employee_id")
    private Employee employee;

    public static EmployeeProfile makeEmployeeProfile(String uploadFileName, String storedFileUrl, Employee employee) {
        return EmployeeProfile.builder()
                .uploadFileName(uploadFileName)
                .storedFileUrl(storedFileUrl)
                .employee(employee)
                .build();
    }
}
```

#### 2-4. Controller

âœ… íŒŒì¼ ì—…ë¡œë“œë¶€í„° ì‚´í´ë³´ì.

ì¼ë‹¨, í•™ì› ê°œë…ì´ ë“¤ì–´ê°€ê¸° ë•Œë¬¸ì—, academy endpointê°€ ì¶”ê°€ë˜ì—ˆê³ , ì–´ë–¤ ì§ì› ë°ì´í„°ì— íŒŒì¼ ì—…ë¡œë“œë¥¼ í• ì§€ì™€ ê´€ë ¨í•´ì„œ employee endpointë„ ì¶”ê°€ë˜ì—ˆë‹¤.

ë˜í•œ, ì´ëŸ¬í•œ ì‘ì—…ì„ ìˆ˜í–‰í•  ê¶Œí•œì„ í™•ì¸í•˜ê¸° ìœ„í•´ Authenticaton ê°ì²´ë„ íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê²¨ì¤€ë‹¤.

ë§ˆì§€ë§‰ìœ¼ë¡œ, MultipartFile ê°ì²´ë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ë°›ì•„ì™€ì„œ Service Layerì— ìš”ì²­ì„ ì „ë‹¬í•œë‹¤.

âœ… íŒŒì¼ ì‚­ì œ ìš”ì²­ì—ì„  ì¶”ê°€ë¡œ employeeProfileIdë„ endpointë¡œ ì¶”ê°€ë˜ì–´ S3 ë²„í‚·ì—ì„œ íŒŒì¼ì„ ì‚­ì œí•  ë•Œ,  EmployeeProfile dbì—ì„œë„ soft delete ë˜ê²Œë” êµ¬ì„±í•  ê²ƒì´ë‹¤. 

ë˜í•œ, @RequestParamìœ¼ë¡œ filePathë¥¼ ë„˜ê²¨ì¤„ ê²ƒì¸ë°, ì—¬ê¸°ì„œ filePathëŠ” S3 ë²„í‚·ì˜ í´ë” ì´í•˜ ë””ë ‰í† ë¦¬ë¥¼ ë§í•œë‹¤.

ì—¬ê¸°ì„ , `employee/ì €ì¥ëœ íŒŒì¼ëª….í™•ì¥ì`ê°€ ë  ê²ƒì´ë‹¤.

âœ… íŒŒì¼ ë‹¤ìš´ë¡œë“œ ìš”ì²­ì—ì„  @RequestParamìœ¼ë¡œ S3 ë²„í‚· í´ë” ì´í•˜ì˜ ë””ë ‰í† ë¦¬ê°€ ì•„ë‹ˆë¼ ì €ì¥ëœ íŒŒì¼ ê°ì²´ì˜ ì „ì²´ URLì„ ë„˜ê²¨ì¤€ë‹¤.

ì—¬ê¸°ì„  String íƒ€ì…ì˜ fileUrlì„ ë§í•œë‹¤. 

ë¬¼ë¡ , Service Layerì—” S3 ë²„í‚· í´ë” ì´í•˜ì˜ ë””ë ‰í† ë¦¬ë¥¼ ì „ë‹¬í•  ê²ƒì´ë‹¤.

`EmployeeProfileController.java`

```java
@Tag(name = "02-3. ì§ì›", description = "ì§ì› ì‚¬ì§„ ë“±ë¡,ìˆ˜ì •,ì¡°íšŒ")
@RestController
@RequiredArgsConstructor
@Slf4j
@RequestMapping("api/v1/academies")
public class EmployeeProfileController {

    private final EmployeeProfileS3UploadService employeeProfileS3UploadService;

    // S3ì— íŒŒì¼ ì—…ë¡œë“œ
    @Operation(summary = "ì§ì› ì‚¬ì§„ë“±ë¡", description = "STAFF íšŒì›ì€ ë³¸ì¸ë§Œ, ADMIN íšŒì›ì€ ëª¨ë“  STAFF ê´€ë ¨ ë“±ë¡ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. \n\n AWS S3ì„œë²„ì— ì €ì¥ë©ë‹ˆë‹¤.")
    @PostMapping("/{academyId}/employees/{employeeId}/files/upload")
    public ResponseEntity<Response<CreateEmployeeProfileResponse>> upload(@PathVariable("academyId") Long academyId,
                                                                          @PathVariable("employeeId") Long employeeId,
                                                                          @RequestPart MultipartFile multipartFile,
                                                                          Authentication authentication) throws IOException {
        String requestAccount = AuthenticationUtil.getAccountFromAuth(authentication);
        CreateEmployeeProfileResponse profileResponse = employeeProfileS3UploadService.uploadEmployeeProfile(academyId, employeeId, multipartFile, requestAccount);
        return ResponseEntity.ok().body(Response.success(profileResponse));
    }


    // S3 íŒŒì¼ ì‚­ì œ
    @Operation(summary = "ì§ì› ì‚¬ì§„ì‚­ì œ", description = "STAFF íšŒì›ì€ ë³¸ì¸ ê´€ë ¨ë§Œ, ADMIN íšŒì›ì€ ëª¨ë“  STAFF ê´€ë ¨ ì‚­ì œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤. \n\n dbì—ëŠ” soft-delete ë˜ê³ , AWS S3ì„œë²„ì—ì„œëŠ” ì‚­ì œë©ë‹ˆë‹¤.")
    @DeleteMapping("/{academyId}/employees/{employeeId}/employeeProfiles/{employeeProfileId}/files")
    public ResponseEntity<Response<DeleteEmployeeProfileResponse>> delete(@PathVariable("academyId") Long academyId,
                                                                          @PathVariable("employeeId") Long employeeId,
                                                                          @PathVariable("employeeProfileId") Long employeeProfileId,
                                                                          @RequestParam String filePath,
                                                                          Authentication authentication) {
        String requestAccount = AuthenticationUtil.getAccountFromAuth(authentication);
        DeleteEmployeeProfileResponse profileResponse = employeeProfileS3UploadService.deleteEmployeeProfile(academyId, employeeId, employeeProfileId, filePath, requestAccount);
        return ResponseEntity.ok().body(Response.success(profileResponse));
    }

    // S3 íŒŒì¼ ë‹¤ìš´ë¡œë“œ
    @Operation(summary = "ì§ì› ì‚¬ì§„ë‹¤ìš´ë¡œë“œ", description = "ì¸ì¦ëœ ëª¨ë“  íšŒì›ì€ ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤. \n\n AWS S3ì„œë²„ì— ì €ì¥ëœ ì‚¬ì§„ì„ ë‹¤ìš´ë¡œë“œí•©ë‹ˆë‹¤.")
    @GetMapping("/{academyId}/employees/{employeeId}/files/download")
    public ResponseEntity<byte[]> download(@PathVariable("academyId") Long academyId,
                                           @PathVariable("employeeId") Long employeeId,
                                           @RequestParam String fileUrl,
                                           Authentication authentication) throws IOException {
        String requestAccount = AuthenticationUtil.getAccountFromAuth(authentication);
        // ë²„í‚· í´ë” ì´í•˜ ê²½ë¡œ
        String filePath = fileUrl.substring(56);
        log.info("filePath : {}", filePath);
        return employeeProfileS3UploadService.downloadEmployeeProfile(academyId, employeeId, filePath, requestAccount);
    }
}
```

#### 2-5. Service 

Service ì½”ë“œì—ì„  ë©”ì„œë“œ ë³„ë¡œ ë‚˜ëˆ ì„œ ì‚´í´ë³´ê² ë‹¤.


**1. ì—…ë¡œë“œ**

ì—…ë¡œë“œ í•  ë•Œ, ë¹ˆ íŒŒì¼ì„ ì²¨ë¶€í•˜ê±°ë‚˜, íŒŒì¼ì„ ì²¨ë¶€í•´ë„ íŒŒì¼ ì•ˆì— ë‚´ìš©ì´ ì—†ëŠ” ê²½ìš° `FILE_NOT_EXISTS`ì—ëŸ¬ë¥¼ ë°œìƒí•˜ë„ë¡ `validateFileExists()` ë©”ì„œë“œë¡œ ê²€ì¦í•œë‹¤.

ë‹¤ìŒìœ¼ë¡ , í•™ì› ì¡´ì¬ ìœ ë¬´ì™€ ì—…ë¡œë“œ ì§„í–‰í•˜ëŠ” ì§ì›ì´ í•´ë‹¹ í•™ì› ì†Œì†ì¸ì§€, ê·¸ë¦¬ê³  ê·¸ ì§ì›ì´ ì—…ë¡œë“œí•  ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.

íŒŒì¼ ì—…ë¡œë“œ ëŒ€ìƒì¸ ì§ì›ì˜ ì¡´ì¬ ìœ ë¬´ë„ í™•ì¸í•œë‹¤.

ê·¸ë¦¬ê³  ì—…ë¡œë“œí•˜ë ¤ëŠ” ì§ì›ì´ ìì‹ ì˜ í”„ë¡œí•„ì„ ë“±ë¡í•˜ëŠ”ì§€ë„ í™•ì¸í•œë‹¤.

ê¶Œí•œê³¼ ê´€ë ¨í•´ì„  ì—¬ê¸°ê¹Œì§€ ë§ˆë¬´ë¦¬í•˜ê³ ,

ğŸš¨ ì´ì œ íŒŒì¼ ì—…ë¡œë“œì™€ ê´€ë ¨ëœ ì½”ë“œë“¤ì„ ì„¤ëª…í•´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì§„í–‰ëœë‹¤.

- ObjectMetadata ê°ì²´ì— content-lengthì™€ sizeë¥¼ ì§€ì •í•œë‹¤. ì§€ì •í•˜ì§€ ì•Šìœ¼ë©´ warning ë¡œê·¸ ë°œìƒí•œë‹¤.
- íŒŒì¼ ì´ë¦„ê³¼ UUIDë¡œ ìƒì„±í•œ ëœë¤ ê°’ì„ í•©ì³ì„œ S3ì— ì €ì¥ë  íŒŒì¼ ì´ë¦„ì„ ë§Œë“ ë‹¤.
- ê·¸ë¦¬ê³ , í•´ë‹¹ íŒŒì¼ì„ S3 ë²„í‚·ì˜ employee í´ë”ì— ì €ì¥ë˜ë„ë¡ í•œë‹¤.
- ë²„í‚·, ì €ì¥í•  ë””ë ‰í† ë¦¬ + íŒŒì¼ ì´ë¦„ ë“±ì˜ ë°ì´í„°ì™€ ë©”íƒ€ ë°ì´í„°ë¥¼ AmazonS3Client Beanì— ì£¼ì…í•˜ê³ , `withCannedAcl` ë©”ì„œë“œì˜ `PublicRead` ì˜µì…˜ì„ í†µí•´ ì—…ë¡œë“œí•œ íŒŒì¼ì„ ëª¨ë‘ê°€ ì½ì„ ìˆ˜ ìˆê²Œ ì„¤ì •í•œë‹¤.
- ğŸš¨ ë‹¤ìŒìœ¼ë¡œ, ì œì¼ ì¤‘ìš”í•œ ë¶€ë¶„ì´ë‹¤. ğŸš¨
  - ìœ„ì—ì„œ ë§í–ˆë“¯ì´, ì´ë¯¸ í•´ë‹¹ ì§ì›ì´ ê¸°ì¡´ í”„ë¡œí•„ì´ ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—” ê¸°ì¡´ í”„ë¡œí•„ì„ ì‚­ì œí•˜ê³  ìƒˆë¡œ ì—…ë¡œë“œ í•  í”„ë¡œí•„ë¡œ ëŒ€ì²´í•˜ê¸°ë¡œ í–ˆë‹¤.
  - ê·¸ë˜ì„œ `findByEmployee_Id` ë©”ì„œë“œë¡œ ë§Œì•½ ì¡´ì¬í•œë‹¤ë©´, S3 ì €ì¥ëœ ê¸°ì¡´ í”„ë¡œí•„ ê°ì²´ urlì„ ê°€ì ¸ì™€ì„œ s3ì—ì„œë„ ì‚­ì œí•˜ê³ , dbì—ì„œë„ ì‚­ì œí•˜ë„ë¡ êµ¬í˜„í–ˆë‹¤.
- ë§ˆì§€ë§‰ìœ¼ë¡œ, `getUrl` ë©”ì„œë“œë¥¼ í†µí•´ S3ì— ì—…ë¡œë“œëœ íŒŒì¼ URL, íŒŒì¼ ì—…ë¡œë“œ ì‹œ íŒŒì¼ ëª…, ê·¸ë¦¬ê³  ì–´ë–¤ ì§ì›ê³¼ ê´€ë ¨ëœ íŒŒì¼ ì—…ë¡œë“œì¸ì§€ë¥¼ `makeEmployeeProfile()` ë©”ì„œë“œë¥¼ í†µí•´ ì €ì¥í•˜ê³  ì´ë¥¼ `EmployeeProfile` dbì— ì €ì¥í•œë‹¤.

```java
@Service
@RequiredArgsConstructor
@Slf4j
@Transactional
public class EmployeeProfileS3UploadService {

    private final AmazonS3Client amazonS3Client;
    private final AcademyRepository academyRepository;
    private final EmployeeRepository employeeRepository;
    private final EmployeeProfileRepository employeeProfileRepository;

    @Value("${cloud.aws.s3.bucket}")
    private String bucket;

    public CreateTeacherProfileResponse UploadTeacherProfile(Long academyId, Long teacherId, MultipartFile multipartFile, String account) throws IOException {

        // íŒŒì¼ì´ ë“¤ì–´ìˆëŠ”ì§€ í™•ì¸
        validateFileExists(multipartFile);

        // í•™ì› ì¡´ì¬ ìœ ë¬´ í™•ì¸
        Academy academy = validateAcademy(academyId);

        // ì—…ë¡œë“œë¥¼ ì§„í–‰í•˜ëŠ” ì§ì›ì´ í•´ë‹¹ í•™ì› ì†Œì† ì§ì›ì¸ì§€ í™•ì¸
        Employee employee = validateAcademyEmployee(account, academy);

        // íŒŒì¼ ì—…ë¡œë“œ ëŒ€ìƒì¸ ì§ì› ì¡´ì¬ ìœ ë¬´ í™•ì¸
        Employee targetEmployee = validateEmployee(employeeId, academy);

        // ì›ì¥, ì§ì›, ê°•ì‚¬ ëª¨ë‘ ë³¸ì¸ í”„ë¡œí•„ë§Œ ë“±ë¡ ê°€ëŠ¥
        if(!employee.equals(targetEmployee)) {
            throw new AppException(ErrorCode.INVALID_PERMISSION);
        }

        ObjectMetadata objectMetadata = new ObjectMetadata();
        objectMetadata.setContentType(multipartFile.getContentType());
        objectMetadata.setContentLength(multipartFile.getSize());

        // ì—…ë¡œë“œí•œ íŒŒì¼ ì´ë¦„
        String originalFilename = multipartFile.getOriginalFilename();

        // file í˜•ì‹ì´ ì˜ëª»ëœ ê²½ìš°ë¥¼ í™•ì¸
        int index;
        try {
           index = originalFilename.lastIndexOf(".");
        } catch (StringIndexOutOfBoundsException e) {
            throw new AppException(ErrorCode.WRONG_FILE_FORMAT);
        }

        String ext = originalFilename.substring(index + 1);

        // ì €ì¥ë  íŒŒì¼ ì´ë¦„
        String storedFileName = UUID.randomUUID() + "." + ext;

        // ì €ì¥í•  ë””ë ‰í† ë¦¬ ê²½ë¡œ + íŒŒì¼ ì´ë¦„
        String key = "employee/" + storedFileName;

        try (InputStream inputStream = multipartFile.getInputStream()) {
            amazonS3Client.putObject(new PutObjectRequest(bucket, key, inputStream, objectMetadata)
                    .withCannedAcl(CannedAccessControlList.PublicRead));
        } catch (IOException e) {
            throw new AppException(ErrorCode.FILE_UPLOAD_ERROR);
        }

        // ì €ì¥ë  í”„ë¡œí•„ì˜ url
        String storeFileUrl = amazonS3Client.getUrl(bucket, key).toString();

        // ë§Œì•½ í•´ë‹¹ ì§ì›ì˜ ê¸°ì¡´ í”„ë¡œí•„ì´ ì¡´ì¬í•˜ëŠ” ê²½ìš°
        employeeProfileRepository.findByEmployee_Id(employee.getId())
                .ifPresent(employeeProfile -> {
                    // ê¸°ì¡´ í”„ë¡œí•„ ê°ì²´ url ê°€ì ¸ì˜¤ê¸°
                    String oldFileUrl = employeeProfile.getStoredFileUrl();
                    String oldFilePath = oldFileUrl.substring(52);
                    // s3 ë²„í‚·ì—ì„œ ê¸°ì¡´ í”„ë¡œí•„ ì‚­ì œí•˜ê¸°
                    amazonS3Client.deleteObject(new DeleteObjectRequest(bucket, oldFilePath));
                    // dbì—ì„œë„ ì‚­ì œí•˜ê¸°
                    employeeProfileRepository.delete(employeeProfile);
                });

        // í”„ë¡œí•„ dbì— ì €ì¥í•˜ê¸°
        EmployeeProfile newEmployeeProfile = EmployeeProfile.makeEmployeeProfile(originalFilename, storeFileUrl, employee);
        employeeProfileRepository.save(newEmployeeProfile);

        log.info("íŒŒì¼ ë“±ë¡ ì™„ë£Œ");
        return CreateEmployeeProfileResponse.of(originalFilename, storedFileName);
    }

    private Academy validateAcademy(Long academyId) {
        // í•™ì› ì¡´ì¬ ìœ ë¬´ í™•ì¸
        Academy validatedAcademy = academyRepository.findById(academyId)
                .orElseThrow(() -> new AppException(ErrorCode.ACADEMY_NOT_FOUND));
        return validatedAcademy;
    }

    private Employee validateAcademyEmployee(String account, Academy academy) {
        // í•´ë‹¹ í•™ì› ì†Œì† ì§ì› ë§ëŠ”ì§€ í™•ì¸
        Employee employee = employeeRepository.findByAccountAndAcademy(account, academy)
                .orElseThrow(() -> new AppException(ErrorCode.ACCOUNT_NOT_FOUND));
        return employee;
    }

    private Teacher validateTeacher(Long teacherId) {
        Teacher validatedTeacher = teacherRepository.findById(teacherId)
                .orElseThrow(() -> new AppException(ErrorCode.TEACHER_NOT_FOUND));
        return validatedTeacher;
    }

    // ë¹ˆ íŒŒì¼ì´ ì•„ë‹Œì§€ í™•ì¸, íŒŒì¼ ìì²´ë¥¼ ì²¨ë¶€ì•ˆí•˜ê±°ë‚˜ ì²¨ë¶€í•´ë„ ë‚´ìš©ì´ ë¹„ì–´ìˆìœ¼ë©´ ì—ëŸ¬ ì²˜ë¦¬
    private void validateFilExists(MultipartFile multipartFile) {
        if (multipartFile.isEmpty()) {
            throw new AppException(ErrorCode.FILE_NOT_EXISTS);
        }
    }
}
```

**2. ì‚­ì œ**

ì‚­ì œ ë¶€ë¶„ë„ ë§ˆì°¬ê°€ì§€ë¡œ, í•™ì›, ì§ì›, ê°•ì‚¬ì˜ ì¡´ì¬ ìœ ë¬´ë¥¼ í™•ì¸í•˜ê³ , ì§ì›ì˜ ê¶Œí•œë„ í™•ì¸í•œ ë’¤, ì €ì¥ëœ íŒŒì¼ì´ ìˆëŠ”ì§€ë„ í™•ì¸í•œë‹¤.

ê·¸ë¦¬ê³ , íŒŒì¼ ì‚­ì œì˜ ê²½ìš°ì—” ê¶Œí•œ ë³„ë¡œ ë‹¤ë¥´ë‹¤.

ê°•ì‚¬ëŠ” ì¼ë‹¨ ë¶ˆê°€ëŠ¥í•˜ë‹¤. ì¼ë°˜ ì§ì›ì€ ë³¸ì¸ ê´€ë ¨ í”„ë¡œí•„ë§Œ ì‚­ì œ ê°€ëŠ¥í•˜ê³ , ì›ì¥ì€ ëª¨ë“  ì§ì›ì˜ í”„ë¡œí•„ ì‚­ì œê°€ ê°€ëŠ¥í•˜ë„ë¡ êµ¬í˜„í–ˆë‹¤.

ğŸš¨ ë‹¤ìŒìœ¼ë¡œ, `try-catch` êµ¬ë¬¸ì—ì„œ `deleteObject` ë©”ì„œë“œë¥¼ ì´ìš©í•´ S3 ì—…ë¡œë“œ íŒŒì¼ì„ ì‚­ì œí•˜ê³ , í•´ë‹¹ ì—…ë¡œë“œ íŒŒì¼ì„ `EmployeeProfile` dbì—ì„œë„ ê°™ì´ soft delete ì‹œì¼œì¤€ë‹¤. 

```java
@Service
@RequiredArgsConstructor
@Slf4j
@Transactional
public class EmployeeProfileS3UploadService {

    private final AmazonS3Client amazonS3Client;
    private final AcademyRepository academyRepository;
    private final EmployeeRepository employeeRepository;
    private final EmployeeProfileRepository employeeProfileRepository;

    @Value("${cloud.aws.s3.bucket}")
    private String bucket;

    public DeleteEmployeeProfileResponse deleteEmployeeProfile(Long academyId, Long employeeId, Long employeeProfileId, String filePath, String account) {

        // í•™ì› ì¡´ì¬ ìœ ë¬´ í™•ì¸
        Academy academy = validateAcademy(academyId);

        // íŒŒì¼ ì‚­ì œë¥¼ ì§„í–‰í•˜ëŠ” ì§ì›ì´ í•´ë‹¹ í•™ì› ì†Œì† ì§ì›ì¸ì§€ í™•ì¸
        Employee employee = validateAcademyEmployee(account, academy);

        // íŒŒì¼ ì‚­ì œ ëŒ€ìƒì¸ ì§ì› ì¡´ì¬ ìœ ë¬´ í™•ì¸
        Employee targetEmployee = validateEmployee(employeeId, academy);

        // 1. ì§ì›ì´ íŒŒì¼ ì‚­ì œí•  ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸ (ê°•ì‚¬ ì™¸ ëª¨ë“  ì§ì› ê°€ëŠ¥)
        // 2. ì¼ë°˜ ì§ì›ì€ ë³¸ì¸ ê´€ë ¨ íŒŒì¼ë§Œ ì‚­ì œ ê°€ëŠ¥
        // 3. ì›ì¥ì€ ëª¨ë“  ì§ì› íŒŒì¼ ì‚­ì œ ê°€ëŠ¥
        if(!employee.getEmployeeRole().equals(EmployeeRole.ROLE_ADMIN)) {
            if(Employee.isTeacherAuthority(employee) || !employee.equals(targetEmployee)) {
                throw new AppException(ErrorCode.INVALID_PERMISSION);
            }
        }

        // ì§ì› íŒŒì¼ ì¡´ì¬ ìœ ë¬´ í™•ì¸
        EmployeeProfile employeeProfile = validateEmployeeProfile(employeeProfileId);

        try {
            // S3 ì—…ë¡œë“œ íŒŒì¼ ì‚­ì œ
            amazonS3Client.deleteObject(new DeleteObjectRequest(bucket, filePath));
            // í•´ë‹¹ ì—…ë¡œë“œ íŒŒì¼ í…Œì´ë¸”ì—ì„œë„ ê°™ì´ ì‚­ì œ
            employeeProfileRepository.delete(employeeProfile);
            log.info("íŒŒì¼ ì‚­ì œ ì„±ê³µ");
        } catch (AmazonServiceException e) {
            e.printStackTrace();
        } catch (SdkClientException e) {
            e.printStackTrace();
        }
        return DeleteEmployeeProfileResponse.of(employee);
    }

    private Academy validateAcademy(Long academyId) {
        // í•™ì› ì¡´ì¬ ìœ ë¬´ í™•ì¸
        Academy validatedAcademy = academyRepository.findById(academyId)
                .orElseThrow(() -> new AppException(ErrorCode.ACADEMY_NOT_FOUND));
        return validatedAcademy;
    }

    private Employee validateAcademyEmployee(String account, Academy academy) {
        // í•´ë‹¹ í•™ì› ì†Œì† ì§ì› ë§ëŠ”ì§€ í™•ì¸
        Employee employee = employeeRepository.findByAccountAndAcademy(account, academy)
                .orElseThrow(() -> new AppException(ErrorCode.ACCOUNT_NOT_FOUND));
        return employee;
    }

    private Teacher validateTeacher(Long teacherId) {
        Teacher validatedTeacher = teacherRepository.findById(teacherId)
                .orElseThrow(() -> new AppException(ErrorCode.TEACHER_NOT_FOUND));
        return validatedTeacher;
    }

    private TeacherProfile validateTeacherProfile(Long teacherProfileId) {
        TeacherProfile validatedteacherProfile = teacherProfileRepository.findById(teacherProfileId)
                .orElseThrow(() -> new AppException(ErrorCode.TEACHER_PROFILE_NOT_FOUND));
        return validatedteacherProfile;
    }
}
```

**3. ë‹¤ìš´ë¡œë“œ**

ë‹¤ìš´ë¡œë“œë„ ë§ˆì°¬ê°€ì§€ë¡œ, í•™ì›, ì§ì›, ê°•ì‚¬ì˜ ì¡´ì¬ ìœ ë¬´ë¥¼ í™•ì¸í•˜ì§€ë§Œ, ë‹¤ìš´ë¡œë“œëŠ” ëª¨ë“  ì§ì›ì´ ê°€ëŠ¥í•˜ê¸° ë•Œë¬¸ì— ì§ì›ì˜ ê¶Œí•œì„ í™•ì¸í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.

ğŸš¨ ë‹¤ìš´ë¡œë“œì™€ ê´€ë ¨ëœ ì½”ë“œë“¤ì„ ì„¤ëª…í•´ë³´ë©´,

- S3 ê°ì²´ë¥¼ ì¶”ì¶œí•´ì„œ byte ë°°ì—´ë¡œ ë³€í™˜ì„ ì‹œì¼œì¤€ë‹¤.
- `contentType` ë©”ì„œë“œë¥¼ í†µí•´ ì €ì¥ëœ íŒŒì¼ì„ í™•ì¥ì ë³„ë¡œ êµ¬ë¶„í•˜ì—¬ ì „ì†¡ í—¤ë”ì˜ í™•ì¥ìë¡œ ë„£ì–´ì¤€ë‹¤.
- byte ë°°ì—´ì˜ ê¸¸ì´ë¥¼ ì „ì†¡ í—¤ë”ì˜ contentLengthì— ì…ë ¥í•œë‹¤.
- ë‹¤ìŒìœ¼ë¡œ, íŒŒë¼ë¯¸í„°ë¡œ ë°›ì€ fileUrl, ì¦‰, S3 ë²„í‚· í´ë” ì´í•˜ì˜ ê²½ë¡œì—ì„œ `bucketFolder` ë³€ìˆ˜ì— `/`ë¥¼ êµ¬ë¶„ìë¡œ S3 ë²„í‚· í´ë”ì™€ ì €ì¥ëœ íŒŒì¼ ëª…ì„ ì €ì¥í•œë‹¤.
- íŒŒì¼ ëª…ì„ ì¶”ì¶œí•˜ê³ , ì¸ì½”ë”©í•œ ë’¤ì— `setContentDispositionFormData()` ë©”ì„œë“œë¥¼ í†µí•´ ì „ì†¡ í—¤ë”ì˜ íŒŒì¼ëª…ìœ¼ë¡œ ì„¸íŒ…í•œë‹¤.


```java
@Service
@RequiredArgsConstructor
@Slf4j
@Transactional
public class TeacherProfileS3UploadService {

    private final AmazonS3Client amazonS3Client;
    private final AcademyRepository academyRepository;
    private final EmployeeRepository employeeRepository;
    private final EmployeeProfileRepository employeeProfileRepository;

    @Value("${cloud.aws.s3.bucket}")
    private String bucket;

    public ResponseEntity<byte[]> downloadTeacherProfile(Long academyId, Long teacherId, String fileUrl, String account) throws IOException {

        // í•™ì› ì¡´ì¬ ìœ ë¬´ í™•ì¸
        Academy academy = validateAcademy(academyId);

        // ì—…ë¡œë“œë¥¼ ì§„í–‰í•˜ëŠ” ì§ì›ì´ í•´ë‹¹ í•™ì› ì†Œì† ì§ì›ì¸ì§€ í™•ì¸
        validateAcademyEmployee(account, academy);

        // í”„ë¡œí•„ ì‚¬ì§„ ëŒ€ìƒì¸ ê°•ì‚¬ ì¡´ì¬ ìœ ë¬´ í™•ì¸
        validateTeacher(teacherId);

        // S3 ê°ì²´ ì¶”ì¶œí•´ì„œ byte ë°°ì—´ë¡œ ë³€í™˜
        S3Object s3Object = amazonS3Client.getObject(new GetObjectRequest(bucket, fileUrl));
        S3ObjectInputStream s3ObjectInputStream = s3Object.getObjectContent();
        byte[] bytes = IOUtils.toByteArray(s3ObjectInputStream);

        HttpHeaders httpHeaders = new HttpHeaders();
        httpHeaders.setContentType(contentType(fileUrl));
        httpHeaders.setContentLength(bytes.length);

        // ë²„í‚· í´ë” ì¶”ì¶œ
        String[] bucketFolder = fileUrl.split("/");
        log.info("bucketFolder : {}", bucketFolder);

        // ë²„í‚· í´ë”ì— ì €ì¥ëœ í•´ë‹¹ íŒŒì¼ëª… ì¶”ì¶œ
        String fileName = bucketFolder[bucketFolder.length - 1];
        log.info("fileName : {}", fileName);

        // ì¸ì½”ë”©
        String encodedFileName = URLEncoder.encode(fileName, "UTF-8").replaceAll("\\+", "%20");
        log.info("encodedFileName : {}", encodedFileName);

        httpHeaders.setContentDispositionFormData("attachment",encodedFileName);

        return new ResponseEntity<>(bytes, httpHeaders, HttpStatus.OK);
    }

    private Academy validateAcademy(Long academyId) {
        // í•™ì› ì¡´ì¬ ìœ ë¬´ í™•ì¸
        Academy validatedAcademy = academyRepository.findById(academyId)
                .orElseThrow(() -> new AppException(ErrorCode.ACADEMY_NOT_FOUND));
        return validatedAcademy;
    }

    private Employee validateAcademyEmployee(String account, Academy academy) {
        // í•´ë‹¹ í•™ì› ì†Œì† ì§ì› ë§ëŠ”ì§€ í™•ì¸
        Employee employee = employeeRepository.findByAccountAndAcademy(account, academy)
                .orElseThrow(() -> new AppException(ErrorCode.ACCOUNT_NOT_FOUND));
        return employee;
    }

    private Teacher validateTeacher(Long teacherId) {
        Teacher validatedTeacher = teacherRepository.findById(teacherId)
                .orElseThrow(() -> new AppException(ErrorCode.TEACHER_NOT_FOUND));
        return validatedTeacher;
    }

    // ë¹ˆ íŒŒì¼ì´ ì•„ë‹Œì§€ í™•ì¸, íŒŒì¼ ìì²´ë¥¼ ì²¨ë¶€ì•ˆí•˜ê±°ë‚˜ ì²¨ë¶€í•´ë„ ë‚´ìš©ì´ ë¹„ì–´ìˆìœ¼ë©´ ì—ëŸ¬ ì²˜ë¦¬
    private void validateFilExists(MultipartFile multipartFile) {
        if (multipartFile.isEmpty()) {
            throw new AppException(ErrorCode.FILE_NOT_EXISTS);
        }
    }

    // ì €ì¥ëœ íŒŒì¼ í™•ì¥ì ë³„ë¡œ êµ¬ë¶„í•˜ì—¬ ì €ì¥
    private MediaType contentType(String keyname) {
        String[] arr = keyname.split("\\.");
        log.info("arr : {}", arr);
        String fileExtension = arr[arr.length - 1];
        switch (fileExtension) {
            case "txt":
                return MediaType.TEXT_PLAIN;
            case "png":
                return MediaType.IMAGE_PNG;
            case "jpg":
                return MediaType.IMAGE_JPEG;
            default:
                return MediaType.APPLICATION_OCTET_STREAM;
        }
    }
}
```

#### 2-6. ErrorCode, ExceptionManager, íŒŒì¼ ì—…ë¡œë“œ, ì‚­ì œ ë°˜í™˜ DTO

`ErrorCode`

```java
EMPLOYEE_PROFILE_NOT_FOUND(HttpStatus.NOT_FOUND, "í•´ë‹¹ ì§ì› íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."),
FILE_NOT_EXISTS(HttpStatus.BAD_REQUEST, "ë³´ë‚¼ íŒŒì¼ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤."),
FILE_SIZE_EXCEED(HttpStatus.BAD_REQUEST, "íŒŒì¼ ì—…ë¡œë“œ ìš©ëŸ‰ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.")
```

`ExceptionManager.java`

`application.yml`ì— ì„¤ì •í•œ 10MB ìš©ëŸ‰ì´ ë„˜ëŠ” íŒŒì¼ì„ ì—…ë¡œë“œ í•  ì‹œ, `FILE_SIZE_EXCEED` ì—ëŸ¬ë¥¼ ë°œìƒì‹œí‚¤ë„ë¡ í–ˆë‹¤.

```java
    /**
     * íŒŒì¼ ì—…ë¡œë“œ ìš©ëŸ‰ ì´ˆê³¼ì‹œ ë°œìƒ
     */
    @ExceptionHandler(MaxUploadSizeExceededException.class)
    protected ResponseEntity<?> handleMaxUploadSizeExceededException(MaxUploadSizeExceededException e) {
        log.info("handleMaxUploadSizeExceededException", e);
        ErrorResponse errorResponse = new ErrorResponse(ErrorCode.FILE_SIZE_EXCEED);
        return ResponseEntity.status(errorResponse.getErrorCode().getHttpStatus())
                .body(Response.error("ERROR", errorResponse));
    }

```

`CreateEmployeeProfileResponse.java`

ì—…ë¡œë“œ ì‹œ ì„±ê³µ ë©”ì„¸ì§€ì™€ í•¨ê»˜ ì—…ë¡œë“œ í•œ íŒŒì¼ì˜ ì´ë¦„ì„ ë°˜í™˜í•œë‹¤.

```java
@NoArgsConstructor
@AllArgsConstructor
@Getter
@Builder
public class CreateEmployeeProfileResponse {

    private String uploadFileName;
    private String S3StoredFileName;
    private String message;

    public static CreateEmployeeProfileResponse of(String original, String stored) {
        return CreateEmployeeProfileResponse.builder()
                .uploadFileName(original)
                .S3StoredFileName(stored)
                .message("íŒŒì¼ ì²¨ë¶€ ì™„ë£Œ")
                .build();
    }
}
```

`DeleteEmployeeProfileResponse.java`

ì‚­ì œ ì‹œ, ì„±ê³µ ë©”ì„¸ì§€ì™€ í•¨ê»˜ ì‚­ì œ ì‘ì—…ì„ ì§„í–‰í•œ ì§ì›ì„ ë°˜í™˜í•œë‹¤.

```java
@NoArgsConstructor
@AllArgsConstructor
@Getter
@Builder
public class DeleteEmployeeProfileResponse {

    private Long deletedEmployee;
    private String message;

    public static DeleteEmployeeProfileResponse of(Employee employee) {
        return DeleteEmployeeProfileResponse.builder()
                .deletedEmployee(employee.getId())
                .message("ì‚­ì œ ì„±ê³µ")
                .build();
    }
}
```

### 3. ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸

#### íŒŒì¼ ì—…ë¡œë“œ

png íŒŒì¼ ì—…ë¡œë“œ ìš”ì²­ì„ ë³´ëƒˆë”ë‹ˆ, ì„±ê³µì ìœ¼ë¡œ S3 ë²„í‚·ê³¼ `EmployeeProfile` dbì— ì˜ ì €ì¥ë˜ì—ˆë‹¤.

![image](https://user-images.githubusercontent.com/85394884/217001326-cb52e32d-69d0-4bba-bf43-e177f8e0d505.png)

![image](https://user-images.githubusercontent.com/85394884/217001971-b7ac1cfc-baf2-444f-ba73-489b2c81daac.png)

![image](https://user-images.githubusercontent.com/85394884/217002450-8e0a621c-f732-4453-a9d2-d02986c43df2.png)

![image](https://user-images.githubusercontent.com/85394884/217002696-ff209b2f-4684-4356-8e0b-edd4fb1623c5.png)


#### íŒŒì¼ ë‹¤ìš´ë¡œë“œ

ë°©ê¸ˆ ì—…ë¡œë“œí•œ png íŒŒì¼ ë‹¤ìš´ë¡œë“œ ìš”ì²­ì„ ë³´ëƒˆë‹¤.

ì•„ë˜ì˜ ê°ì²´ URLì„ ê·¸ëŒ€ë¡œ `fileUrl`ì˜ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•œë‹¤.

![image](https://user-images.githubusercontent.com/85394884/217002816-12887871-b009-4ba1-9967-535f150078e6.png)

ì—…ë¡œë“œí•œ ì‚¬ì§„ì´ ë‚˜ì™”ë‹¤. ë‚˜ì¤‘ì— í”„ë¡ íŠ¸ë¥¼ êµ¬í˜„í•˜ë©´ ë‹¤ìš´ë¡œë“œ ë˜ê²Œ ë§Œë“¤ê² ë‹¤.

![image](https://user-images.githubusercontent.com/85394884/217006115-acba6b3e-381d-42fe-b6bd-689a0548a787.png)


#### íŒŒì¼ ì‚­ì œ

ë¡œê³  ì‚¬ì§„ì„ ì‚­ì œí•´ë³´ê² ë‹¤.

S3 ë²„í‚· í´ë” ì´í•˜ì˜ ë””ë ‰í† ë¦¬ ê²½ë¡œë¥¼ `filePath`ì˜ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•œë‹¤.

ì•„ë˜ ì‚¬ì§„ì„ ë³´ë©´, S3 ë²„í‚·ì—ì„œë„ ë”ì´ìƒ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•Šê³ , `EmployeeProfile` dbì—ì„œë„ soft delete ë˜ì—ˆë‹¤.

![image](https://user-images.githubusercontent.com/85394884/217006620-e0014dfb-40a1-40b2-819c-67bb23cb97a2.png)

![image](https://user-images.githubusercontent.com/85394884/217006950-f2c7d98e-a41e-466c-a6cb-e567d2474916.png)

![image](https://user-images.githubusercontent.com/85394884/217007108-3719015b-139d-4e1b-9191-974439278879.png)

ì´ë ‡ê²Œ, ì‹¤ì œ ì§„í–‰í•˜ê³  ìˆëŠ” í”„ë¡œì íŠ¸ì— íŒŒì¼ ì—…ë¡œë“œ, ì‚­ì œ, ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ì„ ì ì ˆíˆ ì ìš©í•´ë³´ì•˜ë‹¤.

í•˜ë‚˜ì˜ íŒŒì¼ ì—”í‹°í‹°ì—ì„œ ê´€ë¦¬í•˜ë©´ ì¢‹ê² ì§€ë§Œ, ê·¸ë ‡ê²Œ ë˜ë©´ íŒŒì¼ì´ ì„ì´ê²Œ ë˜ì–´ ê´€ë¦¬í•˜ê¸°ê°€ ë³µì¡í•˜ê¸°ë„ í•˜ê³  ì—°ê´€ê´€ê³„ ë§¤í•‘ ì‹œ ì™¸ë˜í‚¤ì— nullê°’ì´ ë“¤ì–´ê°ˆ ìˆ˜ ìˆì–´ ê¶Œì¥í•˜ì§€ ì•ŠëŠ”ë‹¤.

ë”°ë¼ì„œ, ì§ì›, ê³µì§€ì‚¬í•­ê³¼ ê´€ë ¨ëœ íŒŒì¼ ì—”í‹°í‹°ë¥¼ ì¶”ê°€ì ìœ¼ë¡œ ë§Œë“¤ë©´ ë˜ê² ë‹¤.

ì¶”ê°€ì ìœ¼ë¡œ, ë‹¤ìŒ ê²Œì‹œë¬¼ì—ì„  í•™ì› ê³µì§€ì‚¬í•­ íŒŒì¼ ì—…ë¡œë“œ ë¶€ë¶„ì„, ì—¬ëŸ¬ íŒŒì¼ì„ í•œêº¼ë²ˆì— ì˜¬ë¦´ ìˆ˜ ìˆë„ë¡ êµ¬í˜„í•´ë³´ë„ë¡ í•˜ê² ë‹¤.

<br>

---

## References

* [SpringBoot & AWS S3 ì—°ë™í•˜ê¸°](https://jojoldu.tistory.com/300)
* [Spring Bootì™€ S3ë¥¼ ì—°ë™í•œ íŒŒì¼ ì—…ë¡œë“œ](https://velog.io/@louie/S3%EB%A5%BC-%EC%97%B0%EB%8F%99%ED%95%9C-%ED%8C%8C%EC%9D%BC-%EC%97%85%EB%A1%9C%EB%93%9C)
* [Springbootë¡œ S3 íŒŒì¼ ì—…ë¡œë“œí•˜ê¸°](https://www.sunny-son.space/spring/Springboot%EB%A1%9C%20S3%20%ED%8C%8C%EC%9D%BC%20%EC%97%85%EB%A1%9C%EB%93%9C/)
* [AWS S3 ë²„í‚· íŒŒì¼ ì—…ë¡œë“œ, ì‚­ì œ, ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ êµ¬í˜„](https://green-joo.tistory.com/2)
* [[Spring] - Spring Boot + AWS S3ë¥¼ ì´ìš©í•˜ì—¬ ì´ë¯¸ì§€ ì¡°íšŒ/ë“±ë¡/ì‚­ì œ ë° accessKey, secretKey, butket ê°’ì„ ì™¸ë¶€ì—ì„œ ê´€ë¦¬í•˜ê¸°](https://kim-jong-hyun.tistory.com/78)