---
title:  "Spring Bootì™€ AWS S3ë¥¼ ì—°ë™í•œ íŒŒì¼ ì—…ë¡œë“œ(4) - MyACADEMY í”„ë¡œì íŠ¸ ì ìš©(ì—¬ëŸ¬ ê°œì˜ íŒŒì¼ ì—…ë¡œë“œí•˜ê¸°)" 
excerpt: "ì—¬ëŸ¬ ê°œ íŒŒì¼ ì²¨ë¶€ í”„ë¡œì íŠ¸ ì ìš©"

categories:
  - Springboot
tags:
  - [Springboot, Project]

date: 2023-01-27
last_modified_at: 2023-01-27

---

[ì´ì „ ê²Œì‹œë¬¼](https://percyfrank.github.io/springboot/S303/)ì—ì„  ì§ì› í”„ë¡œí•„ê³¼ ê´€ë ¨í•˜ì—¬ íŒŒì¼ì´ 1ê°œì”© ì˜¬ë¼ê°€ë„ë¡ êµ¬í˜„í–ˆë‹¤.

í•˜ì§€ë§Œ í•™ì› ê³µì§€ì‚¬í•­ ê²Œì‹œë¬¼ì˜ ê²½ìš°, ê³µì§€ì‚¬í•­ê³¼ ê´€ë ¨ëœ ì²¨ë¶€íŒŒì¼ì€ ì—¬ëŸ¬ ê°œë„ ì˜¬ë¼ê°ˆ ìˆ˜ ìˆë”” ë•Œë¬¸ì— ì—¬ëŸ¬ íŒŒì¼ì„ ì—…ë¡œë“œ í•  ìˆ˜ ìˆë„ë¡ êµ¬í˜„í•´ë³´ê² ë‹¤.

ë‹¤ìš´ë¡œë“œì™€ ì‚­ì œì˜ ê²½ìš°ëŠ” ì´ì „ ê²Œì‹œë¬¼ê³¼ ê°™ê¸° ë•Œë¬¸ì— ë³¸ ê²Œì‹œë¬¼ì—ì„  ì—…ë¡œë“œì— í•œì •í•´ì„œ ì‘ì„±í•´ë³´ë„ë¡ í•˜ê² ë‹¤.

ì‹œì‘í•´ë³´ì.


### 1. Entity
---

ì—”í‹°í‹° ëª…ì„ `AnnouncementFile`ë¡œ ì •í–ˆë‹¤.

ë§ˆì°¬ê°€ì§€ë¡œ, S3 ë²„í‚·ì— ê°™ì€ ì´ë¦„ì˜ íŒŒì¼ì´ ì—…ë¡œë“œë˜ë©´ ë‚˜ì¤‘ì— ë“±ë¡ëœ íŒŒì¼ì´ ë®ì–´ì“°ëŠ” ë¬¸ì œê°€ ìƒê¸´ë‹¤.

ê·¸ë˜ì„œ, S3 ë²„í‚·ì— ì €ì¥ë˜ëŠ” íŒŒì¼ ì´ë¦„ì´ ì¤‘ë³µë˜ì§€ ì•Šë„ë¡ ì €ì¥ëœ íŒŒì¼ì˜ URLì„ ë‚˜íƒ€ë‚´ëŠ” í•„ë“œì¸ `storedFileUrl`ë¥¼ ì¶”ê°€í–ˆë‹¤.

ê·¸ë¦¬ê³  ì—…ë¡œë“œí•œ íŒŒì¼ ì´ë¦„ì„ ë‚˜íƒ€ë‚´ëŠ” `uploadFileName`í•„ë“œë„ ì¶”ê°€í–ˆë‹¤.

ìµœì´ˆ íŒŒì¼ ì—…ë¡œë“œ ì‹œê°„, ë§ˆì§€ë§‰ ìˆ˜ì • ì‹œê°„, ì‚­ì œ ì‹œê°„ì„ ìœ„í•´ `BaseEntity` í´ë˜ìŠ¤ë¥¼ ìƒì†í–ˆë‹¤.

`Announcement` í…Œì´ë¸”ê³¼ëŠ” 1:N ê´€ê³„ë¡œ ë§¤í•‘í•´ì£¼ì—ˆë‹¤.

`Announcement.java`

```java
@Entity
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@AllArgsConstructor
@Builder
@Getter
@Table(name = "announcement_file_tb")
@Where(clause = "deleted_at is NULL")
@SQLDelete(sql = "UPDATE announcement_file_tb SET deleted_at = current_timestamp WHERE announcement_file_id = ?")
public class AnnouncementFile extends BaseEntity {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "announcement_file_id")
    private Long id;

    private String uploadFileName;
    private String storedFileUrl;

    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "announcement_id")
    private Announcement announcement;

    public static AnnouncementFile makeAnnouncementFile(String uploadFileName, String storedFileUrl, Announcement announcement) {
        return AnnouncementFile.builder()
                .uploadFileName(uploadFileName)
                .storedFileUrl(storedFileUrl)
                .announcement(announcement)
                .build();
    }
}
```

### 2. Controller
---

ì¼ë‹¨, í•™ì› ê°œë…ì´ ë“¤ì–´ê°€ê¸° ë•Œë¬¸ì—, academy endpointê°€ ì¶”ê°€ë˜ì—ˆê³ , ì–´ë–¤ ê³µì§€ì‚¬í•­ ë°ì´í„°ì— íŒŒì¼ ì—…ë¡œë“œë¥¼ í• ì§€ì™€ ê´€ë ¨í•´ì„œ announcement endpointë„ ì¶”ê°€ë˜ì—ˆë‹¤.

ğŸš¨ ì œì¼ ì¤‘ìš”í•œ ë¶€ë¶„ì€, `@RequestPart` ì˜ MultipartFileì´ List í˜•íƒœë¡œ ë°”ë€ë‹¤ëŠ” ì ì´ë‹¤. ì—¬ëŸ¬ íŒŒì¼ì„ ì—…ë¡œë“œ í•˜ê¸° ìœ„í•´ List í˜•íƒœë¡œ ìš”ì²­ì„ ì „ë‹¬í•œë‹¤. ğŸš¨

ë˜í•œ, ì´ëŸ¬í•œ ì‘ì—…ì„ ìˆ˜í–‰í•  ê¶Œí•œì„ í™•ì¸í•˜ê¸° ìœ„í•´ Authenticaton ê°ì²´ë„ íŒŒë¼ë¯¸í„°ë¡œ ë„˜ê²¨ì¤€ë‹¤.

`AnnouncementFileController.java`

```java
@Tag(name = "03-2. í•™ì› ê³µì§€ì‚¬í•­", description = "í•™ì› ê³µì§€ì‚¬í•­ ì²¨ë¶€íŒŒì¼ ë“±ë¡,ì‚­ì œ,ë‹¤ìš´ë¡œë“œ")
@RestController
@RequiredArgsConstructor
@Slf4j
@RequestMapping("api/v1/academies")
public class AnnouncementFileController {

    private final AnnouncementFileS3UploadService announcementFileS3UploadService;

    // S3ì— íŒŒì¼ ì—…ë¡œë“œ
    @Operation(summary = "ê³µì§€ì‚¬í•­ ì²¨ë¶€íŒŒì¼ ë“±ë¡", description = "ADMIN,STAFF íšŒì›ë§Œ ë“±ë¡ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤. \n\n AWS S3ì„œë²„ì— ì €ì¥ë©ë‹ˆë‹¤.")
    @PostMapping("/{academyId}/announcements/{announcementId}/files/upload")
    public ResponseEntity<Response<CreateAnnouncementFileResponse>> upload(@PathVariable("academyId") Long academyId,
                                                                           @PathVariable("announcementId") Long announcementId,
                                                                           @RequestPart List<MultipartFile> multipartFile,
                                                                           Authentication authentication) throws IOException {
        String requestAccount = AuthenticationUtil.getAccountFromAuth(authentication);
        CreateAnnouncementFileResponse fileResponse = announcementFileS3UploadService.UploadAnnouncementFile(academyId, announcementId, multipartFile, requestAccount);
        return ResponseEntity.ok().body(Response.success(fileResponse));
    }
}
```

### 3. Service
---

ì—…ë¡œë“œ í•  ë•Œ, ë¹ˆ íŒŒì¼ì„ ì²¨ë¶€í•˜ê±°ë‚˜, íŒŒì¼ì„ ì²¨ë¶€í•´ë„ íŒŒì¼ ì•ˆì— ë‚´ìš©ì´ ì—†ëŠ” ê²½ìš° `FILE_NOT_EXISTS`ì—ëŸ¬ë¥¼ ë°œìƒí•˜ë„ë¡ `validateFileExists()` ë©”ì„œë“œë¡œ ê²€ì¦í•œë‹¤.

ë‹¤ìŒìœ¼ë¡ , í•™ì› ì¡´ì¬ ìœ ë¬´ì™€ ì—…ë¡œë“œ ì§„í–‰í•˜ëŠ” ì§ì›ì´ í•´ë‹¹ í•™ì› ì†Œì†ì¸ì§€, ê·¸ë¦¬ê³  ê·¸ ì§ì›ì´ ì—…ë¡œë“œí•  ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸í•œë‹¤.

íŒŒì¼ ì—…ë¡œë“œ ëŒ€ìƒì¸ ê³µì§€ì‚¬í•­ì˜ ì¡´ì¬ ìœ ë¬´ë„ í™•ì¸í•œë‹¤.


ğŸš¨ ê³µì§€ì‚¬í•­ íŒŒì¼ ì—…ë¡œë“œì™€ ê´€ë ¨ëœ ì½”ë“œë“¤ì„ ì„¤ëª…í•´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì§„í–‰ëœë‹¤.
- ì›ë³¸ íŒŒì¼ ì´ë¦„ê³¼ S3ì— ì €ì¥ë  íŒŒì¼ ì´ë¦„ì„ ë‹´ì„ Listë¥¼ ê°ê° `originalFileNameList` ì™€ `storedFileNameList` ë¡œ ìƒì„±í•œë‹¤.
- ê·¸ë¦¬ê³ , `forEach` ì•ˆì—ì„œ ì§ì› í”„ë¡œí•„ ì—…ë¡œë“œí•  ë•Œ í–ˆë˜ ë°©ì‹ ê·¸ëŒ€ë¡œ ì§„í–‰í•˜ê³ , `forEach` êµ¬ë¬¸ ë§ˆì§€ë§‰ì— ê°ê°ì˜ ì›ë³¸ íŒŒì¼ ì´ë¦„ê³¼ S3ì— ì €ì¥ë  íŒŒì¼ ì´ë¦„ì„ Listì— ì°¨ë¡€ë¡œ ë‹´ì•„ì£¼ê¸°ë§Œ í•˜ë©´ ëœë‹¤.

`AnnouncementFileS3UploadService.java`

```java
@Service
@RequiredArgsConstructor
@Slf4j
@Transactional
public class AnnouncementFileS3UploadService {

    private final AmazonS3Client amazonS3Client;
    private final AcademyRepository academyRepository;
    private final EmployeeRepository employeeRepository;
    private final AnnouncementRepository announcementRepository;
    private final AnnouncementFileRepository announcementFileRepository;

    @Value("${cloud.aws.s3.bucket}")
    private String bucket;

    /**
     * @param academyId         í•™ì› id
     * @param announcementId    íŒŒì¼ ì—…ë¡œë“œ ëŒ€ìƒì¸ ê³µì§€ì‚¬í•­ id
     * @param multipartFile     íŒŒì¼ ì—…ë¡œë“œë¥¼ ìœ„í•œ ê°ì²´
     * @param account           íŒŒì¼ ì—…ë¡œë“œ ì§„í–‰í•˜ëŠ” ì§ì› ê³„ì •
     */
    public CreateAnnouncementFileResponse UploadAnnouncementFile(Long academyId, Long announcementId, List<MultipartFile> multipartFile, String account) {

        // íŒŒì¼ì´ ë“¤ì–´ìˆëŠ”ì§€ í™•ì¸
        validateFileExists(multipartFile);

        // í•™ì› ì¡´ì¬ ìœ ë¬´ í™•ì¸
        Academy academy = validateAcademy(academyId);

        // ì—…ë¡œë“œë¥¼ ì§„í–‰í•˜ëŠ” ì§ì›ì´ í•´ë‹¹ í•™ì› ì†Œì† ì§ì›ì¸ì§€ í™•ì¸
        Employee employee = validateAcademyEmployee(account, academy);

        // ì§ì›ì´ ê³µì§€ì‚¬í•­ íŒŒì¼ ì—…ë¡œë“œí•  ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸ (ê°•ì‚¬ ì™¸ ëª¨ë“  ì§ì› ê°€ëŠ¥)
        if(Employee.isTeacherAuthority(employee)) {
            throw new AppException(ErrorCode.INVALID_PERMISSION);
        }

        // íŒŒì¼ ì—…ë¡œë“œ ëŒ€ìƒì¸ ê³µì§€ì‚¬í•­ ì¡´ì¬ ìœ ë¬´ í™•ì¸
        Announcement announcement = validateAnnouncement(announcementId);

        // ì›ë³¸ íŒŒì¼ ì´ë¦„, S3ì— ì €ì¥ë  íŒŒì¼ ì´ë¦„ ë¦¬ìŠ¤íŠ¸
        List<String> originalFileNameList = new ArrayList<>();
        List<String> storedFileNameList = new ArrayList<>();

        multipartFile.forEach(file -> {
            ObjectMetadata objectMetadata = new ObjectMetadata();
            objectMetadata.setContentType(file.getContentType());
            objectMetadata.setContentLength(file.getSize());

            String originalFilename = file.getOriginalFilename();

            int index;
            // file í˜•ì‹ì´ ì˜ëª»ëœ ê²½ìš°ë¥¼ í™•ì¸
            try {
                index = originalFilename.lastIndexOf(".");
            } catch (StringIndexOutOfBoundsException e) {
                throw new AppException(ErrorCode.WRONG_FILE_FORMAT);
            }

            String ext = originalFilename.substring(index + 1);

            // ì €ì¥ë  íŒŒì¼ ì´ë¦„
            String storedFileName = UUID.randomUUID() + "." + ext;

            // ì €ì¥í•  ë””ë ‰í† ë¦¬ ê²½ë¡œ + íŒŒì¼ ì´ë¦„
            String key = "announcement/" + storedFileName;

            try (InputStream inputStream = file.getInputStream()) {
                amazonS3Client.putObject(new PutObjectRequest(bucket, key, inputStream, objectMetadata)
                        .withCannedAcl(CannedAccessControlList.PublicRead));
            } catch (IOException e) {
                throw new AppException(ErrorCode.FILE_UPLOAD_ERROR);
            }

            String storeFileUrl = amazonS3Client.getUrl(bucket, key).toString();
            AnnouncementFile announcementFile = AnnouncementFile.makeAnnouncementFile(originalFilename, storeFileUrl, announcement);
            announcementFileRepository.save(announcementFile);

            storedFileNameList.add(storedFileName);
            originalFileNameList.add(originalFilename);

        });

        log.info("íŒŒì¼ ë“±ë¡ ì™„ë£Œ");
        return CreateAnnouncementFileResponse.of(originalFileNameList, storedFileNameList);
    }

    private Academy validateAcademy(Long academyId) {
    // í•™ì› ì¡´ì¬ ìœ ë¬´ í™•ì¸
        Academy validatedAcademy = academyRepository.findById(academyId)
            .orElseThrow(() -> new AppException(ErrorCode.ACADEMY_NOT_FOUND));
        return validatedAcademy;
    }

    private Employee validateAcademyEmployee(String account, Academy academy) {
        // í•´ë‹¹ í•™ì› ì†Œì† ì§ì› ë§ëŠ”ì§€ í™•ì¸
        Employee employee = employeeRepository.findByAccountAndAcademy(account, academy)
                .orElseThrow(() -> new AppException(ErrorCode.ACCOUNT_NOT_FOUND));
        return employee;
    }

    private Announcement validateAnnouncement(Long announcementId) {
        Announcement validatedAnnouncement = announcementRepository.findById(announcementId)
                .orElseThrow(() -> new AppException(ErrorCode.ANNOUNCEMENT_NOT_FOUND));
        return validatedAnnouncement;
    }

    // ë¹ˆ íŒŒì¼ì´ ì•„ë‹Œì§€ í™•ì¸, íŒŒì¼ ìì²´ë¥¼ ì²¨ë¶€ì•ˆí•˜ê±°ë‚˜ ì²¨ë¶€í•´ë„ ë‚´ìš©ì´ ë¹„ì–´ìˆìœ¼ë©´ ì—ëŸ¬ ë°œìƒ
    private void validateFileExists(List<MultipartFile> multipartFile) {
        for(MultipartFile mf : multipartFile) {
            if (mf.isEmpty()) {
                throw new AppException(ErrorCode.FILE_NOT_EXISTS);
            }
        }
    }

}
```

### 4. Dto
---

ì—¬ëŸ¬ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê¸° ë•Œë¬¸ì— ì—…ë¡œë“œ Dtoì—ì„œë„ ë°”ë€ ë¶€ë¶„ì´ ìˆë‹¤.

ì›ë³¸ íŒŒì¼ ì´ë¦„ê³¼ S3ì— ì €ì¥ë  íŒŒì¼ ì´ë¦„ í•„ë“œë¥¼ Listë¡œ ìƒì„±í•´ì¤€ë‹¤.

`CreateAnnouncementFileResponse.java`

```java
@NoArgsConstructor
@AllArgsConstructor
@Getter
@Builder
public class CreateAnnouncementFileResponse {

    private List<String> uploadFileName;
    private List<String> S3StoredFileName;
    private String message;

    public static CreateAnnouncementFileResponse of(List<String> original, List<String> stored ) {
        return CreateAnnouncementFileResponse.builder()
                .uploadFileName(original)
                .S3StoredFileName(stored)
                .message("íŒŒì¼ ì²¨ë¶€ ì™„ë£Œ")
                .build();
    }
}
```

### 5. ê²°ê³¼ í™•ì¸
---

![image](https://user-images.githubusercontent.com/85394884/217028380-f9876e96-0513-4549-a307-0b3e2de4db72.png)

![image](https://user-images.githubusercontent.com/85394884/217028519-dc9537ba-7a6a-4b05-858f-d01275936290.png)

![image](https://user-images.githubusercontent.com/85394884/217028625-c86a5ef8-7f03-42e2-87ae-733725ce6969.png)

![image](https://user-images.githubusercontent.com/85394884/217028764-0ec2cbcd-b84b-40a3-84e2-68c9f0ffc2d7.png)


<br>

---

## References

* [Springbootë¥¼ ì´ìš©í•œ AWS S3ì— ì—¬ëŸ¬ íŒŒì¼ ì—…ë¡œë“œ ë° ì‚­ì œ êµ¬í˜„í•˜ê¸°](https://earth-95.tistory.com/117)
* [AWS S3 ë²„í‚· íŒŒì¼ ì—…ë¡œë“œ, ì‚­ì œ, ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ êµ¬í˜„](https://green-joo.tistory.com/2)
* [Springbootë¡œ S3 íŒŒì¼ ì—…ë¡œë“œí•˜ê¸°](https://www.sunny-son.space/spring/Springboot%EB%A1%9C%20S3%20%ED%8C%8C%EC%9D%BC%20%EC%97%85%EB%A1%9C%EB%93%9C./)